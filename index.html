<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI æ½›åŠ›å®¢æ™ºé¸å°èˆªï½œæ±ºç­–çŸ©é™£ (Client-Only)</title>
<style>
  :root{
    --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;
    --grid-border:#2a355c;
  }
  html,body{height:100%;}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .hero{display:flex;gap:20px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
  h1{font-size:28px;margin:4px 0 8px}
  p.muted{color:var(--muted);margin:0}
  .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  input[type=file]{display:none}
  label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
  .kv{display:flex;gap:10px;align-items:center}
  .kv .k{color:#98a8c6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  footer{opacity:.7;margin:24px 0 40px}
  .err{background:#2b0f14;border:1px solid #7a2633;color:#ffd8df;padding:10px 12px;border-radius:10px;margin:10px 0}

  /* ======= çŸ©é™£ï¼ˆå·¦ï¼šæ¨è–¦ï¼›ä¸Šï¼šé—œæ³¨ï¼‰ ======= */
  :root{ --side-w:56px;--head-h:56px; --col-w-L:1fr;--col-w-M:1fr;--col-w-H:1fr; --row-h-H:112px;--row-h-M:112px;--row-h-L:112px; }
  .matrix-wrapper{
    display:grid;
    grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
    grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
    border:1px solid var(--grid-border);border-radius:12px;overflow:hidden;background:#fff;
  }
  .matrix-header,.matrix-side{
    display:flex;align-items:center;justify-content:center;background:#f5f7fa;color:#000;font-weight:700;
    border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);
  }
  .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;background:#fff;}
  .cell h4{margin:0 0 6px;font-size:14px;color:#000}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
  .num{font-size:22px;font-weight:700;color:#000}

  /* é¡è‰²ï¼ˆå…©ä¸»è‰² + æ·¡åº•ï¼‰ */
  .tone-imm { background:#fbc37a; } /* ç«‹å³æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰ */
  .tone-nor { background:#f7a45a; } /* ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰ */
  .tone-warm { background:#fff1c7; } /* å…¶å®ƒæ·¡åº• */

  /* Z åˆè¦æ’é™¤åˆ— */
  .zbar{margin-top:8px;background:#f5f7fa;color:#000;border:1px solid var(--grid-border);border-radius:8px;padding:10px;text-align:center;font-weight:700;cursor:pointer;}

  /* è¡¨æ ¼ï¼ˆsticky è¡¨é ­ï¼‰ */
  .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  .tbl thead th{
    background:#0f1733;color:#a9b9db;position:sticky;top:0;z-index:3;
    box-shadow:0 2px 0 rgba(0,0,0,.25);
  }
  .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left;white-space:nowrap}

  /* è¦å‰‡æª¢æ ¸é¢æ¿ */
  #diagBox .kvline{display:flex;gap:10px;flex-wrap:wrap}
  #diagBox code{background:#0b1639;border:1px solid #243469;padding:2px 6px;border-radius:6px}

  /* ç¯©é¸ chipsï¼ˆé‡æ–°æ’åº + æœ‰é‚Šæ¡†ï¼‰ */
  #filters{display:flex;flex-direction:column;gap:8px}
  .chiprow{display:flex;flex-wrap:wrap;gap:8px}
  #filters .chip{background:#12224b;border:1px solid #2a3b6a;color:#e9efff;border-radius:999px;padding:8px 12px;cursor:pointer}
  #filters .chip:hover{filter:brightness(1.08)}
  #filters .chip.active{outline:2px solid var(--brand)}

  /* æ´¾é€é  */
  .dispatch-wrap{max-width:1280px;margin:24px auto;padding:0 16px}
  .dispatch-card{background:#f3f6ff;border:1px solid #b9c6eb;border-radius:10px;padding:10px;margin-bottom:12px;color:#00123a}
  .dispatch-toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .dispatch-search{flex:1;min-width:260px}
  .dispatch-search input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #c7d2f0;background:#fff}
  .dispatch-table{width:100%;border-collapse:collapse;background:#fff;border:2px solid #9fb3e8}
  .dispatch-table th,.dispatch-table td{border:1px solid #9fb3e8;padding:8px 10px;vertical-align:top;color:#00123a;background:#fff}
  .dispatch-table th{background:#e8eeff;font-weight:700;text-align:center}
  .mini{font-size:12px;color:#33405e}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #c7d2f0;background:#eef3ff;font-weight:600}
  .muted2{color:#62739c}
  .btn.ghost{background:#e9eeff;color:#132a7a;border:1px solid #b9c6eb}
  .hidden{display:none!important;}
</style>
</head>
<body>

<section id="page1" style="display:block">
  <div class="wrap">
    <div class="hero">
      <span class="badge"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3 7 7 .5-5.5 4.8 1.7 7.2L12 17l-6.2 4.5 1.7-7.2L2 9.5 9 9z"/></svg> AI æ½›åŠ›å®¢æ™ºé¸å°èˆª</span>
      <div>
        <h1>é–‹ç™¼æ½›åŠ›åå–®æ±ºç­–çŸ©é™£</h1>
        <p class="muted">ç€è¦½å™¨ç«¯ <b>åªè®€ä½ çš„ JSON è¦å‰‡</b>ï¼ˆä¸åœ¨å‰ç«¯æ‰“åˆ†ï¼‰ï¼Œä¾ R/A åˆ‡é»åˆ†ç¾¤ä¸¦é¡¯ç¤ºã€‚</p>
      </div>
    </div>

    <div id="errBox"></div>
    <!-- è¦å‰‡æª¢æ ¸é¢æ¿ -->
    <div id="diagBox"></div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvRaw">ğŸ“„ åŒ¯å…¥ <b>åŸå§‹è³‡æ–™</b> CSVï¼ˆUTF-8ï¼‰</label>
        <input id="csvRaw" type="file" accept=".csv" />
        <label class="file" for="csvScored">ğŸ“„ åŒ¯å…¥ <b>ETLå¾Œè©•åˆ†</b> CSVï¼ˆå« R/Aï¼‰</label>
        <input id="csvScored" type="file" accept=".csv" />
        <button class="btn" id="btnClear">æ¸…ç©º</button>
        <div class="right kv"><span class="k">æœ‰æ•ˆç­†æ•¸ï¼ˆå·²åˆ†ç¾¤ï¼Œä¸å« Zï¼‰ï¼š</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice"><b>å…©ç¨®åŒ¯å…¥ï¼š</b>â‘  åŸå§‹ï¼ˆç„¡ R/Aï¼‰â†’ é¡¯ç¤º Z èˆ‡ã€Œæœªè©•åˆ†ã€ï¼›â‘¡ ETL å¾Œè©•åˆ†ï¼ˆå« R/Aï¼‰â†’ ä¾ JSON çš„ cut/labels åˆ†ç¾¤ã€‚</div>
      </div>
      <details id="guideDetails" style="margin-top:10px">
        <summary class="btn">CSV æ¬„ä½èªªæ˜èˆ‡ç¯„æœ¬ï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
        <div id="fieldGuide" style="margin-top:10px"></div>
      </details>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">ä¹å®®æ ¼æ±ºç­–æ‘˜è¦</h3><button class="btn right" id="btnDownload">åŒ¯å‡ºçµæœ CSV</button></div>

        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header" id="ahL">é—œæ³¨ä½</div>
          <div class="matrix-header" id="ahM">é—œæ³¨ä¸­</div>
          <div class="matrix-header" id="ahH">é—œæ³¨é«˜</div>

          <div class="matrix-side" id="rhH">æ¨è–¦é«˜</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side" id="rhM">æ¨è–¦ä¸­</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side" id="rhL">æ¨è–¦ä½</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>

        <div class="zbar" id="zBar"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">ç¯©é¸</h3>
        <div id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">å®¢ç¾¤é¡å‹ï¼š</span>
            <select id="selEntity" class="btn">
              <option value="auto">è‡ªå‹•ï¼ˆä¾ CSV/æ¬„ä½æ¨æ–·ï¼‰</option>
              <option value="natural">è‡ªç„¶äºº</option>
              <option value="corp">æ³•äºº</option>
            </select>
          </label>
          <label class="kv"><span class="k">é¡¯ç¤ºç­†æ•¸ï¼š</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>å…¨éƒ¨</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="row" style="margin:16px 0 0 0">
      <button class="btn" id="btnGoDispatch">ğŸ“Œ æ½›åŠ›åå–®æ´¾é€</button>
      <button class="btn ghost" id="btnTableau">ğŸ“Š Tableau</button>
      <span class="muted2 mini">ï¼ˆåƒ… ç«‹å³æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰/ç«‹å³æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰/ç«‹å³æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰/ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰ æ´¾é€ï¼‰</span>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">è¨ˆç®—çµæœ</h3>
      <div style="max-height:360px;overflow:auto;position:relative">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>Â© 2025 AIT3 Demo â€¢ Client-Only â€¢ ç„¡è³‡æ–™ä¸Šå‚³</footer>
  </div>
</section>

<section id="page2" class="hidden">
  <div class="dispatch-wrap">
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="showPage('page1')">â† è¿”å›é¦–é çŸ©é™£</button>
      <div class="right mini muted2">åƒ…é¡¯ç¤ºï¼šç«‹å³æ¥è§¸ï¼ˆç¬¬3ç´š / ç¬¬2ç´š / ç¬¬1ç´šï¼‰èˆ‡ ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰ï¼›RM ç‹€æ…‹èˆ‡è¨»è¨˜å„²å­˜åœ¨ç€è¦½å™¨ <b>localStorage</b></div>
    </div>

    <div class="dispatch-card">
      <div class="dispatch-toolbar">
        <div class="dispatch-search"><input id="dispatchSearch" type="search" placeholder="ğŸ” æœå°‹ å€åŸŸ/åˆ†è¡Œ/RM/å®¢æˆ¶ä»£è™Ÿ/åç¨±..." oninput="renderDispatch()"></div>
        <div class="step"><b>ï¼Šæ‰¹æ¬¡æŒ‡æ´¾/æ”¹æ´¾ï¼š</b> <span class="mini">â‘  é¸å–åå–® â†’ â‘¡ æŒ‡æ´¾ RM</span></div>
        <button class="btn" onclick="batchAssign()">æ‰¹æ¬¡æŒ‡æ´¾/æ”¹æ´¾</button>
        <button class="btn ghost" onclick="clearRMFilters()">æ¸…é™¤ç¯©é¸</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table class="dispatch-table" id="dispatchTbl"></table>
    </div>
  </div>
</section>

<script>
/* -------------------------------------------------
   0) åªè®€å–®ä¸€è¦å‰‡ JSONï¼ˆä¸åœ¨å‰ç«¯æ‰“åˆ†ï¼‰
   ------------------------------------------------- */
const RULES_URL = 'https://raw.githubusercontent.com/pureplume/ait3-rules/refs/heads/main/rules.latest.json';
let RULES = null;
let CURRENT_HEADERS = [];

/* UI å›ºå®šæ¨™é¡Œï¼ˆè‹¥ JSON æœªæä¾› labels.title æ™‚æ¡ç”¨ï¼Œèˆ‡é™„åœ–ä¸€è‡´ï¼‰ */
const UI_TITLES = {
  HL:'ç«‹å³æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰', HM:'ç«‹å³æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰', HH:'ç«‹å³æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  ML:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',  MM:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',  MH:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  LL:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',  LM:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',  LH:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  Z :'åˆè¦æ’é™¤'
};

/* é¡è‰²ï¼šå…©ä¸»è‰² + æ·¡åº• */
const CELL_TONE = {
  HL:'tone-imm', HM:'tone-imm', HH:'tone-imm',
  ML:'tone-warm', MM:'tone-warm', MH:'tone-nor',
  LL:'tone-warm', LM:'tone-warm', LH:'tone-warm'
};

function warn(msg){ document.querySelector('#errBox').innerHTML = '<div class="err">âš ï¸ '+ msg +'</div>'; }
function clearWarn(){ document.querySelector('#errBox').innerHTML = ''; }

async function loadRules(){
  try{
    const res = await fetch(RULES_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw = await res.json();

    // æ‰¾åˆ°åŒ…å« cut / labels / mapping çš„ç¯€é»
    const findNode = obj => {
      if(!obj || typeof obj!=='object') return null;
      const ok = (obj.cut && obj.labels && obj.mapping);
      if(ok) return obj;
      for(const k of Object.keys(obj)){
        const v = obj[k];
        if(v && typeof v==='object'){
          const n = findNode(v);
          if(n) return n;
        }
      }
      return null;
    };
    const node = findNode(raw);
    if(!node) throw new Error('æœªæ‰¾åˆ° cut/labels/mapping ç¯€é»');

    const {cut, labels, mapping} = node;
    if(!cut || !labels || !mapping) throw new Error('JSON ç¼ºå°‘å¿…è¦éµï¼ˆcut/labels/mappingï¼‰');

    RULES = { cut, labels, mapping, edw_order: node.edw_order || {natural:[], corp:[]} };
    clearWarn();
  }catch(e){
    RULES = null;
    warn('è¦å‰‡è¼‰å…¥å¤±æ•—ï¼š' + e.message + 'ã€‚å°‡é€²å…¥éª¨æ¶æ¨¡å¼ï¼ˆä»å¯è¼‰å…¥ CSVã€é¡¯ç¤ºç©ºçŸ©é™£èˆ‡æ¬„ä½èªªæ˜ï¼‰ã€‚');
  }
}

/* -------------------------------------------------
   1) å·¥å…·
   ------------------------------------------------- */
const el = s => document.querySelector(s);
const fmt = n => (typeof n==='number' && Number.isFinite(n))? n.toLocaleString('zh-TW') : (n??'');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const isNum = v => typeof v==='number' && Number.isFinite(v);
const asNum = v => {
  if(v===''||v==null) return NaN;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/[,\s]/g,'')); // å…è¨±åƒåˆ†ä½
};
const normHeader = h => String(h||'').replace(/^\uFEFF/,'').replace(/\r?\n/g,'').trim();
function kNorm(s){
  return String(s||'').toLowerCase()
    .replace(/\uFEFF/g,'').replace(/\r?\n/g,'')
    .replace(/[\s_()ï¼ˆï¼‰\-]/g,'').replace(/[\/\\]/g,'/')
    .trim();
}
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false;
  const push=()=>{row.push(field);field=''};
  const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++];
    if(q){ if(c=='"'){ if(text[i]=='"'){field+='"';i++;}else q=false; } else field+=c; continue; }
    if(c=='"'){ q=true; continue; }
    if(c===','){ push(); continue; }
    if(c===`\n`){ push(); pushRow(); continue; }
    if(c===`\r`){ continue; }
    field+=c;
  }
  push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  const headers=hdr.map(normHeader);
  CURRENT_HEADERS = headers;
  return rows.filter(r=>r.some(x=>x!==''))
             .map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}

/* -------------------------------------------------
   2) åªç”¨ JSON çš„ cut ä¾†åˆ†ç¾¤ï¼ˆä¸æ‰“åˆ†ï¼‰
   ------------------------------------------------- */
function decideCell(R,A){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac;
}
function getTitle(key){
  const fromJson = RULES?.labels?.[key]?.title;
  return fromJson || UI_TITLES[key] || '';
}

function resolveCore(){  // èˆ‡ EDW æ¨™ç±¤å°é½Šï¼šè‹¥ JSON æœªæä¾›å°±ä¾è¡¨é ­æ¨æ–·
  if(RULES?.mapping?.core) return RULES.mapping.core;
  const hset = new Map(CURRENT_HEADERS.map(h=>[kNorm(h),h]));
  const pick = (...cands)=>{ for(const c of cands){ const k=hset.get(kNorm(c)); if(k) return k; } return cands[0]; };
  return {
    id: pick('å®¢æˆ¶ä»£è™Ÿ','å®¢æˆ¶ID','id','å®¢ç·¨'),
    name: pick('å®¢æˆ¶åç¨±','åç¨±','name'),
    entity: pick('è‡ªç„¶äºº/éè‡ªç„¶äºº','å®¢ç¾¤','entity'),
    blacklist: pick('åˆè¦é»‘åå–®','é»‘åå–®','ä¸é…åˆç›¡è·å¯©æŸ¥','ä¸é…åˆ\nç›¡è·å¯©æŸ¥','blacklist')
  };
}
function pickRA(rec){
  const mapScore = RULES?.mapping?.score || {};
  const keyR = mapScore.R || null;
  const keyA = mapScore.A || null;
  const keys = Object.keys(rec);
  const idx = new Map(keys.map(k=>[kNorm(k),k]));
  const tryFind = (given, fallbacks)=>{
    if(given && (given in rec)) return given;
    if(given && idx.has(kNorm(given))) return idx.get(kNorm(given));
    for(const fb of fallbacks){
      if(fb in rec) return fb;
      const k = idx.get(kNorm(fb));
      if(k) return k;
    }
    return null;
  };
  const rKey = tryFind(keyR, ['R','æ¨è–¦R','æ¨è–¦','åŠ æ¬Šæ¨è–¦åˆ†æ•¸','Råˆ†æ•¸']);
  const aKey = tryFind(keyA, ['A','é—œæ³¨A','é—œæ³¨','åŠ æ¬Šé—œæ³¨åˆ†æ•¸','Aåˆ†æ•¸']);
  if(!rKey || !aKey) return null;
  const R = asNum(rec[rKey]), A = asNum(rec[aKey]);
  if(!isNum(R) || !isNum(A)) return null;
  return {R: clamp(R,0,100), A: clamp(A,0,100)};
}
function pickRevenue(rec){
  const keys = Object.keys(rec);
  const idx = new Map(keys.map(k=>[kNorm(k),k]));
  const cand = ['æ¨¡æ“¬è²¢ç»é‡‘é¡','æ¨¡æ“¬è²¢ç»','é ä¼°è²¢ç»','revenue','expected_revenue'];
  for(const c of cand){
    const k = (c in rec)? c : idx.get(kNorm(c));
    if(k){ const v=asNum(rec[k]); if(isNum(v)) return v; }
  }
  return null;
}
function isExcluded(rec){
  const core = resolveCore();
  const v = String(rec[core.blacklist]||'');
  return /^(1|true|y|æ˜¯)$/i.test(v);
}
function inferEntity(rec){
  const core = resolveCore();
  const v = (rec[core.entity]??'').toString();
  const alias = {'è‡ªç„¶äºº':'natural','å€‹äºº':'natural','æ³•äºº':'corp','å…¬å¸':'corp'};
  const e = alias[v] || v.toLowerCase();
  if(e==='natural'||e==='corp') return e;
  const hintKeys = ['å…¬å¸ç‡Ÿæ”¶','æˆç«‹å¹´é™','ç­–ç•¥æ€§ç”¢æ¥­åˆ¥(ETL)','å®¢æˆ¶ç­‰ç´š/æˆä¿¡ç­‰ç´š','å®¢æˆ¶å¾€ä¾†æ¥­å‹™é¡åˆ¥'];
  return hintKeys.some(k=>k in rec)? 'corp':'natural';
}

/* -------------------------------------------------
   3) ä¸»æµç¨‹
   ------------------------------------------------- */
let dataRows=[], enriched=[], viewFilter='ALL';

function process(){
  const forced = el('#selEntity').value;
  const core = resolveCore();
  enriched = dataRows.map(rec=>{
    const entity = (forced==='auto')? inferEntity(rec) : forced;
    const excluded = isExcluded(rec);
    const ra = pickRA(rec);
    const R = ra? ra.R : null;
    const A = ra? ra.A : null;
    const cell = (excluded || !ra)? null : decideCell(R, A);
    const revenue = pickRevenue(rec);
    return { ...rec, entity, excluded, R, A, cell, revenue };
  });
  render();
  if(!el('#page2').classList.contains('hidden')) renderDispatch();
  renderDiagnostics();                           /* è¦å‰‡æª¢æ ¸é¢æ¿ */
}

/* -------------------------------------------------
   4) é¦–é æ¸²æŸ“ + ç¯©é¸ chips
   ------------------------------------------------- */
function applyHeadersFromCuts(){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  el('#ahL').textContent = `é—œæ³¨ä½ (<${c.A.mid})`;
  el('#ahM').textContent = `é—œæ³¨ä¸­ (${c.A.mid}â€“${c.A.hi-1})`;
  el('#ahH').textContent = `é—œæ³¨é«˜ (â‰¥${c.A.hi})`;
  el('#rhH').textContent = `æ¨è–¦é«˜ (â‰¥${c.R.hi})`;
  el('#rhM').textContent = `æ¨è–¦ä¸­ (${c.R.mid}â€“${c.R.hi-1})`;
  el('#rhL').textContent = `æ¨è–¦ä½ (<${c.R.mid})`;
}
function render(){
  applyHeadersFromCuts();

  const byCell = groupBy(enriched.filter(r=>!r.excluded && r.cell), r=>r.cell);
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  for(const key of order){
    const title = getTitle(key);
    const count=(byCell[key]||[]).length;
    const box=el('#cell-'+key);
    if(!box) continue;
    box.className=`cell ${CELL_TONE[key]||'tone-warm'}`;
    box.innerHTML=`<h4>${title}</h4><div class="row"><span class="pill">ç­†æ•¸</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  }

  const zCount = enriched.filter(r=>r.excluded).length;
  const zbar = el('#zBar');
  if(zbar){
    zbar.innerHTML = `Zï½œ${getTitle('Z')}ã€€â€¢ã€€ç­†æ•¸ <span class="num">${fmt(zCount)}</span>`;
    zbar.onclick = ()=>{ viewFilter='Z'; renderTable(); highlightFilter(); };
  }

  renderFilterChips();   // â¬… æ–°ï¼šé‡æ’ã€æœ‰é‚Šæ¡†çš„ chips
  highlightFilter();
  renderTable();
}
function renderFilterChips(){
  const cont = el('#filters');
  cont.innerHTML = '';

  const mk = (text, val) => {
    const b=document.createElement('button'); b.className='chip'; b.textContent=text;
    b.onclick=()=>{viewFilter=val; renderTable(); highlightFilter();};
    return b;
  };

  const rowTop = document.createElement('div'); rowTop.className='chiprow';
  rowTop.appendChild(mk('é¡¯ç¤ºå…¨éƒ¨','ALL'));
  ['HL','HM','HH'].forEach(k=>rowTop.appendChild(mk(getTitle(k),k)));

  const rowMid = document.createElement('div'); rowMid.className='chiprow';
  ['ML','MM','MH'].forEach(k=>rowMid.appendChild(mk(getTitle(k),k)));

  const rowLow = document.createElement('div'); rowLow.className='chiprow';
  ['LL','LM','LH'].forEach(k=>rowLow.appendChild(mk(getTitle(k),k)));
  rowLow.appendChild(mk('åˆè¦æ’é™¤','Z'));

  cont.appendChild(rowTop);
  cont.appendChild(rowMid);
  cont.appendChild(rowLow);
}
function highlightFilter(){
  [...document.querySelectorAll('#filters .chip')].forEach(b=>{
    const val = b.textContent==='é¡¯ç¤ºå…¨éƒ¨'?'ALL': (b.textContent==='åˆè¦æ’é™¤'?'Z':null);
    const mapped = val || Object.entries(UI_TITLES).find(([k,v])=>v===b.textContent)?.[0];
    b.classList.toggle('active', mapped===viewFilter);
  });
}

function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R(æ¨è–¦)','A(é—œæ³¨)','è±¡é™','æ¨¡æ“¬è²¢ç»é‡‘é¡'];

  let rows;
  if(viewFilter==='Z') rows = enriched.filter(r=>r.excluded);
  else if(viewFilter==='ALL') rows = enriched.filter(r=>!r.excluded);
  else rows = enriched.filter(r=>!r.excluded && r.cell===viewFilter);

  const limit=el('#selPage').value==='å…¨éƒ¨'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');

  const core = resolveCore();
  for(const r of rows.slice(0,limit)){
    const title = r.excluded ? getTitle('Z') : (r.cell? getTitle(r.cell) : 'æœªè©•åˆ†');
    const entityTxt = r.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº';
    const vals = [
      r[core.id],
      entityTxt,
      isNum(r.R)? r.R+'%' : '',
      isNum(r.A)? r.A+'%' : '',
      r.excluded ? `Zï½œ${getTitle('Z')}` : title,
      isNum(r.revenue)? fmt(Math.round(r.revenue)) : ''
    ];
    const tr=document.createElement('tr');
    tr.innerHTML = vals.map(v=>`<td>${v??''}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);

  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded && r.cell).length);
}
function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

/* -------------------------------------------------
   5) åŒ¯å…¥ / åŒ¯å‡º
   ------------------------------------------------- */
function toCSV(arr){
  if(!arr.length) return '';
  const core = resolveCore();
  const cols=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R','A','è±¡é™','æ¨¡æ“¬è²¢ç»é‡‘é¡'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded && r.cell).map(r=>[
    r[core.id], r.entity, r.R, r.A, getTitle(r.cell), (isNum(r.revenue)?Math.round(r.revenue):'')
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};
async function handleCsvInput(file){
  if(!file) return;
  const text=await file.text();
  dataRows=csvParse(text);
  headerCheck();
  process();
}
el('#csvRaw').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));
el('#csvScored').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));
el('#btnClear').onclick=()=>{ dataRows=[]; enriched=[]; render(); el('#csvRaw').value=''; el('#csvScored').value=''; };

/* -------------------------------------------------
   6) CSV æ¬„ä½èªªæ˜ï¼ˆèˆ‡ EDW å°é½Šæª¢æŸ¥ï¼‰
   ------------------------------------------------- */
function buildFieldGuide(){
  const box = el('#fieldGuide'); if(!box) return;

  if(!RULES){
    const core = resolveCore();
    box.innerHTML = `
      <div class="notice">
        <div><b>è¦å‰‡å°šæœªæˆåŠŸè¼‰å…¥</b>ï¼ˆé¡¯ç¤ºæœ€å°æ¬„ä½å»ºè­°ï¼‰ã€‚</div>
        <ul>
          <li>å¿…å¡«ï¼š<code>${core.id}</code>ï¼ˆå®¢æˆ¶ä»£è™Ÿï¼‰</li>
          <li>å»ºè­°ï¼š<code>${core.entity}</code>ã€<code>${core.blacklist}</code></li>
          <li>ETL å¾Œè©•åˆ†ï¼š<code>R</code>ã€<code>A</code>ï¼›æ¨¡æ“¬è²¢ç»ï¼š<code>æ¨¡æ“¬è²¢ç»é‡‘é¡</code></li>
        </ul>
      </div>`;
    return;
  }

  const m=RULES.mapping.core || {};
  const ordNat = RULES.edw_order?.natural || [];
  const ordCorp = RULES.edw_order?.corp || [];
  const inCsv = new Set(CURRENT_HEADERS);
  const mk = (type, name, scope, desc, ok)=>`<tr><td>${type}</td><td>${name}${ok?' âœ…':''}</td><td>${scope}</td><td>${desc||''}</td></tr>`;

  let rows = '';
  rows += mk('å¿…å¡«', m.id||'å®¢æˆ¶ä»£è™Ÿ', 'å…±é€š', 'å®¢æˆ¶ä»£è™Ÿ', inCsv.has(m.id||'å®¢æˆ¶ä»£è™Ÿ'));
  rows += mk('å»ºè­°', m.entity||'å®¢ç¾¤', 'å…±é€š', 'å®¢ç¾¤ï¼ˆnatural/corp æˆ– è‡ªç„¶äºº/æ³•äººï¼‰', inCsv.has(m.entity||'å®¢ç¾¤'));
  rows += mk('å…±é€š', m.blacklist||'åˆè¦é»‘åå–®', 'å…±é€š', 'åˆè¦é»‘åå–®(1/0 æˆ– true/false)', inCsv.has(m.blacklist||'åˆè¦é»‘åå–®'));

  if(ordNat.length){ rows += `<tr><td>â€”</td><td colspan="3"><b>è‡ªç„¶äººï¼ˆä¾ EDW é †åºï¼‰</b></td></tr>`;
    ordNat.forEach(f=>rows += mk('è‡ªç„¶äºº', f, 'è‡ªç„¶äºº', '', inCsv.has(f)));
  }
  if(ordCorp.length){ rows += `<tr><td>â€”</td><td colspan="3"><b>æ³•äººï¼ˆä¾ EDW é †åºï¼‰</b></td></tr>`;
    ordCorp.forEach(f=>rows += mk('æ³•äºº', f, 'æ³•äºº', '', inCsv.has(f)));
  }

  const keyR = (RULES?.mapping?.score?.R) || 'R';
  const keyA = (RULES?.mapping?.score?.A) || 'A';
  rows += mk('ETLè©•åˆ†', keyR, 'å…±é€š', 'æ¨è–¦åˆ†æ•¸ï¼ˆ0-100ï¼‰', inCsv.has(keyR));
  rows += mk('ETLè©•åˆ†', keyA, 'å…±é€š', 'é—œæ³¨åˆ†æ•¸ï¼ˆ0-100ï¼‰', inCsv.has(keyA));
  rows += mk('ETLé¸å¡«', 'æ¨¡æ“¬è²¢ç»é‡‘é¡', 'å…±é€š', 'è‹¥æä¾›å°‡é¡¯ç¤ºæ–¼è¡¨æ ¼èˆ‡åŒ¯å‡º', inCsv.has('æ¨¡æ“¬è²¢ç»é‡‘é¡'));

  box.innerHTML = `<table class="tbl">
    <thead><tr><th>å¿…è¦/å°è±¡</th><th>æ¬„ä½åï¼ˆCSV è¡¨é ­ï¼‰</th><th>é©ç”¨</th><th>èªªæ˜</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
}

function headerCheck(){
  const ra = pickRA(dataRows[0]||{});
  if(!ra){ warn('ç›®å‰ CSV æœªæ‰¾åˆ° R/A æ¬„ä½ï¼ˆè«‹åœ¨ JSON çš„ mapping.score æŒ‡å®šï¼Œæˆ– CSV ä½¿ç”¨ã€ŒR / Aã€æˆ–ã€ŒåŠ æ¬Šæ¨è–¦åˆ†æ•¸ / åŠ æ¬Šé—œæ³¨åˆ†æ•¸ã€æ¬„åï¼‰ã€‚'); }
  else { clearWarn(); }
  buildFieldGuide();
  renderDiagnostics();  // æª¢æ ¸é¢æ¿
}

/* -------------------------------------------------
   7) è¦å‰‡æª¢æ ¸é¢æ¿
   ------------------------------------------------- */
function resolveScoreKeys(rec){
  const keys = Object.keys(rec||{});
  const idx = new Map(keys.map(k=>[k.toLowerCase().replace(/[\s_()ï¼ˆï¼‰\-]/g,''),k]));
  const pick = (want, fallbacks=[])=>{
    const norm = s=>s?.toLowerCase().replace(/[\s_()ï¼ˆï¼‰\-]/g,'');
    if(want && rec[want]!=null) return want;
    if(want && idx.has(norm(want))) return idx.get(norm(want));
    for(const f of fallbacks){
      if(rec[f]!=null) return f;
      const k=idx.get(norm(f)); if(k) return k;
    }
    return null;
  };
  const wantR = RULES?.mapping?.score?.R;
  const wantA = RULES?.mapping?.score?.A;
  return {
    R: pick(wantR, ['R','æ¨è–¦R','åŠ æ¬Šæ¨è–¦åˆ†æ•¸','Råˆ†æ•¸']),
    A: pick(wantA, ['A','é—œæ³¨A','åŠ æ¬Šé—œæ³¨åˆ†æ•¸','Aåˆ†æ•¸'])
  };
}
function detectRevenueKey(rec){
  const cands=['æ¨¡æ“¬è²¢ç»é‡‘é¡','æ¨¡æ“¬è²¢ç»','é ä¼°è²¢ç»','revenue','expected_revenue'];
  const keys=Object.keys(rec||{}); const idx=new Map(keys.map(k=>[k.toLowerCase(),k]));
  for(const c of cands){ if(rec[c]!=null) return c; const k=idx.get(c.toLowerCase()); if(k) return k; }
  return null;
}
function renderDiagnostics(){
  const core = resolveCore();
  const sample = dataRows[0]||{};
  const scoreKeys = resolveScoreKeys(sample);
  const revKey = detectRevenueKey(sample) || 'ï¼ˆæœªæ‰¾åˆ°ï¼‰';
  const total = dataRows.length;
  const z = enriched.filter(x=>x.excluded).length;
  const scored = enriched.filter(x=>x.cell).length;
  const unscored = total - z - scored;
  const hit = name => CURRENT_HEADERS.includes(name) ? 'âœ…' : 'âŒ';

  el('#diagBox').innerHTML = `
    <div class="notice">
      <b>è¦å‰‡æª¢æ ¸</b>
      <div class="kvline">JSON è¦å‰‡ï¼š${RULES?'âœ… å·²è¼‰å…¥':'âŒ å¤±æ•—ï¼ˆä½¿ç”¨éª¨æ¶ï¼‰'}</div>
      <div class="kvline">æ ¸å¿ƒæ¬„ä½ï¼š
        å®¢æˆ¶ä»£è™Ÿ <code>${core.id}</code> ${hit(core.id)} ï¼
        å®¢ç¾¤ <code>${core.entity}</code> ${hit(core.entity)} ï¼
        é»‘åå–® <code>${core.blacklist}</code> ${hit(core.blacklist)}
      </div>
      <div class="kvline">ETL åˆ†æ•¸æ¬„ä½ï¼šR = <code>${scoreKeys.R||'æœªæ‰¾åˆ°'}</code>ï¼ŒA = <code>${scoreKeys.A||'æœªæ‰¾åˆ°'}</code></div>
      <div class="kvline">æ¨¡æ“¬è²¢ç»æ¬„ä½ï¼š<code>${revKey}</code></div>
      <div class="kvline">è¦†è“‹ç‡ï¼šå¯åˆ†ç¾¤ <b>${scored}</b> ï¼ ç¸½ç­†æ•¸ <b>${total}</b>ï¼ˆZ = ${z}ï¼Œæœªè©•åˆ† = ${unscored}ï¼‰</div>
    </div>`;
}

/* -------------------------------------------------
   8) Page åˆ‡æ›èˆ‡æ´¾é€
   ------------------------------------------------- */
function showPage(id){
  ['page1','page2'].forEach(pid=>{
    const sec = el('#'+pid);
    if(!sec) return;
    if(pid===id) sec.classList.remove('hidden'); else sec.classList.add('hidden');
  });
}
el('#btnGoDispatch').onclick=()=>{ showPage('page2'); renderDispatch(); };
el('#btnTableau').onclick=()=>alert('æ­¤æŒ‰éˆ•åƒ…ç¤ºæ„ï¼šå¯é€£åˆ°å…§éƒ¨ Tableau å„€è¡¨æ¿ã€‚');
el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();

const DISPATCH_KEY='ait3_dispatch_v2';
function loadDispatchState(){ try{ return JSON.parse(localStorage.getItem(DISPATCH_KEY)||'{}'); }catch(_){ return {}; } }
function saveDispatchState(state){ localStorage.setItem(DISPATCH_KEY, JSON.stringify(state)); }
function getAssignable(){
  const allow = new Set(['HL','HM','HH','MH']); // ç«‹å³æ¥è§¸ 3/2/1 + ä¸€èˆ¬æ¥è§¸ 1
  return enriched.filter(r=>!r.excluded && r.cell && allow.has(r.cell));
}
function renderDispatch(){
  const state = loadDispatchState();
  const q = (el('#dispatchSearch')?.value||'').trim().toLowerCase();
  const core = resolveCore();
  const rows = getAssignable().filter(r=>{
    if(!q) return true;
    const region = String(r['å€åŸŸ']||r['å€åŸŸåç¨±']||'').toLowerCase();
    const branch = String(r['æ­¸å±¬åˆ†è¡Œ']||r['åˆ†è¡Œåç¨±']||'').toLowerCase();
    const id = String(r[core.id]||'').toLowerCase();
    const nm = String(r[core.name]||'').toLowerCase();
    const rm = String(state[id]?.rm||'').toLowerCase();
    return [region,branch,id,nm,rm].some(x=>x.includes(q));
  });

  const tbl = el('#dispatchTbl');
  const head = `
    <thead><tr>
      <th><input type="checkbox" id="chkAll" /></th>
      <th>å®¢æˆ¶ä»£è™Ÿ</th><th>åç¨±</th><th>è±¡é™</th>
      <th>å€åŸŸ</th><th>åˆ†è¡Œ</th>
      <th>R</th><th>A</th><th>æ¨¡æ“¬è²¢ç»</th>
      <th>RM æŒ‡æ´¾</th><th>ç‹€æ…‹</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
    </tr></thead>`;
  const body = document.createElement('tbody');

  for(const r of rows){
    const id = r[core.id];
    const title = getTitle(r.cell);
    const st = state[id]||{};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="${id}"></td>
      <td>${id}</td>
      <td>${r[core.name]||''}</td>
      <td><span class="tag">${title}</span></td>
      <td>${r['å€åŸŸ']||r['å€åŸŸåç¨±']||''}</td>
      <td>${r['æ­¸å±¬åˆ†è¡Œ']||r['åˆ†è¡Œåç¨±']||''}</td>
      <td>${isNum(r.R)?(r.R+'%'):''}</td>
      <td>${isNum(r.A)?(r.A+'%'):''}</td>
      <td>${isNum(r.revenue)?fmt(Math.round(r.revenue)):''}</td>
      <td><input class="rm-input" placeholder="è¼¸å…¥ RM åç¨±" value="${st.rm||''}" data-id="${id}"></td>
      <td>
        <select class="btn mini status" data-id="${id}">
          <option value="">æœªè™•ç†</option>
          <option ${st.status==='è¿½è¹¤'?'selected':''}>è¿½è¹¤</option>
          <option ${st.status==='æˆåŠŸ'?'selected':''}>æˆåŠŸ</option>
          <option ${st.status==='å¤±æ•—'?'selected':''}>å¤±æ•—</option>
        </select>
        <div class="mini muted2">${st.when?('æ›´æ–°ï¼š'+new Date(st.when).toLocaleString('zh-TW')):''}</div>
      </td>
      <td><textarea class="noteedit" data-id="${id}" placeholder="è£œå……èªªæ˜â€¦">${st.note||''}</textarea></td>
      <td><button class="btn mini ghost one-assign" data-id="${id}">æŒ‡æ´¾</button></td>`;
    body.appendChild(tr);
  }
  tbl.innerHTML = head;
  tbl.appendChild(body);

  const chkAll = el('#chkAll');
  if(chkAll) chkAll.onchange = ()=>{ [...tbl.querySelectorAll('.rowchk')].forEach(c=>c.checked=chkAll.checked); };

  tbl.querySelectorAll('.one-assign').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const rowEl = btn.closest('tr');
      const rm = rowEl.querySelector('.rm-input').value.trim();
      const status = rowEl.querySelector('.status').value;
      const note = rowEl.querySelector('.noteedit').value.trim();
      const s = loadDispatchState();
      s[id] = { rm, status, note, when: Date.now() };
      saveDispatchState(s);
      renderDispatch();
    };
  });
  tbl.querySelectorAll('.rm-input').forEach(inp=>{
    inp.oninput = ()=>{ const s=loadDispatchState(); const id=inp.dataset.id; s[id]={...(s[id]||{}), rm:inp.value, when:Date.now()}; saveDispatchState(s); };
  });
  tbl.querySelectorAll('.status').forEach(sel=>{
    sel.onchange = ()=>{ const s=loadDispatchState(); const id=sel.dataset.id; s[id]={...(s[id]||{}), status:sel.value, when:Date.now()}; saveDispatchState(s); renderDispatch(); };
  });
  tbl.querySelectorAll('.noteedit').forEach(ta=>{
    ta.oninput = ()=>{ const s=loadDispatchState(); const id=ta.dataset.id; s[id]={...(s[id]||{}), note:ta.value, when:Date.now()}; saveDispatchState(s); };
  });
}
function clearRMFilters(){ el('#dispatchSearch').value=''; renderDispatch(); }
function batchAssign(){
  const tbl = el('#dispatchTbl');
  const ids = [...tbl.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.id);
  if(!ids.length){ alert('è«‹å…ˆå‹¾é¸åå–®'); return; }
  const rm = prompt('è¼¸å…¥è¦æŒ‡æ´¾/æ”¹æ´¾çš„ RM åç¨±ï¼š','');
  if(rm==null) return;
  const state = loadDispatchState();
  ids.forEach(id=>{
    const tr = tbl.querySelector(`.rowchk[data-id="${id}"]`)?.closest('tr');
    const note = tr?.querySelector('.noteedit')?.value?.trim()||'';
    const status = tr?.querySelector('.status')?.value||'è¿½è¹¤';
    state[id] = { rm, status, note, when: Date.now() };
  });
  saveDispatchState(state);
  renderDispatch();
}

/* -------------------------------------------------
   9) åˆå§‹åŒ–
   ------------------------------------------------- */
document.getElementById('guideDetails').addEventListener('toggle', e=>{
  if(e.target.open) buildFieldGuide();
});
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadRules();      // è®€ JSONï¼ˆå¤±æ•—æ™‚ç”¨éª¨æ¶æ¨¡å¼ï¼‰
  render();               // å…ˆç•«ä¹å®®æ ¼ï¼ˆå³ä½¿ç„¡è³‡æ–™ï¼‰
  buildFieldGuide();      // é¡¯ç¤ºæ¬„ä½å°é½Š
  renderDiagnostics();    // è¦å‰‡æª¢æ ¸
});
</script>
</body>
</html>
