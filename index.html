<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI æ½›åŠ›å®¢æ™ºé¸å°èˆª </title>
<style>
  :root{--bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;--grid-border:#2a355c}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .hero{display:flex;gap:20px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
  h1{font-size:28px;margin:2px 0 6px}
  p.muted{color:var(--muted);margin:0}
  .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  input[type=file]{display:none}
  label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
  .kv{display:flex;gap:10px;align-items:center}
  .kv .k{color:#98a8c6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  .err{background:#2b0f14;border:1px solid #7a2633;color:#ffd8df;padding:10px 12px;border-radius:10px;margin:10px 0}
  footer{opacity:.7;margin:24px 0 40px}
  /* çŸ©é™£ */
  :root{ --side-w:56px;--head-h:56px; --col-w-L:1fr;--col-w-M:1fr;--col-w-H:1fr; --row-h-H:112px;--row-h-M:112px;--row-h-L:112px; }
  .matrix-wrapper{
    display:grid; grid-template-columns: var(--side-w) 1fr 1fr 1fr; grid-template-rows: var(--head-h) 112px 112px 112px;
    border:1px solid var(--grid-border);border-radius:12px;overflow:hidden;background:#fff;
  }
  .matrix-header,.matrix-side{display:flex;align-items:center;justify-content:center;background:#f5f7fa;color:#000;font-weight:700;border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border)}
  .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;background:#fff}
  .cell h4{margin:0 0 6px;font-size:14px;color:#000}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
  .num{font-size:22px;font-weight:700;color:#000}
  .tone-imm{background:#fbc37a} .tone-nor{background:#f7a45a} .tone-warm{background:#fff1c7}
  .zbar{margin-top:8px;background:#f5f7fa;color:#000;border:1px solid var(--grid-border);border-radius:8px;padding:10px;text-align:center;font-weight:700;cursor:pointer}
  /* è¡¨æ ¼ */
  .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  .tbl thead th{background:#0f1733;color:#a9b9db;position:sticky;top:0;z-index:3;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left;white-space:nowrap}
  /* è¨ºæ–· & ç¯©é¸ */
  #diagBox .kvline{display:flex;gap:10px;flex-wrap:wrap}
  #diagBox code{background:#0b1639;border:1px solid #243469;padding:2px 6px;border-radius:6px}
  #filters{display:flex;flex-direction:column;gap:8px}
  .chiprow{display:flex;flex-wrap:wrap;gap:8px}
  #filters .chip{background:#12224b;border:1px solid #2a3b6a;color:#e9efff;border-radius:999px;padding:8px 12px;cursor:pointer}
  #filters .chip:hover{filter:brightness(1.08)}
  #filters .chip.active{outline:2px solid var(--brand)}
</style>

<!-- åŒ¯å‡º Excel + è®€å– XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <span class="badge">å‰ç«¯è¨ˆåˆ†ï½œJSON è¦å‰‡</span>
      <div>
        <h1>é–‹ç™¼æ½›åŠ›åå–®æ±ºç­–çŸ©é™£ï¼ˆHTML ä¾ JSON è¨ˆç®— R/Aï¼‰</h1>
        <p class="muted">ä¸Šå‚³ä»»æ„ CSV/XLSX/JSONï¼›æœ¬é æœƒä¾ JSON è¦å‰‡è‡ªå‹•è¨ˆåˆ†èˆ‡åˆ†ç¾¤ï¼›è‹¥ JSON æ²’æä¾›è¨ˆåˆ†è¦å‰‡ï¼Œå‰‡ fallback è®€ CSV/XLSX çš„ R/Aã€‚</p>
      </div>
    </div>

    <div id="errBox"></div>
    <div id="diagBox" class="panel"></div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvFile">ğŸ“„ åŒ¯å…¥ CSV / XLSX / JSON</label>
        <input id="csvFile" type="file" accept=".csv,.xlsx,.json,application/json,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv" />
        <button class="btn" id="btnClear">æ¸…ç©º</button>
        <div class="right kv">
          <span class="k">çµ±è¨ˆï¼š</span>
          <span>å·²åˆ†ç¾¤ <b id="statScored">0</b></span>
          <span>æœªè©•åˆ† <b id="statUnscored">0</b></span>
          <span>Z <b id="statZ">0</b></span>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice">
          <b>æœ€å°æ¬„ä½ï¼š</b>å®¢æˆ¶ä»£è™Ÿï¼ˆå¿…å¡«ï¼‰ï¼Œå…¶å®ƒæ¬„ä½åç¨±éœ€å’Œ JSON çš„ features.key å°å¾—ä¸Šï¼ˆæˆ–ç”¨ mapping.alias å°æ‡‰ï¼‰ã€‚å·¥ä½œè¡¨å¯ç‚ºã€Œè‡ªç„¶äºº / éè‡ªç„¶äººã€å…©é ã€‚
        </div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row">
          <h3 style="margin:0">ä¹å®®æ ¼æ±ºç­–æ‘˜è¦</h3>
          <button class="btn right" id="btnDownload">åŒ¯å‡ºçµæœï¼ˆå·²åˆ†ç¾¤ï¼‰</button>
          <button class="btn" id="btnXLSX">åŒ¯å‡ºçµæœ Excel</button>
        </div>
        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header" id="ahL">é—œæ³¨ä½</div>
          <div class="matrix-header" id="ahM">é—œæ³¨ä¸­</div>
          <div class="matrix-header" id="ahH">é—œæ³¨é«˜</div>

          <div class="matrix-side" id="rhH">æ¨è–¦é«˜</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side" id="rhM">æ¨è–¦ä¸­</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side" id="rhL">æ¨è–¦ä½</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>
        <div class="zbar" id="zBar"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">ç¯©é¸</h3>
        <div id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">å®¢ç¾¤é¡å‹ï¼š</span>
            <select id="selEntity" class="btn">
              <option value="auto">è‡ªå‹•ï¼ˆä¾æ¬„ä½æ¨æ–·ï¼‰</option>
              <option value="natural">è‡ªç„¶äºº</option>
              <option value="corp">æ³•äºº</option>
            </select>
          </label>
          <label class="kv"><span class="k">é¡¯ç¤ºç­†æ•¸ï¼š</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>å…¨éƒ¨</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">è³‡æ–™åˆ—è¡¨</h3>
      <div style="max-height:360px;overflow:auto;position:relative">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>Â© 2025 AIT3 â€¢ å‰ç«¯è¨ˆåˆ† â€¢ JSON ç‚ºå”¯ä¸€è¦å‰‡ä¾†æºï¼ˆå¯ fallback CSV/XLSX R/Aï¼‰</footer>
  </div>

<script>
/* ===== 0) JSON è¦å‰‡ä¾†æºï¼ˆä¾åºå˜—è©¦ï¼›å¯è¢«æœ¬åœ°ä¸Šå‚³è¦†è“‹ï¼‰ ===== */
const RULES_SOURCES = [
  './rules.latest.json',
  'https://raw.githubusercontent.com/pureplume/ait3-rules/main/rules.latest.json'
];

/* ===== 1) ç‹€æ…‹ & å°å·¥å…· ===== */
let RULES=null, RULES_URL_INUSE=null, CURRENT_HEADERS=[];
let dataRows=[], enriched=[], viewFilter='ALL';

const el=s=>document.querySelector(s);
const fmt=n=> (typeof n==='number'&&Number.isFinite(n))? n.toLocaleString('zh-TW') : (n??'');
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const isNum=v=> typeof v==='number'&&Number.isFinite(v);
const asNum=v=>{
  if(v===''||v==null) return NaN;
  if(typeof v==='number') return v;
  const s=String(v).replace(/[,\s%ï¼…]/g,'');
  return Number(s);
};
const normHeader=h=>String(h||'').replace(/^\uFEFF/,'').replace(/\r?\n/g,'').trim();
const kNorm=s=>String(s||'').toLowerCase().replace(/\uFEFF/g,'').replace(/\r?\n/g,'').replace(/[\s_()ï¼ˆï¼‰\-]/g,'').replace(/[\/\\]/g,'/').trim();
function warn(msg){ el('#errBox').innerHTML = '<div class="err">âš ï¸ '+ msg +'</div>'; }
function clearWarn(){ el('#errBox').innerHTML = ''; }

/* ===== 2) è¼‰å…¥ JSONï¼ˆæ”¯æ´æ–°èˆŠçµæ§‹ï¼›å…è¨±è¨»è§£ï¼›å¯æœ¬åœ°è¦†è“‹ï¼‰ ===== */
async function loadRules(){
  let lastErr='';
  for(const url of RULES_SOURCES){
    try{
      const res=await fetch(url+'?v='+Date.now(),{cache:'no-store'}); if(!res.ok){lastErr='HTTP '+res.status; continue;}
      const text=await res.text();
      const raw=JSON.parse(text.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|\s)\/\/.*$/gm,''));
      RULES = normalizeRules(raw);
      RULES_URL_INUSE=url;
      clearWarn(); return;
    }catch(e){ lastErr=e.message; continue; }
  }
  RULES=null; warn('è¦å‰‡è¼‰å…¥å¤±æ•—ï¼š'+lastErr+'ã€‚ä¾†æºå·²å…¨éƒ¨å˜—è©¦ï¼š\n'+RULES_SOURCES.join('\n'));
}
function loadRulesFromObject(rawObj, srcName='(local JSON)'){
  try{
    RULES = normalizeRules(rawObj);
    RULES_URL_INUSE = srcName;
    clearWarn();
    renderDiagnostics();
    process();
  }catch(e){
    warn('æœ¬åœ° JSON è¦å‰‡è§£æå¤±æ•—ï¼š'+e.message);
  }
}

/* ===== 2.5) v1.3 æ­£è¦åŒ– â†’ compute R/A + labels/cut/mapping ===== */
function normalizeRules(raw){
  // æ‰¾åˆ°ä¸»ç¯€é»
  const node=(function find(o){
    if(!o||typeof o!=='object') return null;
    if((o.cut||o.matrix) && (o.labels||o.matrix?.labels)) return o;
    for(const k of Object.keys(o)){ const n=find(o[k]); if(n) return n; }
    return null;
  })(raw)||raw;

  const cut = node.cut || node.matrix?.cut || {R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const labels = node.labels || node.matrix?.labels || {};
  const mapping = node.mapping || node.edw_common || {};
  const compute = node.compute || null;
  const natural = node.natural || node['natural_person'] || null;
  const corporate = node.corporate || node['corp'] || null;

  const R={ cut, labels, mapping, compute, natural, corporate };
  buildComputeFromV13(R);
  return R;
}

/* ===== 2.6) v1.3 â†’ compute è½‰æ¥å™¨ï¼ˆå®Œæ•´å‹åˆ¥æ”¯æ´ï¼‰ ===== */
function buildComputeFromV13(R){
  const comp = R.compute || {R:{features:[]}, A:{features:[]}};
  if(!comp.R) comp.R = {features:[]};
  if(!comp.A) comp.A = {features:[]};

  const push = (side, f)=>{ if(!f) return; comp[side].features.push(f); };

  const convertBinsByThresholds = (pairs) => {
    // e.g. [[3000000,1.0],[1000000,0.7]...] (éæ¸›é–€æª»)
    if(!Array.isArray(pairs)) return null;
    const out=[];
    for(let i=0;i<pairs.length;i++){
      const th = Number(pairs[i][0]), sc = Number(pairs[i][1]||0);
      const next = (i>0)? Number(pairs[i-1][0]) : Infinity;
      out.push({min:th, max:next, score:sc});
    }
    return out;
  };

  const adaptFeature = (srcFeat, originEntity) => {
    const wR = (typeof srcFeat.weight==='object')? Number(srcFeat.weight.R||0) : Number(srcFeat.weight||0);
    const wA = (typeof srcFeat.weight==='object')? Number(srcFeat.weight.A||0) : 0;
    const sc = srcFeat.score || {};
    const type = String(sc.type||'').toLowerCase();

    const base = {
      key: srcFeat.key,
      label: srcFeat.label || srcFeat.key,
      aliases: Array.isArray(srcFeat.aliases)? srcFeat.aliases.slice(0) : [],
      entity: originEntity
    };

    // é¡åˆ¥å°æ˜ 
    if(type==='categorical_map'){
      const table = sc.mapping || sc.map || {};
      if(wR>0) push('R', {...base, weight:wR, preprocess:'raw', table});
      if(wA>0) push('A', {...base, weight:wA, preprocess:'raw', table});
      return;
    }

    // é‡‘é¡/ä¸€èˆ¬æ•¸å€¼åˆ†ç®±
    if(type==='numeric_bins_amt' || type==='numeric_bins' || type==='numeric_step_ge' || type==='numeric_ranges'){
      const bins = convertBinsByThresholds(sc.bins||sc.steps) || null;
      if(bins){
        if(wR>0) push('R', {...base, weight:wR, bins});
        if(wA>0) push('A', {...base, weight:wA, bins});
      }
      return;
    }

    // æ•¸é‡é–€æª»ï¼ˆbusiness_multiï¼‰ï¼šæ­¤è™•æ¡ã€Œåªç”¨ count æ¬„ä½ã€
    if(type==='business_multi'){
      const steps = sc.steps_by_count || [];
      const pairs = steps.map(([th,score])=>[th,score]);
      const bins = convertBinsByThresholds(pairs);
      // å˜—è©¦ä»¥ count_field æˆ– key ç›´æ¥å°æ‡‰
      const countAliases = []; if (sc.count_field) countAliases.push(sc.count_field);
      if(wR>0) push('R', {...base, weight:wR, bins, aliases:[...(base.aliases||[]), ...countAliases]});
      if(wA>0) push('A', {...base, weight:wA, bins, aliases:[...(base.aliases||[]), ...countAliases]});
      return;
    }

    // é‡‘é¡å·®é¡ï¼ˆä¸Šå‡â†’Rï¼›ä¸‹é™â†’Aï¼‰
    if(type==='numeric_bins_amt_diff'){
      const upPairs = sc.up_bins_twd || sc.up_bins_cnt || [];
      const downPairs = sc.down_bins_twd || sc.down_bins_cnt || [];
      const upBins = convertBinsByThresholds(upPairs);
      const downBins = convertBinsByThresholds(downPairs)?.map(b=>({min:-b.max, max:-b.min, score:b.score})) || null;
      if(wR>0 && upBins) push('R', {...base, weight:wR, bins:upBins});      // x >= é–€æª»
      if(wA>0 && downBins) push('A', {...base, weight:wA, bins:downBins});  // x <= -é–€æª»
      return;
    }

    // ç™¾åˆ†é»å·®ï¼ˆppï¼‰
    if(type==='numeric_bins_pp'){
      const upPairs = sc.bins_up || [];
      const downPairs = sc.bins_down || [];
      const upBins = convertBinsByThresholds(upPairs);
      const downBins = convertBinsByThresholds(downPairs)?.map(b=>({min:-Infinity, max:b.max, score:b.score})) || null;
      if(wR>0 && upBins) push('R', {...base, weight:wR, bins:upBins});
      if(wA>0 && downBins) push('A', {...base, weight:wA, bins:downBins});
      return;
    }

    // ç™¾åˆ†æ¯”å·®ï¼ˆ% æˆ– å°æ•¸ï¼‰
    if(type==='numeric_bins_pct_diff'){
      const upPairs = sc.bins_up_pct || [];
      const downPairs = sc.bins_down_pct || [];
      const upBins = convertBinsByThresholds(upPairs);
      const downBins = convertBinsByThresholds(downPairs)?.map(b=>({min:-Infinity, max:b.max, score:b.score})) || null;
      if(wR>0 && upBins) push('R', {...base, weight:wR, bins:upBins, preprocess:'percent'});
      if(wA>0 && downBins) push('A', {...base, weight:wA, bins:downBins, preprocess:'percent'});
      return;
    }

    // if/score è¦å‰‡
    if(Array.isArray(sc.rules) && sc.rules.length){
      const rule = sc.rules.map(r=>({if:String(r.if||'').trim(), score:Number(r.score)||0}));
      if(wR>0) push('R', {...base, weight:wR, rule});
      if(wA>0) push('A', {...base, weight:wA, rule});
      return;
    }

    // æ’é™¤ï¼ˆZï¼‰
    if(type==='binary_exclude'){
      // è¨˜éŒ„åˆ° mapping.core.blacklist çš„åˆ¥åé›†åˆï¼Œè®“ isExcluded èƒ½æ‰¾åˆ°
      R._binary_exclude = R._binary_exclude || [];
      R._binary_exclude.push({key: srcFeat.key, aliases: (srcFeat.aliases||[]).slice(0)});
      return;
    }

    // å…¶ä»–å‹åˆ¥ï¼šç•¥é
  };

  const nat = Array.isArray(R.natural?.features)? R.natural.features : [];
  const cor = Array.isArray(R.corporate?.features)? R.corporate.features : [];

  nat.forEach(f=>adaptFeature(f,'natural'));
  cor.forEach(f=>adaptFeature(f,'corp'));

  R.compute = comp;
}

/* ===== 3) è§£æ CSV / XLSX / JSON æª”æ¡ˆ ===== */
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false;
  const push=()=>{row.push(field);field=''}; const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++]; if(q){ if(c=='"'){ if(text[i]=='"'){field+='"';i++;}else q=false; } else field+=c; continue; }
    if(c=='"'){ q=true; continue; } if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; } if(c==='\r'){ continue; } field+=c;
  } push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  const headers=hdr.map(normHeader); CURRENT_HEADERS=headers;
  return rows.filter(r=>r.some(x=>x!=='')).map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}
function xlsxParse(arrayBuffer){
  const wb = XLSX.read(arrayBuffer, {type:'array'});
  const sheetNames = wb.SheetNames||[];
  const all=[];
  sheetNames.forEach(sn=>{
    const ws = wb.Sheets[sn];
    if(!ws) return;
    const json = XLSX.utils.sheet_to_json(ws, {raw:true, defval:''}); // ä»¥é¦–åˆ—ç‚ºæ¬„å
    if(!json.length) return;
    const headers = Object.keys(json[0]||{}).map(normHeader);
    CURRENT_HEADERS = headers;
    // è‹¥æœªæä¾›å®¢ç¾¤æ¬„ä½ï¼Œä¾å·¥ä½œè¡¨åæ¨æ–·
    const isNat = /è‡ªç„¶äºº/i.test(sn);
    const isCorp = /éè‡ªç„¶äºº|æ³•äºº/i.test(sn);
    json.forEach(r=>{
      const rec = {...r};
      if(!('è‡ªç„¶äºº/éè‡ªç„¶äºº' in rec) && !('è‡ªç„¶äºº/\néè‡ªç„¶äºº' in rec)){
        if(isNat) rec['è‡ªç„¶äºº/\néè‡ªç„¶äºº']='è‡ªç„¶äºº';
        if(isCorp) rec['è‡ªç„¶äºº/\néè‡ªç„¶äºº']='éè‡ªç„¶äºº';
      }
      all.push(rec);
    });
  });
  return all;
}

/* ===== 4) æ¬„ä½å°æ‡‰ & å¸¸ç”¨æ¬„ä½ï¼ˆè£œï¼šæ›è¡Œ/åˆ¥å/è² é¢åå–®/äºŒå…ƒæ’é™¤ï¼‰ ===== */
function coreMap(){
  if(RULES?.mapping?.core) return RULES.mapping.core;
  const h=new Map(CURRENT_HEADERS.map(x=>[kNorm(x),x]));
  const pick=(...c)=>{ for(const s of c){ const k=h.get(kNorm(s)); if(k) return k; } return c[0]; };
  return {
    id: pick('å®¢æˆ¶ä»£è™Ÿ','å®¢æˆ¶ä»£è™Ÿ\n','å®¢æˆ¶id','id','å®¢ç·¨','CUST_ID'),
    name: pick('å®¢æˆ¶åç¨±','åç¨±','name','CUST_NAME'),
    entity: pick('è‡ªç„¶äºº/éè‡ªç„¶äºº','è‡ªç„¶äºº/\néè‡ªç„¶äºº','å®¢ç¾¤','entity','ENTITY_TYPE'),
    blacklist: pick('åˆè¦é»‘åå–®','é»‘åå–®','ä¸é…åˆç›¡è·å¯©æŸ¥','ä¸é…åˆ\nç›¡è·å¯©æŸ¥','è² é¢åå–®','EXCLUSION_OR_NO_CONSENT','Z_FLAG','BLACKLIST')
  };
}
function isExcluded(rec){
  const cm=coreMap();
  const valMain = String(rec[cm.blacklist]??'').trim();
  const truthy = /^(1|true|y|yes|æ˜¯|Y)$/i.test(valMain);
  if(truthy) return true;
  // è‹¥è¦å‰‡æœ‰ binary_exclude ä¹‹ key/aliasesï¼Œä¹Ÿç´å…¥åˆ¤æ–·
  if(Array.isArray(RULES?._binary_exclude)){
    const idx=new Map(Object.keys(rec).map(k=>[kNorm(k),k]));
    for(const ex of RULES._binary_exclude){
      const candidates=[ex.key, ...(ex.aliases||[])];
      for(const c of candidates){
        const k = idx.get(kNorm(c)); if(!k) continue;
        const v = String(rec[k]??'').trim();
        if(/^(1|true|y|yes|æ˜¯|Y)$/i.test(v)) return true;
      }
    }
  }
  return false;
}
function inferEntity(rec){
  const cm=coreMap(); const raw=(rec[cm.entity] ?? '').toString().trim();
  const alias={ 'è‡ªç„¶äºº':'natural','å€‹äºº':'natural', 'æ³•äºº':'corp','å…¬å¸':'corp','éè‡ªç„¶äºº':'corp' };
  const mapped = alias[raw] || raw.toLowerCase();
  if(mapped==='natural' || mapped==='corp') return mapped;
  const corpHints=[
    'å…¬å¸ç‡Ÿæ”¶','æˆç«‹å¹´é™','ç­–ç•¥æ€§ç”¢æ¥­åˆ¥(ETL)','å®¢æˆ¶ç­‰ç´š/æˆä¿¡ç­‰ç´š','å¾€ä¾†æ¥­å‹™å¤šæ¨£æ€§(å¤§é¡æ•¸)',
    'æˆä¿¡é¡åº¦ä½¿ç”¨ç‡_æœ¬æœŸ','ä¼é‡‘æˆä¿¡_é¡åº¦å‹•ç”¨ç‡','ä¼é‡‘æ”¾æ¬¾_é¡åº¦å‹•ç”¨ç‡'
  ];
  return corpHints.some(k=>k in rec)? 'corp':'natural';
}

/* ===== 5) å‰ç«¯è¨ˆåˆ†å¼•æ“ ===== */
function pickField(rec, key, alias=[]) {
  if(key in rec) return key;
  const idx=new Map(Object.keys(rec).map(k=>[kNorm(k),k]));
  const tryList=[key, ...alias];
  for(const name of tryList){ const k=idx.get(kNorm(name)); if(k) return k; }
  return null;
}
function preprocessVal(v, pre){
  if(pre==='raw') return v;           // é¡åˆ¥ç”¨åŸå­—ä¸²
  let x=asNum(v);
  if(!isNum(x)) return NaN;
  if(pre==='percent'){
    if(String(v).includes('%') || x>1) x = x/100;
  }
  if(pre==='int') x = Math.round(x);
  return x;
}
function evalCond(x, cond){
  if(!isNum(x)) return false;
  const s=String(cond).trim();
  const m1=s.match(/^(>=|<=|>|<|==|=|!=)\s*(-?\d+(\.\d+)?)$/);
  if(m1){
    const op=m1[1], val=Number(m1[2]);
    if(op==='>=') return x>=val;
    if(op==='<=') return x<=val;
    if(op==='>')  return x> val;
    if(op=== '<') return x< val;
    if(op==='=='||op==='=') return x===val;
    if(op==='!=') return x!==val;
  }
  const m2=s.match(/^(between|range)\s+(-?\d+(\.\d+)?)\s*(\.{2}|,|~|to|-)\s*(-?\d+(\.\d+)?)$/i);
  if(m2){ const a=Number(m2[2]), b=Number(m2[5]); return x>=Math.min(a,b) && x<=Math.max(a,b); }
  const m3=s.match(/^\[\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*\]$/);
  if(m3){ const a=Number(m3[1]), b=Number(m3[3]); return x>=a && x<=b; }
  return false;
}
function scoreByRule(x, feature){
  if(Array.isArray(feature.rule)){
    for(const r of feature.rule){ if(r && evalCond(asNum(x), r.if)) return Number(r.score)||0; }
    return 0;
  }
  if(Array.isArray(feature.bins)){
    const xv = asNum(x); if(!isNum(xv)) return 0;
    for(const b of feature.bins){
      const lo=('min' in b)? Number(b.min):-Infinity; const hi=('max' in b)? Number(b.max):Infinity;
      if(xv>=lo && xv<=hi) return Number(b.score)||0;
    }
    return 0;
  }
  if(feature.table && typeof feature.table==='object'){
    const key = String(x ?? '');
    if(Object.prototype.hasOwnProperty.call(feature.table, key)) return Number(feature.table[key])||0;
    return 0;
  }
  return 0;
}
function allowEntity(feat, entity){
  const e = (feat.entity||'both').toLowerCase();
  return e === 'both' || e === (entity||'').toLowerCase();
}
function computeScore(rec, block, entity){
  if(!block || !Array.isArray(block.features) || !block.features.length) return null;
  let sum=0, wsum=0;
  for(const f of block.features){
    if(!allowEntity(f, entity)) continue;
    const field = pickField(rec, f.key, f.alias||f.aliases||[]);
    const raw = field? rec[field] : null;
    const val = preprocessVal(raw, f.preprocess);
    const s = scoreByRule(val, f);   // â†’ 0~1
    const w = Number(f.weight)||0;   // å¯ç‚º R/A ä¸åŒæ¬Šé‡
    if(w<=0) continue;
    sum += s * w;
    wsum += w;
  }
  if(wsum<=0) return null;
  const scaled = 100 * (sum / wsum);
  return clamp(Math.round(scaled), 0, 100);
}

/* fallbackï¼šCSV/XLSX ç›´æ¥æä¾› R/A æ™‚ */
function pickRAfromFileRec(rec){
  const ms=RULES?.mapping?.score||{};
  const keys=Object.keys(rec); const idx=new Map(keys.map(k=>[kNorm(k),k]));
  const tryKey=(given, fb)=>{
    if(given&&rec[given]!=null) return given;
    if(given&&idx.has(kNorm(given))) return idx.get(kNorm(given));
    for(const x of fb){ if(rec[x]!=null) return x; const k=idx.get(kNorm(x)); if(k) return k; }
    return null;
  };
  const rKey=tryKey(ms.R, ['R','æ¨è–¦åˆ†æ•¸','æ¨è–¦R','åŠ æ¬Šæ¨è–¦åˆ†æ•¸','Råˆ†æ•¸','R_SCORE']);
  const aKey=tryKey(ms.A, ['A','é—œæ³¨åˆ†æ•¸','é—œæ³¨A','åŠ æ¬Šé—œæ³¨åˆ†æ•¸','Aåˆ†æ•¸','A_SCORE']);
  if(!rKey||!aKey) return null;
  const R=asNum(rec[rKey]), A=asNum(rec[aKey]); if(!isNum(R)||!isNum(A)) return null;
  return { R:clamp(R,0,100), A:clamp(A,0,100) };
}

/* ===== 6) åˆ†ç¾¤ï¼ˆä¾ cutï¼‰ ===== */
function decideCell(R,A){
  const c=RULES?.cut||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const rc=R>=c.R.hi?'H': R>=c.R.mid?'M':'L';
  const ac=A>=c.A.hi?'H': A>=c.A.mid?'M':'L';
  return rc+ac;
}
const UI_TITLES={HL:'ç«‹å³æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',HM:'ç«‹å³æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',HH:'ç«‹å³æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',ML:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',MM:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',MH:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',LL:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',LM:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',LH:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',Z:'åˆè¦æ’é™¤',U:'æœªè©•åˆ†'};
const CELL_TONE={HL:'tone-imm',HM:'tone-imm',HH:'tone-imm',ML:'tone-warm',MM:'tone-warm',MH:'tone-nor',LL:'tone-warm',LM:'tone-warm',LH:'tone-warm'};
const getTitle=k=> (RULES?.labels?.[k]?.title)||UI_TITLES[k]||'';

/* ===== 7) ä¸»æµç¨‹ ===== */
function process(){
  const forced=el('#selEntity').value, cm=coreMap();
  const hasComputeR = !!(RULES?.compute?.R?.features?.length);
  const hasComputeA = !!(RULES?.compute?.A?.features?.length);

  enriched=dataRows.map(rec=>{
    const entity=(forced==='auto')? inferEntity(rec):forced;
    const excluded=isExcluded(rec);

    let R=null, A=null, reason='';

    if(hasComputeR || hasComputeA){
      R = hasComputeR ? computeScore(rec, RULES.compute.R, entity) : null;
      A = hasComputeA ? computeScore(rec, RULES.compute.A, entity) : null;
      reason = 'compute(JSON)';
    }
    if((R===null || A===null)){
      const ra = pickRAfromFileRec(rec);
      if(ra){ if(R===null) R=ra.R; if(A===null) A=ra.A; reason += (reason?'+':'')+'file(R/A)'; }
    }

    const cell = (excluded || !isNum(R) || !isNum(A)) ? null : decideCell(R,A);
    const state = excluded? 'Z' : (cell? 'SCORED' : 'UNSCORED');
    return {...rec, entity, excluded, R, A, cell, __state:state, __id:rec[cm.id], __reason:reason||'n/a'};
  });

  render();
}

/* ===== 8) UI ===== */
function applyHeadersFromCuts(){
  const c=RULES?.cut||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  el('#ahL').textContent=`é—œæ³¨ä½ (<${c.A.mid})`;
  el('#ahM').textContent=`é—œæ³¨ä¸­ (${c.A.mid}â€“${c.A.hi-1})`;
  el('#ahH').textContent=`é—œæ³¨é«˜ (â‰¥${c.A.hi})`;
  el('#rhH').textContent=`æ¨è–¦é«˜ (â‰¥${c.R.hi})`;
  el('#rhM').textContent=`æ¨è–¦ä¸­ (${c.R.mid}â€“${c.R.hi-1})`;
  el('#rhL').textContent=`æ¨è–¦ä½ (<${c.R.mid})`;
}
function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }
function render(){
  applyHeadersFromCuts();
  const scored=enriched.filter(x=>x.__state==='SCORED');
  const zlist=enriched.filter(x=>x.__state==='Z');
  const unscored=enriched.filter(x=>x.__state==='UNSCORED');

  el('#statScored').textContent=fmt(scored.length);
  el('#statUnscored').textContent=fmt(unscored.length);
  el('#statZ').textContent=fmt(zlist.length);

  const byCell=groupBy(scored, r=>r.cell);
  ['HL','HM','HH','ML','MM','MH','LL','LM','LH'].forEach(key=>{
    const box=el('#cell-'+key); if(!box) return;
    const title=getTitle(key); const count=(byCell[key]||[]).length;
    box.className=`cell ${CELL_TONE[key]||'tone-warm'}`;
    box.innerHTML=`<h4>${title}</h4><div class="row"><span class="pill">ç­†æ•¸</span><span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  });

  const zbar=el('#zBar'); if(zbar){ zbar.innerHTML=`Zï½œ${getTitle('Z')}ã€€â€¢ã€€ç­†æ•¸ <span class="num">${fmt(zlist.length)}</span>`; zbar.onclick=()=>{viewFilter='Z'; renderTable(); highlightFilter();}; }
  renderFilterChips(); highlightFilter(); renderTable(); renderDiagnostics();
}
function renderFilterChips(){
  const cont=el('#filters'); cont.innerHTML='';
  const mk=(text,val)=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=text; b.onclick=()=>{viewFilter=val; renderTable(); highlightFilter();}; return b; };
  const r1=document.createElement('div'); r1.className='chiprow';
  r1.appendChild(mk('é¡¯ç¤ºå…¨éƒ¨','ALL'));
  ['HL','HM','HH'].forEach(k=>r1.appendChild(mk(getTitle(k),k)));
  const r2=document.createElement('div'); r2.className='chiprow';
  ['ML','MM','MH'].forEach(k=>r2.appendChild(mk(getTitle(k),k)));
  const r3=document.createElement('div'); r3.className='chiprow';
  ['LL','LM','LH'].forEach(k=>r3.appendChild(mk(getTitle(k),k)));
  r3.appendChild(mk('æœªè©•åˆ†','UNSCORED')); r3.appendChild(mk('åˆè¦æ’é™¤','Z'));
  cont.appendChild(r1); cont.appendChild(r2); cont.appendChild(r3);
}
function highlightFilter(){
  [...document.querySelectorAll('#filters .chip')].forEach(b=>{
    const mapTitle = Object.fromEntries(Object.entries(UI_TITLES).map(([k,v])=>[v,k])); mapTitle['æœªè©•åˆ†']='UNSCORED'; mapTitle['åˆè¦æ’é™¤']='Z';
    const mapped = (b.textContent==='é¡¯ç¤ºå…¨éƒ¨')?'ALL': (mapTitle[b.textContent]||null);
    b.classList.toggle('active', mapped===viewFilter);
  });
}
function renderTable(){
  const tbl=el('#resultTbl'), cm=coreMap();
  const headers=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R(æ¨è–¦)','A(é—œæ³¨)','ç‹€æ…‹/è±¡é™','ä¾†æº'];
  let rows;
  if(viewFilter==='ALL') rows=enriched;
  else if(viewFilter==='Z') rows=enriched.filter(r=>r.__state==='Z');
  else if(viewFilter==='UNSCORED') rows=enriched.filter(r=>r.__state==='UNSCORED');
  else rows=enriched.filter(r=>r.__state==='SCORED' && r.cell===viewFilter);

  const limit=el('#selPage').value==='å…¨éƒ¨'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');
  rows.slice(0,limit).forEach(r=>{
    const entityTxt=r.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº';
    const status = r.__state==='Z' ? `Zï½œ${getTitle('Z')}` : (r.__state==='UNSCORED'?'æœªè©•åˆ†': getTitle(r.cell));
    const vals=[ r[cm.id], entityTxt, isNum(r.R)?r.R+'%':'', isNum(r.A)?r.A+'%':'', status, r.__reason ];
    const tr=document.createElement('tr'); tr.innerHTML=vals.map(v=>`<td>${v??''}</td>`).join(''); body.appendChild(tr);
  });
  tbl.appendChild(body);
}

/* åŒ¯å‡ºï¼ˆåªåŒ¯å‡ºå·²åˆ†ç¾¤ï¼‰ */
function toCSV(arr){
  if(!arr.length) return '';
  const cm=coreMap(); const cols=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R','A','è±¡é™']; const hdr=cols.join(',');
  const lines=arr.filter(r=>r.__state==='SCORED').map(r=>[
    r[cm.id], r.entity, r.R, r.A, getTitle(r.cell)
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_scored.csv'; a.click();
};

/* è¨ºæ–·é¢æ¿ */
function renderDiagnostics(){
  const cm=coreMap();
  const hasCompR=!!(RULES?.compute?.R?.features?.length);
  const hasCompA=!!(RULES?.compute?.A?.features?.length);
  const mode = (hasCompR||hasCompA) ? 'å‰ç«¯è¨ˆåˆ†ï¼ˆJSON computeï¼‰' : 'fallbackï¼šè®€ æª”æ¡ˆ R/A';
  el('#diagBox').innerHTML = `
    <div class="notice">
      <b>è¦å‰‡æª¢æ ¸</b>
      <div class="kvline">è¦å‰‡ä¾†æºï¼š<code>${RULES_URL_INUSE||'ï¼ˆæœªè¼‰å…¥ï¼‰'}</code></div>
      <div class="kvline">æ¨¡å¼ï¼š<b>${mode}</b></div>
      <div class="kvline">æ ¸å¿ƒæ¬„ä½ï¼šå®¢æˆ¶ä»£è™Ÿ <code>${cm.id}</code>ï¼å®¢ç¾¤ <code>${cm.entity}</code>ï¼é»‘åå–® <code>${cm.blacklist}</code></div>
      <div class="kvline">R featuresï¼š<code>${hasCompR ? RULES.compute.R.features.length : 0}</code>ï¼›A featuresï¼š<code>${hasCompA ? RULES.compute.A.features.length : 0}</code></div>
      <div class="kvline">æç¤ºï¼šæ¬„ä½éœ€èˆ‡ <code>features[].key</code> æˆ–å…¶ <code>aliases</code> å°å¾—ä¸Šï¼›ç¼ºå€¼è¦–ç‚º 0 åˆ†ã€‚</div>
    </div>`;
}

/* ===== 9) äº‹ä»¶ & å•Ÿå‹•ï¼ˆåŒä¸€è¼¸å…¥æ”¯æ´ CSV / XLSX / JSONï¼‰ ===== */
async function handleInputFile(file){
  if(!file) return;
  const name=(file.name||'').toLowerCase();
  try{
    if(name.endsWith('.json')){
      const text = await file.text();
      const raw = JSON.parse(text.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|\s)\/\/.*$/gm,''));
      loadRulesFromObject(raw, file.name);
      return;
    }
    if(name.endsWith('.xlsx')){
      const buf = await file.arrayBuffer();
      dataRows = xlsxParse(buf);
      process(); return;
    }
    // default: csv
    const text=await file.text();
    dataRows=csvParse(text); process();
  }catch(e){
    warn('æª”æ¡ˆè§£æå¤±æ•—ï¼š'+e.message);
  }
}
el('#csvFile').addEventListener('change', e=>handleInputFile(e.target.files?.[0]));
el('#btnClear').onclick=()=>{ dataRows=[]; enriched=[]; render(); el('#csvFile').value=''; };
el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();
document.addEventListener('DOMContentLoaded', async ()=>{ await loadRules(); render(); });

/* ===== åŒ¯å‡º Excelï¼ˆä¿ç•™ä½ åŸæœ¬åŠŸèƒ½ï¼‰ ===== */
(function(){
  function exportDecisionXLSX(){
    const arr = (Array.isArray(enriched) && enriched.length)? enriched : null;
    if(arr){
      let rows = arr.map(rec=>{
        const o = {};
        if ('__id' in rec)        o['å®¢æˆ¶ä»£è™Ÿ']=rec['__id'];
        if ('entity' in rec)      o['å®¢ç¾¤']= (rec.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº');
        if (isNum(rec.R))         o['R_score']=rec.R;
        if (isNum(rec.A))         o['A_score']=rec.A;
        if ('__state' in rec)     o['ç‹€æ…‹']=rec.__state;
        if ('cell' in rec)        o['matrix_key']=rec.cell;
        if ('cell' in rec)        o['matrix_title']=getTitle(rec.cell);
        Object.keys(rec).forEach(k=>{
          if(/^(__|excluded)$/.test(k)) return;
          if(!(k in o)) o[k]=rec[k];
        });
        return o;
      });
      const head=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R_score','A_score','ç‹€æ…‹','matrix_key','matrix_title'];
      rows = rows.map(r=>{
        const out={}; head.forEach(h=>{ if(h in r) out[h]=r[h]; });
        Object.keys(r).forEach(k=>{ if(!(k in out)) out[k]=r[k]; });
        return out;
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      ws['!cols'] = Object.keys(rows[0]||{}).map(()=>({wch:14}));
      XLSX.utils.book_append_sheet(wb, ws, 'decision_result');
      try{
        const meta=[{ rules_loaded: !!(RULES), rules_source: RULES_URL_INUSE||'', exported_at: new Date().toISOString() }];
        const wsMeta = XLSX.utils.json_to_sheet(meta);
        XLSX.utils.book_append_sheet(wb, wsMeta, 'metadata');
      }catch(e){}
      XLSX.writeFile(wb, 'decision_matrix_result.xlsx');
      return;
    }
    const table = document.getElementById('resultTbl');
    if(!table){ alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ï¼ˆè«‹å…ˆè¼‰å…¥ CSV/XLSX ä¸¦å®Œæˆè¨ˆç®—ï¼‰'); return; }
    const wb2 = XLSX.utils.book_new();
    const ws2 = XLSX.utils.table_to_sheet(table, {raw:true});
    XLSX.utils.book_append_sheet(wb2, ws2, 'decision_result');
    XLSX.writeFile(wb2, 'decision_matrix_result.xlsx');
  }
  const btn = document.getElementById('btnXLSX');
  if(btn) btn.addEventListener('click', exportDecisionXLSX);
})();
</script>
</body>
</html>
