<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI 潛力客智選導航｜決策矩陣 (JSON 驅動版)</title>
<style>
  :root{
    --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;--grid-border:#2a355c;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .hero{display:flex;gap:20px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
  h1{font-size:28px;margin:2px 0 6px}
  p.muted{color:var(--muted);margin:0}
  .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  input[type=file]{display:none}
  label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
  .kv{display:flex;gap:10px;align-items:center}
  .kv .k{color:#98a8c6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  .err{background:#2b0f14;border:1px solid #7a2633;color:#ffd8df;padding:10px 12px;border-radius:10px;margin:10px 0}
  footer{opacity:.7;margin:24px 0 40px}

  /* ======= 矩陣（左：推薦；上：關注） ======= */
  :root{ --side-w:56px;--head-h:56px; --col-w-L:1fr;--col-w-M:1fr;--col-w-H:1fr; --row-h-H:112px;--row-h-M:112px;--row-h-L:112px; }
  .matrix-wrapper{
    display:grid;
    grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
    grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
    border:1px solid var(--grid-border);border-radius:12px;overflow:hidden;background:#fff;
  }
  .matrix-header,.matrix-side{
    display:flex;align-items:center;justify-content:center;background:#f5f7fa;color:#000;font-weight:700;
    border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);
  }
  .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;background:#fff;}
  .cell h4{margin:0 0 6px;font-size:14px;color:#000}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
  .num{font-size:22px;font-weight:700;color:#000}
  /* 顏色（兩主色 + 淡底） */
  .tone-imm { background:#fbc37a; } /* 立即接觸（第2/3級） */
  .tone-nor { background:#f7a45a; } /* 一般接觸（第1級） */
  .tone-warm { background:#fff1c7; } /* 其它淡底 */

  /* Z 合規排除列 */
  .zbar{margin-top:8px;background:#f5f7fa;color:#000;border:1px solid var(--grid-border);border-radius:8px;padding:10px;text-align:center;font-weight:700;cursor:pointer;}

  /* 表格（sticky 表頭） */
  .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  .tbl thead th{
    background:#0f1733;color:#a9b9db;position:sticky;top:0;z-index:3;
    box-shadow:0 2px 0 rgba(0,0,0,.25);
  }
  .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left;white-space:nowrap}

  /* 規則檢核面板 */
  #diagBox .kvline{display:flex;gap:10px;flex-wrap:wrap}
  #diagBox code{background:#0b1639;border:1px solid #243469;padding:2px 6px;border-radius:6px}

  /* 篩選 chips */
  #filters{display:flex;flex-direction:column;gap:8px}
  .chiprow{display:flex;flex-wrap:wrap;gap:8px}
  #filters .chip{background:#12224b;border:1px solid #2a3b6a;color:#e9efff;border-radius:999px;padding:8px 12px;cursor:pointer}
  #filters .chip:hover{filter:brightness(1.08)}
  #filters .chip.active{outline:2px solid var(--brand)}

  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <span class="badge">JSON 驅動</span>
      <div>
        <h1>開發潛力名單決策矩陣（以 JSON 為主）</h1>
        <p class="muted">前端不計分，只讀取 <b>CSV 的 R/A</b> 與 <b>JSON 的切點與標籤</b> 來分群。</p>
      </div>
    </div>

    <div id="errBox"></div>
    <div id="diagBox"></div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvFile">📄 匯入 CSV（UTF-8）</label>
        <input id="csvFile" type="file" accept=".csv" />
        <button class="btn" id="btnClear">清空</button>
        <div class="right kv"><span class="k">有效筆數（已分群，不含 Z）：</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice"><b>CSV 最小欄位：</b>客戶代號 / 自然人或法人 / 合規黑名單 / R / A。欄位名稱可用 JSON 的 <code>mapping</code> 調整。</div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">九宮格決策摘要</h3><button class="btn right" id="btnDownload">匯出結果 CSV</button></div>

        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header" id="ahL">關注低</div>
          <div class="matrix-header" id="ahM">關注中</div>
          <div class="matrix-header" id="ahH">關注高</div>

          <div class="matrix-side" id="rhH">推薦高</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side" id="rhM">推薦中</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side" id="rhL">推薦低</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>

        <div class="zbar" id="zBar"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">篩選</h3>
        <div id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">客群類型：</span>
            <select id="selEntity" class="btn">
              <option value="auto">自動（依欄位推斷）</option>
              <option value="natural">自然人</option>
              <option value="corp">法人</option>
            </select>
          </label>
          <label class="kv"><span class="k">顯示筆數：</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>全部</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">計算結果</h3>
      <div style="max-height:360px;overflow:auto;position:relative">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>© 2025 AIT3 Demo • Client-Only • 規則與切點 100% 由 JSON 決定</footer>
  </div>

<script>
/* ========= 1) JSON 規則來源（依序嘗試） =========
 * 第一個是同倉庫檔案，第二個請改成你的 rules repo raw URL 或 GitHub Pages URL
 * 例：'https://raw.githubusercontent.com/<帳號>/ait3-rules/main/rules.latest.json'
 */
const RULES_SOURCES = [
  './rules.latest.json', // 同倉庫備援，可留著
  'https://raw.githubusercontent.com/pureplume/ait3-rules/main/rules.latest.json' // ← 用這個
];

/* ========= 2) 全域狀態 ========= */
let RULES = null;               // { cut, labels, mapping, edw_order }
let RULES_URL_INUSE = null;
let CURRENT_HEADERS = [];
let dataRows = [], enriched = [], viewFilter = 'ALL';

/* ========= 3) 小工具 ========= */
const el = s => document.querySelector(s);
const fmt = n => (typeof n==='number' && Number.isFinite(n))? n.toLocaleString('zh-TW') : (n??'');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const isNum = v => typeof v==='number' && Number.isFinite(v);
const asNum = v => {
  if(v===''||v==null) return NaN;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/[,\s]/g,''));
};
const normHeader = h => String(h||'').replace(/^\uFEFF/,'').replace(/\r?\n/g,'').trim();
function warn(msg){ el('#errBox').innerHTML = '<div class="err">⚠️ '+ msg +'</div>'; }
function clearWarn(){ el('#errBox').innerHTML = ''; }

/* ========= 4) 載入 JSON 規則（可容忍註解、可尋找內層節點） ========= */
async function loadRules(){
  let lastErr = '';
  for (const url of RULES_SOURCES){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) { lastErr = `HTTP ${res.status}`; continue; }
      const text = await res.text();
      // 移除 JS/JSON 註解
      const jsonText = text.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|\s)\/\/.*$/gm,'');
      const raw = JSON.parse(jsonText);
      // 在根或內層尋找 cut/labels/mapping
      function findNode(obj){
        if(!obj || typeof obj!=='object') return null;
        if(obj.cut && obj.labels && obj.mapping) return obj;
        if(obj.matrix && obj.matrix.cut && obj.matrix.labels) {
          // 支援舊版：matrix.cut / matrix.labels；mapping 可能在 edw_common
          const mapping = obj.mapping || obj.edw_common || obj.edw || null;
          return { cut: obj.matrix.cut, labels: obj.matrix.labels, mapping: mapping||{}, edw_order: obj.edw_order||{} };
        }
        for(const k of Object.keys(obj)){
          const v = obj[k];
          if(v && typeof v==='object'){
            const n = findNode(v);
            if(n) return n;
          }
        }
        return null;
      }
      const node = findNode(raw);
      if(!node){ lastErr = '未找到 cut/labels/mapping 節點'; continue; }
      // 規範化
      RULES = {
        cut: node.cut,
        labels: node.labels,
        mapping: node.mapping || {},
        edw_order: node.edw_order || {natural:[], corp:[]}
      };
      RULES_URL_INUSE = url;
      clearWarn();
      return;
    }catch(e){ lastErr = e.message; continue; }
  }
  RULES = null;
  warn('規則載入失敗：'+ lastErr +'。來源已全部嘗試：\n'+ RULES_SOURCES.join('\n'));
}

/* ========= 5) CSV 解析 ========= */
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false;
  const push=()=>{row.push(field);field=''}; const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++];
    if(q){ if(c=='"'){ if(text[i]=='"'){field+='"';i++;}else q=false; } else field+=c; continue; }
    if(c=='"'){ q=true; continue; }
    if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; }
    if(c==='\r'){ continue; }
    field+=c;
  }
  push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  const headers=hdr.map(normHeader);
  CURRENT_HEADERS = headers;
  return rows.filter(r=>r.some(x=>x!=='')).
         map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}

/* ========= 6) 欄位對應與 Z / R / A 讀取 ========= */
function kNorm(s){
  return String(s||'').toLowerCase()
    .replace(/\uFEFF/g,'').replace(/\r?\n/g,'')
    .replace(/[\s_()（）\-]/g,'').replace(/[\/\\]/g,'/').trim();
}
function resolveCore(){
  if(RULES?.mapping?.core) return RULES.mapping.core;
  const hset = new Map(CURRENT_HEADERS.map(h=>[kNorm(h),h]));
  const pick = (...cands)=>{ for(const c of cands){ const k=hset.get(kNorm(c)); if(k) return k; } return cands[0]; };
  return {
    id: pick('客戶代號','客戶id','id','客編'),
    name: pick('客戶名稱','名稱','name'),
    entity: pick('自然人/非自然人','客群','entity'),
    blacklist: pick('合規黑名單','黑名單','不配合盡職審查','不配合\n盡職審查','blacklist')
  };
}
function isExcluded(rec){
  const core = resolveCore();
  const v = String(rec[core.blacklist]||'').trim();
  return /^(1|true|y|是)$/i.test(v);
}
function inferEntity(rec){
  const core = resolveCore();
  const v = (rec[core.entity]??'').toString();
  const alias = {'自然人':'natural','個人':'natural','法人':'corp','公司':'corp'};
  const e = alias[v] || v.toLowerCase();
  if(e==='natural'||e==='corp') return e;
  // 盲推（若沒有欄位）
  const hintKeys = ['公司營收','成立年限','策略性產業別(ETL)','客戶等級/授信等級','客戶往來業務類別'];
  return hintKeys.some(k=>k in rec)? 'corp':'natural';
}
function pickRA(rec){
  const mapScore = RULES?.mapping?.score || {};
  const keyR = mapScore.R || null;
  const keyA = mapScore.A || null;
  const keys = Object.keys(rec);
  const idx = new Map(keys.map(k=>[kNorm(k),k]));
  const tryFind = (given, fallbacks)=>{
    if(given && (given in rec)) return given;
    if(given && idx.has(kNorm(given))) return idx.get(kNorm(given));
    for(const fb of fallbacks){
      if(fb in rec) return fb;
      const k = idx.get(kNorm(fb));
      if(k) return k;
    }
    return null;
  };
  const rKey = tryFind(keyR, ['R','推薦R','加權推薦分數','R分數']);
  const aKey = tryFind(keyA, ['A','關注A','加權關注分數','A分數']);
  if(!rKey || !aKey) return null;
  const R = asNum(rec[rKey]), A = asNum(rec[aKey]);
  if(!isNum(R) || !isNum(A)) return null;
  return {R: clamp(R,0,100), A: clamp(A,0,100)};
}

/* ========= 7) 分群（只用 JSON 切點，不內建計分） ========= */
function decideCell(R,A){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac;
}
const UI_TITLES = {
  HL:'立即接觸（第3級）', HM:'立即接觸（第2級）', HH:'立即接觸（第1級）',
  ML:'一般接觸（第3級）',  MM:'一般接觸（第2級）',  MH:'一般接觸（第1級）',
  LL:'後續接觸（第3級）',  LM:'後續接觸（第2級）',  LH:'後續接觸（第1級）',
  Z :'合規排除'
};
const CELL_TONE = { HL:'tone-imm', HM:'tone-imm', HH:'tone-imm', ML:'tone-warm', MM:'tone-warm', MH:'tone-nor', LL:'tone-warm', LM:'tone-warm', LH:'tone-warm' };
function getTitle(key){ return RULES?.labels?.[key]?.title || UI_TITLES[key] || ''; }

/* ========= 8) 主流程 ========= */
function process(){
  const forced = el('#selEntity').value;
  const core = resolveCore();
  enriched = dataRows.map(rec=>{
    const entity = (forced==='auto')? inferEntity(rec) : forced;
    const excluded = isExcluded(rec);
    const ra = pickRA(rec);
    const R = ra? ra.R : null;
    const A = ra? ra.A : null;
    const cell = (excluded || !ra)? null : decideCell(R, A);
    return { ...rec, entity, excluded, R, A, cell };
  });
  render();
}
function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

/* ========= 9) UI 渲染 ========= */
function applyHeadersFromCuts(){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  el('#ahL').textContent = `關注低 (<${c.A.mid})`;
  el('#ahM').textContent = `關注中 (${c.A.mid}–${c.A.hi-1})`;
  el('#ahH').textContent = `關注高 (≥${c.A.hi})`;
  el('#rhH').textContent = `推薦高 (≥${c.R.hi})`;
  el('#rhM').textContent = `推薦中 (${c.R.mid}–${c.R.hi-1})`;
  el('#rhL').textContent = `推薦低 (<${c.R.mid})`;
}
function render(){
  applyHeadersFromCuts();
  const byCell = groupBy(enriched.filter(r=>!r.excluded && r.cell), r=>r.cell);
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  for(const key of order){
    const title = getTitle(key);
    const count=(byCell[key]||[]).length;
    const box=el('#cell-'+key);
    if(!box) continue;
    box.className=`cell ${CELL_TONE[key]||'tone-warm'}`;
    box.innerHTML=`<h4>${title}</h4><div class="row"><span class="pill">筆數</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  }
  const zCount = enriched.filter(r=>r.excluded).length;
  const zbar = el('#zBar');
  if(zbar){
    zbar.innerHTML = `Z｜${getTitle('Z')}　•　筆數 <span class="num">${fmt(zCount)}</span>`;
    zbar.onclick = ()=>{ viewFilter='Z'; renderTable(); highlightFilter(); };
  }
  renderFilterChips();
  highlightFilter();
  renderTable();
  renderDiagnostics();
}
function renderFilterChips(){
  const cont = el('#filters'); cont.innerHTML = '';
  const mk = (text, val) => { const b=document.createElement('button'); b.className='chip'; b.textContent=text; b.onclick=()=>{viewFilter=val; renderTable(); highlightFilter();}; return b; };
  const rowTop = document.createElement('div'); rowTop.className='chiprow';
  rowTop.appendChild(mk('顯示全部','ALL'));
  ['HL','HM','HH'].forEach(k=>rowTop.appendChild(mk(getTitle(k),k)));
  const rowMid = document.createElement('div'); rowMid.className='chiprow';
  ['ML','MM','MH'].forEach(k=>rowMid.appendChild(mk(getTitle(k),k)));
  const rowLow = document.createElement('div'); rowLow.className='chiprow';
  ['LL','LM','LH'].forEach(k=>rowLow.appendChild(mk(getTitle(k),k)));
  rowLow.appendChild(mk('合規排除','Z'));
  cont.appendChild(rowTop); cont.appendChild(rowMid); cont.appendChild(rowLow);
}
function highlightFilter(){
  [...document.querySelectorAll('#filters .chip')].forEach(b=>{
    const val = b.textContent==='顯示全部'?'ALL': (b.textContent==='合規排除'?'Z':null);
    const mapped = val || Object.entries(UI_TITLES).find(([k,v])=>v===b.textContent)?.[0];
    b.classList.toggle('active', mapped===viewFilter);
  });
}
function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['客戶代號','客群','R(推薦)','A(關注)','象限'];
  let rows;
  if(viewFilter==='Z') rows = enriched.filter(r=>r.excluded);
  else if(viewFilter==='ALL') rows = enriched.filter(r=>!r.excluded);
  else rows = enriched.filter(r=>!r.excluded && r.cell===viewFilter);
  const limit=el('#selPage').value==='全部'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');
  const core = resolveCore();
  for(const r of rows.slice(0,limit)){
    const title = r.excluded ? getTitle('Z') : (r.cell? getTitle(r.cell) : '未評分');
    const entityTxt = r.entity==='corp'?'法人':'自然人';
    const vals = [
      r[core.id],
      entityTxt,
      isNum(r.R)? r.R+'%' : '',
      isNum(r.A)? r.A+'%' : '',
      r.excluded ? `Z｜${getTitle('Z')}` : title
    ];
    const tr=document.createElement('tr');
    tr.innerHTML = vals.map(v=>`<td>${v??''}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);
  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded && r.cell).length);
}

/* ========= 10) 規則檢核資訊 ========= */
function buildFieldGuide(){
  const box = el('#diagBox'); if(!box) return;
  const core = resolveCore();
  const sample = dataRows[0]||{};
  const find = (want, ...alts)=>{
    const keys = Object.keys(sample);
    const idx = new Map(keys.map(k=>[kNorm(k),k]));
    if(want && (want in sample)) return want;
    if(want && idx.has(kNorm(want))) return idx.get(kNorm(want));
    for(const a of alts){ if(a in sample) return a; const k=idx.get(kNorm(a)); if(k) return k; }
    return '未找到';
  };
  const rKey = find(RULES?.mapping?.score?.R,'R','推薦R','加權推薦分數','R分數');
  const aKey = find(RULES?.mapping?.score?.A,'A','關注A','加權關注分數','A分數');
  const total = dataRows.length;
  const z = enriched.filter(x=>x.excluded).length;
  const scored = enriched.filter(x=>x.cell).length;
  const unscored = total - z - scored;
  const hit = name => CURRENT_HEADERS.includes(name) ? '✅' : '❌';
  box.innerHTML = `
    <div class="notice">
      <b>規則檢核</b>
      <div class="kvline">JSON 規則：${RULES?'✅ 已載入':'❌ 失敗（使用骨架）'}</div>
      <div class="kvline">規則來源：<code>${RULES_URL_INUSE || '（骨架模式）'}</code></div>
      <div class="kvline">核心欄位：
        客戶代號 <code>${core.id}</code> ${hit(core.id)} ／
        客群 <code>${core.entity}</code> ${hit(core.entity)} ／
        黑名單 <code>${core.blacklist}</code> ${hit(core.blacklist)}
      </div>
      <div class="kvline">R 欄位：<code>${rKey}</code>；A 欄位：<code>${aKey}</code></div>
      <div class="kvline">覆蓋率：可分群 <b>${scored}</b> ／ 總筆數 <b>${total}</b>（Z = ${z}，未評分 = ${unscored}）</div>
    </div>`;
}

/* ========= 11) 匯出 ========= */
function toCSV(arr){
  if(!arr.length) return '';
  const core = resolveCore();
  const cols=['客戶代號','客群','R','A','象限'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded && r.cell).map(r=>[
    r[core.id], r.entity, r.R, r.A, getTitle(r.cell)
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};

/* ========= 12) 事件 ========= */
async function handleCsvInput(file){
  if(!file) return;
  const text=await file.text();
  dataRows=csvParse(text);
  process();
  buildFieldGuide();
  if(!pickRA(dataRows[0]||{})){ warn('CSV 未找到 R/A 欄位（請在 JSON 的 mapping.score 指定，或 CSV 使用「R / A」或「加權推薦分數 / 加權關注分數」欄名）。'); }
  else { clearWarn(); }
}
el('#csvFile').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));
el('#btnClear').onclick=()=>{ dataRows=[]; enriched=[]; render(); el('#csvFile').value=''; };
el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();

/* ========= 13) 啟動 ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadRules();
  render();         // 沒資料時也會畫出矩陣與標題
  buildFieldGuide();
});
</script>
</body>
</html>
