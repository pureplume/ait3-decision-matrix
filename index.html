<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI æ½›åŠ›å®¢æ™ºé¸å°èˆªï½œæ±ºç­–çŸ©é™£ (Client-Only)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;
      --grid-border:#2a355c;
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .hero{display:flex;gap:20px;align-items:center}
    .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
    h1{font-size:28px;margin:4px 0 8px}
    p.muted{color:var(--muted);margin:0}
    .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    input[type=file]{display:none}
    label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
    .kv{display:flex;gap:10px;align-items:center}
    .kv .k{color:#98a8c6}

    /* ======= 4Ã—4 çŸ©é™£ç‰ˆé¢ï¼ˆå·¦åˆ—ï¼šæ¨è–¦ï¼›ä¸Šåˆ—ï¼šé—œæ³¨ï¼‰ ======= */
    :root{
      /* å¯è‡ªè¡Œèª¿æ•´ï¼šå·¦å´æ¨è–¦æ¬„å¯¬ã€ä¸Šæ–¹æ¨™é ­åˆ—é«˜ */
      --side-w: 56px;
      --head-h: 56px;

      /* å¯è‡ªè¡Œèª¿æ•´ï¼šæ¯ä¸€æ¬„å¯¬ï¼ˆé—œæ³¨ ä½/ä¸­/é«˜ï¼‰*/
      --col-w-L: 1fr;
      --col-w-M: 1fr;
      --col-w-H: 1fr;

      /* å¯è‡ªè¡Œèª¿æ•´ï¼šæ¯ä¸€åˆ—é«˜ï¼ˆæ¨è–¦ é«˜/ä¸­/ä½ï¼‰*/
      --row-h-H: 112px;
      --row-h-M: 112px;
      --row-h-L: 112px;

      --grid-border:#2a355c;
    }

    .matrix-wrapper{
      display:grid;
      grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
      grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
      border:1px solid var(--grid-border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }

    /* æ¨™é ­æ ¼ï¼ˆä¸Šæ’ä¸‰æ ¼ + å·¦ä¸Šç©ºç™½ï¼‰*/
    .matrix-header{
      display:flex;align-items:center;justify-content:center;
      background:#f5f7fa;color:#000;font-weight:700;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
    }
    /* å·¦å´æ¨è–¦æ¨™ç±¤ï¼ˆæ¯åˆ—ç¬¬ä¸€æ ¼ï¼‰*/
    .matrix-side{
      display:flex;align-items:center;justify-content:center;
      background:#f5f7fa;color:#000;font-weight:700;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
    }

    /* å…§éƒ¨ä¹å®®æ ¼ cell */
    .cell{
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
      padding:10px;position:relative;background:#fff;
    }
    .cell h4{margin:0 0 6px;font-size:14px;color:#000}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
    .num{font-size:22px;font-weight:700;color:#000}

    /* === ä¹å®®æ ¼é¡è‰²ï¼ˆä¾ä½ æä¾›ï¼‰=== */
    .cell-A1 { background:#f57c00; } /* é«˜æ½›åŠ›é–‹ç™¼ï¼ˆæ©˜ï¼‰ */
    .cell-A2 { background:#fbc02d; } /* é«˜æ½›åŠ›ç›£æ¸¬ï¼ˆé»ƒï¼‰ */
    .cell-B1 { background:#f57c00; } /* é«˜æ½›åŠ›è­¦ç¤ºï¼ˆæ©˜ï¼‰ */
    .cell-C1 { background:#fff176; } /* ä¸­æ½›åŠ›ç¶­è­·ï¼ˆæ·¡é»ƒï¼‰ */
    .cell-C2 { background:#fff176; } /* ä¸­æ½›åŠ›ç›£æ¸¬ï¼ˆæ·¡é»ƒï¼‰ */
    .cell-B2 { background:#fbc02d; } /* ä¸­æ½›åŠ›è­¦ç¤ºï¼ˆé»ƒï¼‰ */
    .cell-C3 { background:#fff176; } /* ä½æ½›åŠ›ç¶­è­·ï¼ˆæ·¡é»ƒï¼‰ */
    .cell-C4 { background:#fff176; } /* ä½æ½›åŠ›ç›£æ¸¬ï¼ˆæ·¡é»ƒï¼‰ */
    .cell-Z  { background:#ffffff; } /* åˆè¦æ’é™¤ï¼ˆç™½åº•ï¼‰ */

    /* è¡¨æ ¼/å…¶ä»– */
    .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
    .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left}
    .tbl th{background:#0f1733;color:#a9b9db;position:sticky;top:0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0f1430;padding:10px;border-radius:8px;border:1px solid #1c2550}
    footer{opacity:.7;margin:24px 0 40px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <span class="badge"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3 7 7 .5-5.5 4.8 1.7 7.2L12 17l-6.2 4.5 1.7-7.2L2 9.5 9 9z"/></svg> AI æ½›åŠ›å®¢æ™ºé¸å°èˆª</span>
      <div>
        <h1>é–‹ç™¼æ½›åŠ›åå–®æ±ºç­–çŸ©é™£</h1>
        <p class="muted">å°‡åå–®ä»¥ <b>CSV</b> åŒ¯å…¥ï¼Œæ–¼ç€è¦½å™¨å…§è¨ˆç®— <b>æ¨è–¦R / é—œæ³¨A</b> åˆ†æ•¸</p>
      </div>
    </div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvInput">ğŸ“„ åŒ¯å…¥ CSVï¼ˆUTF-8ï¼‰</label>
        <input id="csvInput" type="file" accept=".csv" />
        <button class="btn" id="btnDemo">è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
        <button class="btn" id="btnClear">æ¸…ç©º</button>
        <div class="right kv"><span class="k">è³‡æ–™ç­†æ•¸ï¼š</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice">æ¬„ä½éœ€æ±‚è«‹åƒè¦‹ä¸‹æ–¹ <b>CSV æ¬„ä½èªªæ˜</b>ï¼ˆé †åºä¸æ‹˜ï¼Œä½†è¡¨é ­åç¨±éœ€å°æ‡‰ï¼›ä¸é©ç”¨æ¬„ä½ç•™ç©ºï¼‰ã€‚</div>
      </div>

      <!-- âœ… æ–°å¢ï¼šCSV æ¬„ä½èªªæ˜ï¼ˆè‡ªå‹•ä¾ CFG.map ç”Ÿæˆï¼‰ -->
      <details style="margin-top:10px">
        <summary class="btn">CSV æ¬„ä½èªªæ˜èˆ‡ç¯„æœ¬ï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
        <div id="fieldGuide"></div>
        <div style="margin-top:10px">
          <div class="kv"><span class="k">å®Œæ•´è¡¨é ­ç¯„æœ¬ï¼ˆé †åºå¯è‡ªç”±èª¿æ•´ï¼‰ï¼š</span></div>
          <pre class="code" id="csvHeaderSample"></pre>
        </div>
      </details>
      <!-- /CSV æ¬„ä½èªªæ˜ -->
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">ä¹å®®æ ¼æ±ºç­–æ‘˜è¦</h3><button class="btn right" id="btnDownload">åŒ¯å‡ºçµæœ CSV</button></div>

        <!-- 4Ã—4 ç‰ˆé¢ï¼šç¬¬ä¸€åˆ—æ˜¯é—œæ³¨æ¨™é ­ã€ç¬¬ä¸€æ¬„æ˜¯æ¨è–¦æ¨™é ­ -->
        <div class="matrix-wrapper">
          <!-- ç¬¬1è¡Œï¼šå·¦ä¸Šè§’ç©ºç™½ + é—œæ³¨æ¨™é ­ -->
          <div class="matrix-header"></div>
          <div class="matrix-header">é—œæ³¨ä½</div>
          <div class="matrix-header">é—œæ³¨ä¸­</div>
          <div class="matrix-header">é—œæ³¨é«˜</div>

          <!-- ç¬¬2è¡Œï¼šæ¨è–¦é«˜ -->
          <div class="matrix-side">æ¨è–¦é«˜</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <!-- ç¬¬3è¡Œï¼šæ¨è–¦ä¸­ -->
          <div class="matrix-side">æ¨è–¦ä¸­</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <!-- ç¬¬4è¡Œï¼šæ¨è–¦ä½ -->
          <div class="matrix-side">æ¨è–¦ä½</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">ç¯©é¸</h3>
        <div class="chips" id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">å®¢ç¾¤é¡å‹ï¼š</span>
            <select id="selEntity" class="btn">
              <option value="auto">è‡ªå‹•ï¼ˆä¾æ˜¯å¦æœ‰å…¬å¸æ¬„ä½æ¨æ–·ï¼‰</option>
              <option value="natural">è‡ªç„¶äºº</option>
              <option value="corp">æ³•äºº</option>
            </select>
          </label>
          <label class="kv"><span class="k">é¡¯ç¤ºç­†æ•¸ï¼š</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>å…¨éƒ¨</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">è¨ˆç®—çµæœ</h3>
      <div style="max-height:360px;overflow:auto">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>Â© 2025 AIT3 Demo â€¢ Client-Only â€¢ ç„¡è³‡æ–™ä¸Šå‚³</footer>
  </div>

<script>
// === 1) è¨­å®šï¼ˆå¯æ”¹ï¼‰ ==========================================================
const CFG = {
  // ä¹å®®æ ¼åˆ‡é»ï¼ˆ>=hi ç‚ºé«˜ï¼Œ>=mid ç‚ºä¸­ï¼Œå¦å‰‡ä½ï¼‰
  cut: { R: {hi: 70, mid: 40}, A: {hi: 70, mid: 40} },

  // ä¹å®®æ ¼æ¨™ç±¤ï¼ˆä¾ RÃ—A å€é–“ï¼‰
  labels: {
    HL: { code: 'A1', title: 'é«˜æ½›åŠ›é–‹ç™¼', tone:'ok'   }, // æ¨è–¦é«˜ Ã— é—œæ³¨ä½
    HM: { code: 'A2', title: 'é«˜æ½›åŠ›ç›£æ¸¬', tone:'warn' }, // æ¨è–¦é«˜ Ã— é—œæ³¨ä¸­
    HH: { code: 'B1', title: 'é«˜æ½›åŠ›è­¦ç¤º', tone:'risk' }, // æ¨è–¦é«˜ Ã— é—œæ³¨é«˜
    ML: { code: 'C1', title: 'ä¸­æ½›åŠ›ç¶­è­·', tone:'ok'   }, // æ¨è–¦ä¸­ Ã— é—œæ³¨ä½
    MM: { code: 'C2', title: 'ä¸­æ½›åŠ›ç›£æ¸¬', tone:'warn' }, // æ¨è–¦ä¸­ Ã— é—œæ³¨ä¸­
    MH: { code: 'B2', title: 'ä¸­æ½›åŠ›è­¦ç¤º', tone:'risk' }, // æ¨è–¦ä¸­ Ã— é—œæ³¨é«˜
    LL: { code: 'C3', title: 'ä½æ½›åŠ›ç¶­è­·', tone:'ok'   }, // æ¨è–¦ä½ Ã— é—œæ³¨ä½
    LM: { code: 'C4', title: 'ä½æ½›åŠ›ç›£æ¸¬', tone:'warn' }, // æ¨è–¦ä½ Ã— é—œæ³¨ä¸­
    LH: { code: 'Z',  title: 'åˆè¦æ’é™¤',   tone:'risk' }  // æ¨è–¦ä½ Ã— é—œæ³¨é«˜
  },

  // === æ¬„ä½å°æ‡‰ï¼ˆå…¬å¸ CSV æ¨™é¡Œ â†’ å…§éƒ¨ä»£ç¢¼ï¼‰====================================
  map: {
    id: 'id',                // [å…±é€š] å®¢æˆ¶IDï¼ˆå¿…å¡«ï¼‰
    name: 'name',            // [å…±é€š] å®¢æˆ¶åç¨±ï¼ˆå¿…å¡«ï¼‰
    entity: 'entity',        // [å…±é€š] å®¢ç¾¤é¡å‹ï¼ˆnatural/corpï¼‰ï¼ˆå¿…å¡«ï¼‰
    blacklist: 'compliance_blacklist', // [å…±é€š] åˆè¦é»‘åå–® 1/0 æˆ– true/false

    // === è‡ªç„¶äººæˆ¶ï¼šå®¢æˆ¶èƒŒæ™¯(éœæ…‹) ===
    aum: 'aum_12m',          // æŠ•è³‡AUMï¼ˆè¿‘12æœˆï¼‰
    salary: 'salary',        // å¹´è–ª
    degree: 'degree',        // å­¸æ­·ï¼š1~4
    vip: 'vip_tier',         // VIP ç­‰ç´šï¼šä¸€èˆ¬/VIP/VVIP/é«˜è³‡ç”¢
    prodKinds: 'prod_kinds', // å››ç·šæ»²é€ï¼ˆç”¢å“å¤§é¡æ•¸ï¼‰
    // å¯é¸æ“´å……ï¼ˆB æ¨¡çµ„è‹¥æœ‰ï¼‰
    nat_age: 'age',               // å¹´é½¡ï¼ˆå¯é¸ï¼‰
    nat_job: 'occupation',        // è·æ¥­ï¼ˆå¯é¸ï¼‰
    nat_segment: 'crm_segment',   // CRMåˆ†ç¾¤ï¼ˆå¯é¸ï¼‰

    // === è‡ªç„¶äººæˆ¶ï¼šè¡Œç‚ºç›£æ¸¬(å‹•æ…‹) ===
    depNow: 'avg_dep_3m',       // æœ€è¿‘ä¸‰æœˆå¹³å‡å­˜æ¬¾
    depPrev: 'avg_dep_prev3m',  // å‰ä¸‰æœˆå¹³å‡å­˜æ¬¾
    lastDays: 'last_txn_days',  // æœ€è¿‘äº¤æ˜“è·ä»Šå¤©æ•¸
    nat_txn_amt_3m: 'txn_amt_3m',          // äº¤æ˜“é‡‘é¡(è¿‘3æœˆ)
    nat_txn_amt_prev3m: 'txn_amt_prev3m',  // äº¤æ˜“é‡‘é¡(å‰3æœˆ)
    nat_txn_cnt_3m: 'txn_cnt_3m',          // äº¤æ˜“ç­†æ•¸(è¿‘3æœˆ)
    nat_txn_cnt_prev3m: 'txn_cnt_prev3m',  // äº¤æ˜“ç­†æ•¸(å‰3æœˆ)
    nat_ebank_login_3m: 'ebank_login_3m',  // ç¶²éŠ€/è¡ŒéŠ€ç™»å…¥(è¿‘3æœˆ)
    nat_card_active_3m: 'card_active_3m',  // ä¿¡ç”¨å¡æ´»èº(è¿‘3æœˆ)
    loan_util: 'loan_util',                // è²¸æ¬¾å‹•ç”¨ç‡(0~1)

    // === æ³•äººæˆ¶ï¼šå®¢æˆ¶èƒŒæ™¯(éœæ…‹) ===
    capital: 'capital',                // è³‡æœ¬é¡
    years: 'company_age_years',        // æˆç«‹å¹´æ•¸
    rating: 'credit_rating',           // ä¿¡è©•ï¼ˆ1~10 æˆ– AAA~ï¼‰
    diversity: 'biz_diversity',        // å¾€ä¾†å¤šæ¨£æ€§ï¼ˆç”¢å“/æ¥­å‹™å¤§é¡æ•¸ï¼‰
    corp_industry: 'industry',         // ç”¢æ¥­åˆ¥ï¼ˆå¯é¸ï¼‰
    corp_strategic: 'strategic_level', // ç­–ç•¥æ€§ç”¢æ¥­ç­‰ç´š é«˜/ä¸­/ä½ï¼ˆå¯é¸ï¼‰

    // === æ³•äººæˆ¶ï¼šè¡Œç‚ºç›£æ¸¬(å‹•æ…‹) ===
    fxNow: 'fx_3m',                    // å¤–åŒ¯é‡(è¿‘3æœˆ)
    fxPrev: 'fx_prev3m',               // å¤–åŒ¯é‡(å‰3æœˆ)
    corp_txn_amt_3m: 'corp_txn_amt_3m',        // äº¤æ˜“é‡‘é¡(è¿‘3æœˆ)ï¼ˆå¯é¸ï¼‰
    corp_txn_amt_prev3m: 'corp_txn_amt_prev3m',// äº¤æ˜“é‡‘é¡(å‰3æœˆ)ï¼ˆå¯é¸ï¼‰
    netbank_txn: 'netbank_txn',                // ç¶²éŠ€äº¤æ˜“é‡ï¼ˆå¯ä¾› R æˆ–ç‡Ÿæ”¶ï¼‰
    corp_outflow_abnormal: 'corp_outflow_abnormal' // éå¸¸æ…‹è½‰å‡ºæ——æ¨™ï¼ˆAï¼‰
  },

  // === æ¬Šé‡ï¼ˆ0~100ï¼›B æ¨¡çµ„å°æ‡‰æ¯ä¸€é …çš†æœ‰ä¸­æ–‡è¨»è§£ï¼Œæ”¹æ•¸å­—å³å¯ï¼‰=================
  weight: {
    // === è‡ªç„¶äºº ===
    natural: {
      R: {
        depGrowth: 30, aum: 30, vip: 15, degree: 10, salary: 10, prod: 5,
        txnAmtGrowth: 0, txnCntGrowth: 0, loanUtil: 0
      },
      A: {
        depDrop: 45, inactive: 35, riskFlag: 20, ebankDormant: 0, cardDormant: 0
      },
      white: { prodMax: 1, prodLow: 1, boost: 10 }
    },

    // === æ³•äºº ===
    corp: {
      R: {
        depGrowth: 25, fxGrowth: 25, capital: 15, years: 10, rating: 15, diversity: 10,
        corpTxnAmtGrowth: 0, strategic: 0, netbankUse: 0
      },
      A: { depDrop: 50, outflowAbnormal: 0 },
      white: { diversityMax: 2, boostEach: 5 }
    }
  },

  // æ¨¡æ“¬è²¢ç»é‡‘é¡ï¼ˆé¸ç”¨ï¼‰
  revenue: {
    enable: true,
    range: [100000, 10000000], // 10è¬ï½1000è¬
    nat: { NIM: 0.012, FEE_INV: 0.006, FEE_TRANS: 0.0015, LOAN_SPREAD: 0.02,
      vipUplift: { 'ä¸€èˆ¬':1.00, 'VIP':1.10, 'VVIP':1.20, 'é«˜è³‡ç”¢':1.15 },
      R_WEIGHT: 0.5, A_WEIGHT: 0.5, FACTOR_MIN: 0.7, FACTOR_MAX: 1.5
    },
    corp: { NIM: 0.010, FX_SPREAD: 0.0008, NETBANK_FEE: 12,
      levelUplift: { 'é«˜':1.2, 'ä¸­':1.0, 'ä½':0.8 },
      R_WEIGHT: 0.5, A_WEIGHT: 0.5, FACTOR_MIN: 0.7, FACTOR_MAX: 1.6
    }
  }
};

// === 2) å°å·¥å…· ================================================================
const el = sel => document.querySelector(sel);
const fmt = n => n?.toLocaleString('zh-TW');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const pct = x => clamp(Math.round(x*100),0,100);
const isNum = v => typeof v === 'number' && Number.isFinite(v);
const asNum = v => v===''||v==null? NaN : (typeof v==='number'?v:Number(v.toString().replace(/[,\s]/g,'')));

// ä¼æ¥­è©•ç­‰è½‰åˆ†æ•¸ï¼šåˆ†æ•¸è¶Šå¥½ R è¶Šé«˜
const ratingToScore = v => {
  if (v==null) return 50; const s = String(v).toUpperCase();
  if (/^(AAA|AA\+?)$/.test(s)) return 95;
  if (/^(AA-|A\+)$/.test(s)) return 85;
  if (/^(A|A-|BBB\+)$/.test(s)) return 75;
  const n = Number(s); if (!isNaN(n)) return clamp(110 - n*10, 10, 95);
  return 60;
};
const tierToScore = v => ({'ä¸€èˆ¬':50,'VIP':75,'VVIP':90,'é«˜è³‡ç”¢':85}[String(v)] ?? 50);

// æˆé•·ç‡ â†’ 0~1ï¼ŒæŠŠ [-cap,+cap] ç·šæ€§æ˜ å°„åˆ° [0,1]
const growth01 = (now, prev, capAbs = 0.4) => {
  const n = asNum(now), p = asNum(prev);
  if (!isNum(n) || !isNum(p) || p<=0) return 0;
  const g = clamp((n-p)/p, -capAbs, capAbs);
  return (g + capAbs) / (2*capAbs);
};

function csvParse(text){
  // æ¥µç°¡ CSV è§£æï¼ˆæ”¯æ´é›™å¼•è™Ÿèˆ‡é€—è™Ÿï¼‰
  const rows=[]; let i=0, field='', row=[], q=false; const push=()=>{row.push(field);field=''};
  const pushRow=()=>{rows.push(row); row=[]};
  while(i<text.length){
    const c=text[i++];
    if(q){ if(c==='"'){ if(text[i]==='"'){ field+='"'; i++; } else q=false; }
           else field+=c; continue; }
    if(c==='"'){ q=true; continue; }
    if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; }
    if(c==='\r'){ continue; }
    field+=c;
  }
  push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  return rows.filter(r=>r.some(x=>x!==''))
    .map(r=>Object.fromEntries(hdr.map((h,idx)=>[h.trim(), r[idx]??''])));
}

// === âœ… å–®ä¸€æª”ï¼‹å‹åˆ¥æ¬„ï¼ˆentityï¼‰ï¼šåŒç¾©è©æ”¯æ´ ===
const ENTITY_ALIAS = { 'è‡ªç„¶äºº':'natural', 'å€‹äºº':'natural', 'æ³•äºº':'corp', 'å…¬å¸':'corp' };
function normalizeEntity(v){
  const s = String(v||'').trim();
  return ENTITY_ALIAS[s] || s.toLowerCase();
}

// ç™½åœ°æ¢ä»¶å·¥å…·
function whiteBoostNatural(rec){
  const m=CFG.map; const prod = asNum(rec[m.prodKinds]);
  const depNow=asNum(rec[m.depNow]); const depPrev=asNum(rec[m.depPrev]);
  const g = isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  if(prod <= CFG.weight.natural.white.prodLow && g>0){ return CFG.weight.natural.white.boost; }
  return 0;
}
function whiteBoostCorp(rec){
  const m=CFG.map; const div = asNum(rec[m.diversity]);
  let b = 0;
  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const fxNow=asNum(rec[m.fxNow]), fxPrev=asNum(rec[m.fxPrev]);
  if(div <= CFG.weight.corp.white.diversityMax){
    const dg = isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
    const fg = isNum(fxNow)&&isNum(fxPrev)&&fxPrev>0? (fxNow-fxPrev)/fxPrev : 0;
    if(dg>0) b += CFG.weight.corp.white.boostEach;
    if(fg>0) b += CFG.weight.corp.white.boostEach;
  }
  return b;
}

// === 3) æ ¸å¿ƒè¨ˆåˆ† ==============================================================
function scoreNatural(rec){
  const m=CFG.map, w=CFG.weight.natural;

  // ---- R æŒ‡æ¨™ï¼ˆå°æ‡‰ B æ¨¡çµ„ï¼‰----
  const R_depGrowth = growth01(rec[m.depNow], rec[m.depPrev], 0.4);           // å­˜æ¬¾æˆé•·ç‡
  const R_aum = clamp((asNum(rec[m.aum])||0)/1e8, 0, 1);                      // AUM è¦æ¨¡(0~1å„„)
  const R_vip = tierToScore(rec[m.vip])/100;                                   // VIP ç­‰ç´š
  const R_degree = clamp((asNum(rec[m.degree])||0)*0.25, 0, 1);               // å­¸æ­· 1~4 â†’ 0~1
  const R_salary = clamp((asNum(rec[m.salary])||0)/2e6, 0, 1);                // å¹´è–ª 0~200è¬
  const R_prod = clamp((asNum(rec[m.prodKinds])||0)/4, 0, 1);                  // å››ç·šæ»²é€ 0~4
  const R_txnAmtGrowth = growth01(rec[m.nat_txn_amt_3m], rec[m.nat_txn_amt_prev3m], 0.6);
  const R_txnCntGrowth = growth01(rec[m.nat_txn_cnt_3m], rec[m.nat_txn_cnt_prev3m], 0.6);
  const R_loanUtil = clamp((asNum(rec[m.loan_util])||0), 0, 1);

  let R=0;
  R += w.R.depGrowth     * R_depGrowth;
  R += w.R.aum           * R_aum;
  R += w.R.vip           * R_vip;
  R += w.R.degree        * R_degree;
  R += w.R.salary        * R_salary;
  R += w.R.prod          * R_prod;
  R += w.R.txnAmtGrowth  * R_txnAmtGrowth;
  R += w.R.txnCntGrowth  * R_txnCntGrowth;
  R += w.R.loanUtil      * R_loanUtil;

  // ---- A æŒ‡æ¨™ï¼ˆå°æ‡‰ B æ¨¡çµ„ï¼‰----
  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const depG = isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  const A_depDrop = depG<0? Math.min(Math.abs(depG)/0.3,1):0;
  const A_inactive = clamp((asNum(rec[m.lastDays])-90)/180, 0, 1);
  const A_risk = /^(1|true|Y)$/i.test(String(rec[m.blacklist]||''))? 1 : 0;
  const ebLogin = asNum(rec[m.nat_ebank_login_3m]);
  const A_ebDormant = isNum(ebLogin)? clamp(1 - ebLogin/6, 0, 1):0;
  const cardAct = asNum(rec[m.nat_card_active_3m]);
  const A_cardDormant = isNum(cardAct)? clamp(1 - cardAct/3, 0, 1):0;

  let A=0;
  A += w.A.depDrop       * A_depDrop;
  A += w.A.inactive      * A_inactive;
  A += w.A.riskFlag      * A_risk;
  A += w.A.ebankDormant  * A_ebDormant;
  A += w.A.cardDormant   * A_cardDormant;

  R += whiteBoostNatural(rec);

  const R100 = pct(R/ (Object.values(w.R).reduce((a,b)=>a+b,0) + w.white.boost || 1));
  const A100 = pct(A/ (Object.values(w.A).reduce((a,b)=>a+b,0) || 1));
  return {R:R100, A:A100};
}

function scoreCorp(rec){
  const m=CFG.map, w=CFG.weight.corp;

  // ---- R æŒ‡æ¨™ï¼ˆå°æ‡‰ B æ¨¡çµ„ï¼‰----
  const R_depGrowth = growth01(rec[m.depNow], rec[m.depPrev], 0.4);
  const R_fxGrowth = growth01(rec[m.fxNow], rec[m.fxPrev], 0.6);
  const R_capital = clamp((asNum(rec[m.capital])||0)/5e8, 0, 1);
  const R_years = clamp((asNum(rec[m.years])||0)/30, 0, 1);
  const R_rating = ratingToScore(rec[m.rating])/100;
  const R_diversity = clamp((asNum(rec[m.diversity])||0)/6, 0, 1);
  const R_corpTxnAmtGrowth = growth01(rec[m.corp_txn_amt_3m], rec[m.corp_txn_amt_prev3m], 0.6);
  const strat = String(rec[m.corp_strategic]||'').trim();
  const R_strategic = strat==='é«˜'?1: strat==='ä¸­'?0.5: 0;
  const R_netbankUse = clamp((asNum(rec[m.netbank_txn])||0)/20, 0, 1);

  let R=0;
  R += w.R.depGrowth        * R_depGrowth;
  R += w.R.fxGrowth         * R_fxGrowth;
  R += w.R.capital          * R_capital;
  R += w.R.years            * R_years;
  R += w.R.rating           * R_rating;
  R += w.R.diversity        * R_diversity;
  R += w.R.corpTxnAmtGrowth * R_corpTxnAmtGrowth;
  R += w.R.strategic        * R_strategic;
  R += w.R.netbankUse       * R_netbankUse;

  // ---- A æŒ‡æ¨™ï¼ˆå°æ‡‰ B æ¨¡çµ„ï¼‰----
  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const depG = isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  const A_depDrop = depG<0? Math.min(Math.abs(depG)/0.3,1):0;
  const A_outflowAbn = /^(1|true|Y)$/i.test(String(rec[m.corp_outflow_abnormal]||''))? 1 : 0;

  let A=0;
  A += (w.A.depDrop||0) * A_depDrop;
  A += (w.A.outflowAbnormal||0) * A_outflowAbn;

  R += whiteBoostCorp(rec);

  const R100 = pct(R/ (Object.values(w.R).reduce((a,b)=>a+b,0) + 10 || 1));
  const A100 = pct(A/ (Object.values(w.A).reduce((a,b)=>a+b,0) || 1));
  return {R:R100, A:A100};
}

function decideCell(R,A){
  const c=CFG.cut;
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac; // ä¾‹å¦‚ HL
}

function computeRevenue(rec, entity, R, A){
  const cfg=CFG.revenue; if(!cfg?.enable) return null;
  if(entity==='corp'){
    const m=CFG.map, p=cfg.corp;
    const base = (asNum(rec[m.depNow])||0)*p.NIM + (asNum(rec[m.fxNow])||0)*p.FX_SPREAD*4 + (asNum(rec[m.netbank_txn])||0)*p.NETBANK_FEE*4;
    const factor = clamp(1 + p.R_WEIGHT*(R/100) - p.A_WEIGHT*(A/100), p.FACTOR_MIN, p.FACTOR_MAX);
    return base * factor;
  } else {
    const m=CFG.map, p=cfg.nat;
    const base = (asNum(rec[m.depNow])||0)*p.NIM + (asNum(rec[m.aum])||0)*p.FEE_INV + (asNum(rec[m.nat_txn_amt_3m])||0)*p.FEE_TRANS*12 + (asNum(rec[m.loan_util])||0)*(asNum(rec[m.depNow])||0)*p.LOAN_SPREAD;
    const vip = p.vipUplift[String(rec[m.vip])]||1;
    const factor = clamp(1 + p.R_WEIGHT*(R/100) - p.A_WEIGHT*(A/100), p.FACTOR_MIN, p.FACTOR_MAX);
    return base * factor * vip;
  }
}

// === 4) æ¨æ–·å®¢ç¾¤ / åˆè¦æ’é™¤ ====================================================
function inferEntity(rec){
  // âœ… å…ˆçœ‹ entity æ¬„ï¼ˆæœ€ç©©ï¼‰ï¼Œä¸¦æ”¯æ´ã€Œè‡ªç„¶äºº/æ³•äººã€åŒç¾©
  const e = normalizeEntity(rec[CFG.map.entity]);
  if(e==='natural'||e==='corp') return e;

  // å‚™æ´ï¼šè‹¥æ²’æœ‰ entityï¼Œå†ä¾å…¬å¸æ¬„ä½æ¨æ–·
  const corpHints=[CFG.map.capital, CFG.map.diversity, CFG.map.fxNow, CFG.map.fxPrev];
  if(corpHints.some(h=>rec[h]!=null && rec[h]!=='')) return 'corp';
  return 'natural';
}
function isExcluded(rec){
  const v = String(rec[CFG.map.blacklist]||'').trim();
  return /^(1|true|Y)$/i.test(v);
}

// === 5) ä¸»æµç¨‹ =================================================================
let raw=[], enriched=[], viewFilter='ALL';

function process(){
  const rows = raw;
  enriched = rows.map(rec=>{
    const entity = (el('#selEntity').value==='auto')? inferEntity(rec) : el('#selEntity').value;
    if(isExcluded(rec)) return { ...rec, entity, excluded:true };
    const {R,A} = (entity==='corp')? scoreCorp(rec) : scoreNatural(rec);
    const cell = decideCell(R,A);
    let revenue = computeRevenue(rec, entity, R, A);
    if(revenue!=null){ // ç·šæ€§åˆ°ç›®æ¨™å€é–“ï¼ˆä¿æŒæ’åºï¼‰
      revenue = rescale(enriched, revenue, CFG.revenue.range);
    }
    return { ...rec, entity, R, A, cell, excluded:false, revenue };
  });
  render();
}

// ç·šæ€§ç¸®æ”¾å·¥å…·ï¼šä»¥ç•¶å‰å€¼èˆ‡å·²è¨ˆç®—åˆ†ä½ˆåšç©©å¥ç¸®æ”¾
function rescale(arr, v, [lo,hi]){
  const vals = arr.map(r=>r.revenue).filter(isNum).concat([v]);
  const pLow = quantile(vals, 0.02), pHigh = quantile(vals, 0.98);
  if(pHigh===pLow) return lo;
  const t = clamp((v - pLow)/(pHigh - pLow), 0, 1);
  return Math.round(lo + t*(hi-lo));
}
function quantile(a, q){ const b=[...a].sort((x,y)=>x-y); const i=(b.length-1)*q; const l=Math.floor(i), r=Math.ceil(i); if(l===r) return b[l]; return b[l]*(r-i)+b[r]*(i-l); }

function render(){
  // 1) çµ±è¨ˆå„æ ¼æ•¸é‡
  const groups = groupBy(enriched.filter(r=>!r.excluded), r=>r.cell);
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  const idOf = k => `cell-${k}`;

  // 2) å¯«å…¥å›ºå®šæ ¼å­
  for(const key of order){
    const meta = CFG.labels[key];
    const count = (groups[key]||[]).length;
    const box = el('#'+idOf(key));
    if(!box) continue;
    box.className = `cell cell-${meta.code}`;
    box.innerHTML = `<h4>${meta.code}ï½œ${meta.title}</h4>
      <div class="row"><span class="pill">ç­†æ•¸</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick = ()=>{ viewFilter = key; renderTable(); highlightFilter(); };
  }

  // 3) ç¯©é¸ chips
  const f = el('#filters'); f.innerHTML='';
  const all = document.createElement('button'); all.className='btn'; all.textContent='é¡¯ç¤ºå…¨éƒ¨';
  all.onclick=()=>{viewFilter='ALL'; renderTable(); highlightFilter();}; f.appendChild(all);
  for(const key of order){
    const b=document.createElement('button'); b.className='btn'; b.textContent=`${CFG.labels[key].code}`;
    b.onclick=()=>{viewFilter=key; renderTable(); highlightFilter();}; f.appendChild(b);
  }
  highlightFilter();

  // 4) è¡¨æ ¼
  renderTable();

  // 5) ä¸€æ¬¡æ€§ç”Ÿæˆ CSV æ¬„ä½èªªæ˜
  buildFieldGuide();
}

function highlightFilter(){
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  const btns=[...document.querySelectorAll('#filters .btn')];
  btns.forEach(b=>b.style.outline='none');
  const idx = ['ALL',...order].indexOf(viewFilter);
  if(idx>=0 && btns[idx]) btns[idx].style.outline='2px solid var(--brand)';
}

function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['ID','åç¨±','å®¢ç¾¤','R(æ¨è–¦)','A(é—œæ³¨)','çŸ©é™£','æ¨¡æ“¬è²¢ç»'];
  const rows = enriched.filter(r=>!r.excluded && (viewFilter==='ALL'||r.cell===viewFilter));
  const limit = el('#selPage').value==='å…¨éƒ¨'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML = '<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body = document.createElement('tbody');
  for(const r of rows.slice(0,limit)){
    const tr=document.createElement('tr');
    const values=[r[CFG.map.id], r[CFG.map.name], r.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº',
      r.R, r.A, `${CFG.labels[r.cell].code}ï½œ${CFG.labels[r.cell].title}`, r.revenue? fmt(Math.round(r.revenue)) : '' ];
    tr.innerHTML = values.map((v,i)=>`<td>${i===3||i===4? (v+'%'): v??''}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);
  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded).length);
}

function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

// === 6) åŒ¯å…¥ / åŒ¯å‡º ============================================================
function toCSV(arr){
  if(!arr.length) return '';
  const cols=['id','name','entity','R','A','cell','revenue'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded).map(r=>[
    r[CFG.map.id], r[CFG.map.name], r.entity, r.R, r.A, r.cell, Math.round(r.revenue||0)
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv = toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};

el('#csvInput').addEventListener('change', async(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const text = await file.text();
  raw = csvParse(text);
  process();
});

el('#btnClear').onclick=()=>{ raw=[]; enriched=[]; render(); el('#csvInput').value=''; };

// === 7) éš¨æ©Ÿç¤ºç¯„è³‡æ–™ç”Ÿæˆ ======================================
function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randomFloat(min,max){ return (Math.random()*(max-min)+min).toFixed(2); }

function genDemoData(n=10){
  const rows=[];
  for(let i=0;i<n;i++){
    if(Math.random()<0.6){ // 60% è‡ªç„¶äºº
      rows.push({
        id: "N"+String(i+1).padStart(3,'0'),
        name: "NAT_" + String(i+1).padStart(3,'0'),
        entity: "natural",
        aum_12m: randomInt(5e6,1.2e8),
        salary: randomInt(40e4,300e4),
        degree: randomPick([1,2,3,4]),
        vip_tier: randomPick(["ä¸€èˆ¬","VIP","VVIP","é«˜è³‡ç”¢"]),
        prod_kinds: randomInt(0,4),
        age: randomInt(25,70),
        occupation: randomPick(["ä¸Šç­æ—","é†«å¸«","å¾‹å¸«","ä¼æ¥­ä¸»","æ•™å¸«"]),
        crm_segment: randomPick(["é›¶å”®","é«˜è³‡ç”¢","æ•¸ä½å„ªå…ˆ"]),
        avg_dep_3m: randomInt(20e4,500e4),
        avg_dep_prev3m: randomInt(20e4,500e4),
        last_txn_days: randomInt(1,400),
        txn_amt_3m: randomInt(10e4,500e4),
        txn_amt_prev3m: randomInt(10e4,500e4),
        txn_cnt_3m: randomInt(10,200),
        txn_cnt_prev3m: randomInt(10,200),
        ebank_login_3m: randomInt(0,15),
        card_active_3m: randomInt(0,10),
        loan_util: randomFloat(0,1),
        compliance_blacklist: 0
      });
    } else { // 40% æ³•äºº
      rows.push({
        id: "C"+String(i+1).padStart(3,'0'),
        name:  "CORP_" + String(i+1).padStart(3,'0'),
        entity: "corp",
        capital: randomInt(1e7,5e8),
        company_age_years: randomInt(1,50),
        credit_rating: randomPick(["AAA","AA","A","BBB",1,2,3,4,5]),
        biz_diversity: randomInt(1,6),
        industry: randomPick(["ç§‘æŠ€","è£½é€ ","é‡‘è","é›¶å”®"]),
        strategic_level: randomPick(["é«˜","ä¸­","ä½"]),
        fx_3m: randomInt(10e6,200e6),
        fx_prev3m: randomInt(10e6,200e6),
        corp_txn_amt_3m: randomInt(10e6,100e6),
        corp_txn_amt_prev3m: randomInt(10e6,100e6),
        netbank_txn: randomInt(0,50),
        corp_outflow_abnormal: randomPick([0,0,0,1]), // å¶çˆ¾å‡ºç¾ 1
        compliance_blacklist: 0
      });
    }
  }
  return rows;
}

// åŒ¯å‡ºæˆ CSV æ–‡å­—
function toCSVfromObjects(arr){
  const hdr = Object.keys(arr[0]);
  const lines = arr.map(r=>hdr.map(k=>`"${(r[k]??'')}"`).join(','));
  return [hdr.join(','),...lines].join('\n');
}

el('#btnDemo').onclick=()=>{
  const demoData = genDemoData(12); // ç”¢ç”Ÿ 12 ç­†
  const csv = toCSVfromObjects(demoData);
  raw = csvParse(csv);
  process();
};


// === 8) ç”Ÿæˆ CSV æ¬„ä½èªªæ˜ï¼ˆç”± CFG.map è‡ªå‹•æ¸²æŸ“ï¼‰ =============================
function buildFieldGuide(){
  const box = el('#fieldGuide');
  const pre = el('#csvHeaderSample');
  if(!box || !pre) return;
  if(box.dataset.done === '1') return; // åªåšä¸€æ¬¡
  const m = CFG.map;

  const rows = [];
  // å¿…å¡«
  rows.push(['å¿…å¡«', m.id, 'å…±é€š', 'å®¢æˆ¶ ID']);
  rows.push(['å¿…å¡«', m.name, 'å…±é€š', 'å®¢æˆ¶åç¨±']);
  rows.push(['å¿…å¡«', m.entity, 'å…±é€š', 'å®¢ç¾¤å‹åˆ¥ï¼ˆnatural / corpï¼›å¯å¡«ã€Œè‡ªç„¶äºº/æ³•äººã€ï¼‰']);
  // å…±é€š
  rows.push(['å…±é€š', m.blacklist, 'å…±é€š', 'åˆè¦é»‘åå–®(1/0 æˆ– true/false)']);
  // è‡ªç„¶äºº
  rows.push(['è‡ªç„¶äºº', m.aum, 'è‡ªç„¶äºº', 'æŠ•è³‡ AUMï¼ˆ12Mï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.salary, 'è‡ªç„¶äºº', 'å¹´è–ª']);
  rows.push(['è‡ªç„¶äºº', m.degree, 'è‡ªç„¶äºº', 'å­¸æ­·(1~4)']);
  rows.push(['è‡ªç„¶äºº', m.vip, 'è‡ªç„¶äºº', 'VIP ç­‰ç´š']);
  rows.push(['è‡ªç„¶äºº', m.prodKinds, 'è‡ªç„¶äºº', 'ç”¢å“å¤§é¡æ•¸(å››ç·šæ»²é€)']);
  rows.push(['è‡ªç„¶äºº', m.depNow, 'è‡ªç„¶äºº', 'è¿‘3æœˆå¹³å‡å­˜æ¬¾']);
  rows.push(['è‡ªç„¶äºº', m.depPrev, 'è‡ªç„¶äºº', 'å‰3æœˆå¹³å‡å­˜æ¬¾']);
  rows.push(['è‡ªç„¶äºº', m.lastDays, 'è‡ªç„¶äºº', 'æœ€è¿‘äº¤æ˜“è·å¤©æ•¸']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_3m, 'è‡ªç„¶äºº', 'äº¤æ˜“é‡‘é¡(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_prev3m, 'è‡ªç„¶äºº', 'äº¤æ˜“é‡‘é¡(å‰3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_3m, 'è‡ªç„¶äºº', 'äº¤æ˜“ç­†æ•¸(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_prev3m, 'è‡ªç„¶äºº', 'äº¤æ˜“ç­†æ•¸(å‰3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_ebank_login_3m, 'è‡ªç„¶äºº', 'ç¶²éŠ€ç™»å…¥(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_card_active_3m, 'è‡ªç„¶äºº', 'ä¿¡ç”¨å¡æ´»èº(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.loan_util, 'è‡ªç„¶äºº', 'è²¸æ¬¾å‹•ç”¨ç‡(0~1)']);
  // æ³•äºº
  rows.push(['æ³•äºº', m.fxNow, 'æ³•äºº', 'å¤–åŒ¯é‡(è¿‘3æœˆ)']);
  rows.push(['æ³•äºº', m.fxPrev, 'æ³•äºº', 'å¤–åŒ¯é‡(å‰3æœˆ)']);
  rows.push(['æ³•äºº', m.capital, 'æ³•äºº', 'è³‡æœ¬é¡']);
  rows.push(['æ³•äºº', m.years, 'æ³•äºº', 'æˆç«‹å¹´æ•¸']);
  rows.push(['æ³•äºº', m.rating, 'æ³•äºº', 'ä¿¡è©•(æˆ– AAA~)']);
  rows.push(['æ³•äºº', m.diversity, 'æ³•äºº', 'å¾€ä¾†å¤šæ¨£æ€§(å¤§é¡æ•¸)']);
  rows.push(['æ³•äºº', m.corp_txn_amt_3m, 'æ³•äºº', 'äº¤æ˜“é‡‘é¡(è¿‘3æœˆ)']);
  rows.push(['æ³•äºº', m.corp_txn_amt_prev3m, 'æ³•äºº', 'äº¤æ˜“é‡‘é¡(å‰3æœˆ)']);
  rows.push(['æ³•äºº', m.netbank_txn, 'æ³•äºº', 'ç¶²éŠ€äº¤æ˜“é‡']);
  rows.push(['æ³•äºº', m.corp_outflow_abnormal, 'æ³•äºº', 'éå¸¸æ…‹è½‰å‡º(1/0)']);
  rows.push(['æ³•äºº', m.corp_industry, 'æ³•äºº(å¯é¸)', 'ç”¢æ¥­åˆ¥']);
  rows.push(['æ³•äºº', m.corp_strategic, 'æ³•äºº(å¯é¸)', 'ç­–ç•¥æ€§ç”¢æ¥­ï¼ˆé«˜/ä¸­/ä½ï¼‰']);

  const table = document.createElement('table');
  table.className = 'tbl';
  table.innerHTML = `
    <thead><tr>
      <th>é¡åˆ¥</th><th>CSV æ¨™é ­åç¨±</th><th>é©ç”¨å®¢ç¾¤</th><th>èªªæ˜</th>
    </tr></thead>
    <tbody>
      ${rows.map(r=>`<tr><td>${r[0]}</td><td><code>${r[1]}</code></td><td>${r[2]}</td><td>${r[3]}</td></tr>`).join('')}
    </tbody>`;
  box.appendChild(table);

  // è¡¨é ­ç¯„æœ¬ï¼ˆå®Œæ•´æ¨™ç±¤é›†ï¼›é †åºå¯è‡ªç”±èª¿æ•´ï¼‰
  const headerLine = Object.values(m).join(',');
  pre.textContent = headerLine;

  box.dataset.done = '1';
}

// åˆå§‹æ¸²æŸ“
render();
</script>
</body>
</html>
