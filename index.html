<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI æ½›åŠ›å®¢æ™ºé¸å°èˆªï½œæ±ºç­–çŸ©é™£ (Client-Only)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;
      --grid-border:#2a355c;
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .hero{display:flex;gap:20px;align-items:center}
    .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
    h1{font-size:28px;margin:4px 0 8px}
    p.muted{color:var(--muted);margin:0}
    .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    input[type=file]{display:none}
    label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
    .kv{display:flex;gap:10px;align-items:center}
    .kv .k{color:#98a8c6}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
    footer{opacity:.7;margin:24px 0 40px}

    /* ======= 4Ã—4 çŸ©é™£ç‰ˆé¢ï¼ˆå·¦åˆ—ï¼šæ¨è–¦ï¼›ä¸Šåˆ—ï¼šé—œæ³¨ï¼‰ ======= */
    :root{
      --side-w: 56px; --head-h: 56px;
      --col-w-L: 1fr; --col-w-M: 1fr; --col-w-H: 1fr;
      --row-h-H: 112px; --row-h-M: 112px; --row-h-L: 112px;
      --grid-border:#2a355c;
    }
    .matrix-wrapper{
      display:grid;
      grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
      grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
      border:1px solid var(--grid-border);
      border-radius:12px; overflow:hidden; background:#fff;
    }
    .matrix-header,.matrix-side{
      display:flex;align-items:center;justify-content:center;
      background:#f5f7fa;color:#000;font-weight:700;
      border-right:1px solid var(--grid-border); border-bottom:1px solid var(--grid-border);
    }
    .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;position:relative;background:#fff;}
    .cell h4{margin:0 0 6px;font-size:14px;color:#000}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
    .num{font-size:22px;font-weight:700;color:#000}
    .cell-A1 { background:#f57c00; } /* é«˜æ½›åŠ›é–‹ç™¼ï¼ˆæ©˜ï¼‰ */
    .cell-A2 { background:#fbc02d; } /* é«˜æ½›åŠ›ç›£æ¸¬ï¼ˆé»ƒï¼‰ */
    .cell-B1 { background:#f57c00; } /* é«˜æ½›åŠ›è­¦ç¤ºï¼ˆæ©˜ï¼‰ */
    .cell-C1,.cell-C2,.cell-C3,.cell-C4,.cell-C5 { background:#fff176; } /* ä¸­/ä½æ½›åŠ›ï¼ˆæ·¡é»ƒï¼‰ */
    .cell-B2 { background:#fbc02d; } /* ä¸­æ½›åŠ›è­¦ç¤ºï¼ˆé»ƒï¼‰ */
    
    /* ç¨ç«‹çš„ Z åˆ— */
  .zbar{
    margin-top:8px;background:#f5f7fa;color:#000;
    border:1px solid var(--grid-border);border-radius:8px;
    padding:10px;text-align:center;font-weight:700
  }
</style>

    /* å…±åŒè¡¨æ ¼ */
    .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
    .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left}
    .tbl th{background:#0f1733;color:#a9b9db;position:sticky;top:0}

    /* ========== Page2ï¼šæ´¾é€é ï¼ˆåƒè€ƒä½ æä¾›çš„æ¨£å¼ï¼‰ ========== */
    .dispatch-wrap{max-width:1280px;margin:24px auto;padding:0 16px}
    .dispatch-card{background:#f3f6ff;border:1px solid #b9c6eb;border-radius:10px;padding:10px;margin-bottom:12px;color:#00123a}
    .dispatch-toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .dispatch-toolbar .step{display:flex;align-items:center;gap:8px;background:#e8eeff;border:1px solid #b9c6eb;border-radius:8px;padding:6px 10px}
    .dispatch-search{flex:1;min-width:260px}
    .dispatch-search input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #c7d2f0;background:#fff}
    .dispatch-table{width:100%;border-collapse:collapse;background:#fff;border:2px solid #9fb3e8}
    .dispatch-table th,.dispatch-table td{border:1px solid #9fb3e8;padding:8px 10px;vertical-align:top;color:#00123a;background:#fff}
    .dispatch-table th{background:#e8eeff;font-weight:700;text-align:center}
    .badge-dot{width:18px;height:18px;border-radius:50%;background:#8e97a6;display:inline-block;border:2px solid #636b76}
    .mini{font-size:12px;color:#33405e}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #c7d2f0;background:#eef3ff;font-weight:600}
    .muted2{color:#62739c}
    .soft{background:#fbfcff}
    .note{display:inline-block;padding:2px 6px;border-radius:6px;background:#fff4cc;border:1px solid #ffd27a;color:#5a4600;margin-left:6px}
    .btn.ghost{background:#e9eeff;color:#132a7a;border:1px solid #b9c6eb}
    .btn.link{background:transparent;color:#66e0ff;text-decoration:underline}
    .danger{color:#b00020}
    .ok{color:#0b7f00}
    .hidden{display:none !important;}
  </style>
</head>
<body>

<!-- =========================================================
     Page åˆ‡æ›å®¹å™¨ï¼ˆä¸å‹•ä½ çš„ç¬¬ä¸€é  UIï¼ŒåªåŒ…è£èµ·ä¾†ï¼‰
     ========================================================= -->
<section id="page1" style="display:block">
  <div class="wrap">
    <div class="hero">
      <span class="badge"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3 7 7 .5-5.5 4.8 1.7 7.2L12 17l-6.2 4.5 1.7-7.2L2 9.5 9 9z"/></svg> AI æ½›åŠ›å®¢æ™ºé¸å°èˆª</span>
      <div>
        <h1>é–‹ç™¼æ½›åŠ›åå–®æ±ºç­–çŸ©é™£</h1>
        <p class="muted">å°‡åå–®ä»¥ <b>CSV</b> åŒ¯å…¥ï¼Œæ–¼ç€è¦½å™¨å…§è¨ˆç®— <b>æ¨è–¦R / é—œæ³¨A</b> åˆ†æ•¸</p>
      </div>
    </div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvInput">ğŸ“„ åŒ¯å…¥ CSVï¼ˆUTF-8ï¼‰</label>
        <input id="csvInput" type="file" accept=".csv" />
        <button class="btn" id="btnDemo">è¼‰å…¥ç¤ºç¯„è³‡æ–™</button>
        <button class="btn" id="btnClear">æ¸…ç©º</button>
        <div class="right kv"><span class="k">è³‡æ–™ç­†æ•¸ï¼š</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice">æ¬„ä½éœ€æ±‚è«‹åƒè¦‹ä¸‹æ–¹ <b>CSV æ¬„ä½èªªæ˜</b>ï¼ˆé †åºä¸æ‹˜ï¼Œä½†è¡¨é ­åç¨±éœ€å°æ‡‰ï¼›ä¸é©ç”¨æ¬„ä½ç•™ç©ºï¼‰ã€‚</div>
      </div>
      <details style="margin-top:10px">
        <summary class="btn">CSV æ¬„ä½èªªæ˜èˆ‡ç¯„æœ¬ï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
        <div id="fieldGuide"></div>
        <div style="margin-top:10px">
          <div class="kv"><span class="k">å®Œæ•´è¡¨é ­ç¯„æœ¬ï¼ˆé †åºå¯è‡ªç”±èª¿æ•´ï¼‰ï¼š</span></div>
          <pre class="code" id="csvHeaderSample"></pre>
        </div>
      </details>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">ä¹å®®æ ¼æ±ºç­–æ‘˜è¦</h3><button class="btn right" id="btnDownload">åŒ¯å‡ºçµæœ CSV</button></div>

        <!-- 4Ã—4 ç‰ˆé¢ -->
        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header">é—œæ³¨ä½</div>
          <div class="matrix-header">é—œæ³¨ä¸­</div>
          <div class="matrix-header">é—œæ³¨é«˜</div>

          <div class="matrix-side">æ¨è–¦é«˜</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side">æ¨è–¦ä¸­</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side">æ¨è–¦ä½</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>
      </div>

      <!-- âœ… æ–°å¢ï¼šZ åˆè¦æ’é™¤ç¨ç«‹åˆ— -->
      <div class="zbar" id="zBar"></div>
      
      <div class="panel">
        <h3 style="margin:0 0 8px">ç¯©é¸</h3>
        <div class="chips" id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">å®¢ç¾¤é¡å‹ï¼š</span>
            <select id="selEntity" class="btn">
              <option value="auto">è‡ªå‹•ï¼ˆä¾æ˜¯å¦æœ‰å…¬å¸æ¬„ä½æ¨æ–·ï¼‰</option>
              <option value="natural">è‡ªç„¶äºº</option>
              <option value="corp">æ³•äºº</option>
            </select>
          </label>
          <label class="kv"><span class="k">é¡¯ç¤ºç­†æ•¸ï¼š</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>å…¨éƒ¨</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <!-- âœ… ä¾ç…§ä½ çš„æŒ‡å®šï¼šæ–°å¢å…©é¡†æŒ‰éˆ•ï¼Œä½ç½®åœ¨ã€Œç¯©é¸ã€èˆ‡ã€Œè¨ˆç®—çµæœã€ä¹‹é–“ -->
    <div class="row" style="margin:16px 0 0 0">
      <button class="btn" id="btnGoDispatch">ğŸ“Œ æ½›åŠ›åå–®æ´¾é€</button>
      <button class="btn ghost" id="btnTableau">ğŸ“Š Tableau</button>
      <span class="muted2 mini">ï¼ˆåƒ… A1/A2/B1/B2 æ´¾é€ï¼‰</span>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">è¨ˆç®—çµæœ</h3>
      <div style="max-height:360px;overflow:auto">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>Â© 2025 AIT3 Demo â€¢ Client-Only â€¢ ç„¡è³‡æ–™ä¸Šå‚³</footer>
  </div>
</section>

<!-- ===================== Page 2ï¼šæ½›åŠ›åå–®æ´¾é€ï¼ˆåƒ… A1/A2/B1/B2ï¼‰ ===================== -->
<section id="page2" class="hidden">
  <div class="dispatch-wrap">
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="showPage('page1')">â† è¿”å›é¦–é çŸ©é™£</button>
      <div class="right mini muted2">åƒ…é¡¯ç¤º A1 / A2 / B1 / B2ï¼›RM ç‹€æ…‹èˆ‡è¨»è¨˜æœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ <b>localStorage</b> ä¸­</div>
    </div>

    <!-- å·¥å…·åˆ—ï¼ˆæœå°‹èˆ‡æ‰¹æ¬¡æŒ‡æ´¾æ­¥é©Ÿæ¢ï¼‰ -->
    <div class="dispatch-card">
      <div class="dispatch-toolbar">
        <div class="dispatch-search"><input id="dispatchSearch" type="search" placeholder="ğŸ” æœå°‹ å€åŸŸ/åˆ†è¡Œ/RM/å®¢æˆ¶ID/åç¨±/ä»£ç¢¼..." oninput="renderDispatch()"></div>
        <div class="step"><b>ï¼Šæ‰¹æ¬¡æŒ‡æ´¾/æ”¹æ´¾ï¼š</b> <span class="mini">â‘  é¸å–åå–® â†’ â‘¡ æŒ‡æ´¾ RM</span></div>
        <button class="btn" onclick="batchAssign()">æ‰¹æ¬¡æŒ‡æ´¾/æ”¹æ´¾</button>
        <button class="btn ghost" onclick="clearRMFilters()">æ¸…é™¤ç¯©é¸</button>
      </div>
    </div>

    <!-- åå–®è¡¨æ ¼ï¼ˆæ¨£å¼åƒè€ƒä½ æä¾›çš„æˆªåœ–ï¼‰ -->
    <div style="overflow:auto">
      <table class="dispatch-table" id="dispatchTbl">
        <!-- å…§å®¹ç”± renderDispatch() ç”¢ç”Ÿ -->
      </table>
    </div>
  </div>
</section>

<!-- ï¼ˆå¯æ“´å……ï¼šPage3 é©—è­‰é ï¼›è‹¥æœªä½¿ç”¨å¯å¿½ç•¥ï¼‰
<section id="page3" class="hidden"> ... </section>
-->

<script>
/* -----------------------------------------------
   1) ç³»çµ±è¨­å®šï¼ˆç¶­æŒä½ åŸæœ‰åƒæ•¸èˆ‡è¨ˆç®—ï¼‰
   ----------------------------------------------- */
const CFG = {
  cut: { R: {hi: 70, mid: 40}, A: {hi: 70, mid: 40} },
  labels: {
    HL: { code: 'A1', title: 'é«˜æ½›åŠ›é–‹ç™¼', tone:'ok'   },
    HM: { code: 'A2', title: 'é«˜æ½›åŠ›ç›£æ¸¬', tone:'warn' },
    HH: { code: 'B1', title: 'é«˜æ½›åŠ›è­¦ç¤º', tone:'risk' },
    ML: { code: 'C1', title: 'ä¸­æ½›åŠ›ç¶­è­·', tone:'ok'   },
    MM: { code: 'C2', title: 'ä¸­æ½›åŠ›ç›£æ¸¬', tone:'warn' },
    MH: { code: 'B2', title: 'ä¸­æ½›åŠ›è­¦ç¤º', tone:'risk' },
    LL: { code: 'C3', title: 'ä½æ½›åŠ›ç¶­è­·', tone:'ok'   },
    LM: { code: 'C4', title: 'ä½æ½›åŠ›ç›£æ¸¬', tone:'warn' },
    LH: { code: 'C5', title: 'ä½æ½›åŠ›è­¦ç¤º', tone:'risk' },
    Z : { code: 'Z',  title: 'åˆè¦æ’é™¤',   tone:'risk' } 
  },
  map: {
    id:'id', name:'name', entity:'entity', blacklist:'compliance_blacklist',
    aum:'aum_12m', salary:'salary', degree:'degree', vip:'vip_tier', prodKinds:'prod_kinds',
    nat_age:'age', nat_job:'occupation', nat_segment:'crm_segment',
    depNow:'avg_dep_3m', depPrev:'avg_dep_prev3m', lastDays:'last_txn_days',
    nat_txn_amt_3m:'txn_amt_3m', nat_txn_amt_prev3m:'txn_amt_prev3m',
    nat_txn_cnt_3m:'txn_cnt_3m', nat_txn_cnt_prev3m:'txn_cnt_prev3m',
    nat_ebank_login_3m:'ebank_login_3m', nat_card_active_3m:'card_active_3m', loan_util:'loan_util',
    capital:'capital', years:'company_age_years', rating:'credit_rating', diversity:'biz_diversity',
    corp_industry:'industry', corp_strategic:'strategic_level',
    fxNow:'fx_3m', fxPrev:'fx_prev3m', corp_txn_amt_3m:'corp_txn_amt_3m', corp_txn_amt_prev3m:'corp_txn_amt_prev3m',
    netbank_txn:'netbank_txn', corp_outflow_abnormal:'corp_outflow_abnormal'
  },
  weight:{
    natural:{
      R:{depGrowth:30, aum:30, vip:15, degree:10, salary:10, prod:5, txnAmtGrowth:0, txnCntGrowth:0, loanUtil:0},
      A:{depDrop:45, inactive:35, riskFlag:20, ebankDormant:0, cardDormant:0},
      white:{prodMax:1, prodLow:1, boost:10}
    },
    corp:{
      R:{depGrowth:25, fxGrowth:25, capital:15, years:10, rating:15, diversity:10, corpTxnAmtGrowth:0, strategic:0, netbankUse:0},
      A:{depDrop:50, outflowAbnormal:0},
      white:{diversityMax:2, boostEach:5}
    }
  },
  revenue:{
    enable:true, range:[100000,10000000],
    nat:{ NIM:0.012, FEE_INV:0.006, FEE_TRANS:0.0015, LOAN_SPREAD:0.02,
      vipUplift:{'ä¸€èˆ¬':1.00,'VIP':1.10,'VVIP':1.20,'é«˜è³‡ç”¢':1.15},
      R_WEIGHT:0.5, A_WEIGHT:0.5, FACTOR_MIN:0.7, FACTOR_MAX:1.5
    },
    corp:{ NIM:0.010, FX_SPREAD:0.0008, NETBANK_FEE:12,
      levelUplift:{'é«˜':1.2,'ä¸­':1.0,'ä½':0.8},
      R_WEIGHT:0.5, A_WEIGHT:0.5, FACTOR_MIN:0.7, FACTOR_MAX:1.6
    }
  }
};

/* -----------------------------------------------
   2) å°å·¥å…·
   ----------------------------------------------- */
const el = sel => document.querySelector(sel);
const fmt = n => n?.toLocaleString('zh-TW');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const pct = x => clamp(Math.round(x*100),0,100);
const isNum = v => typeof v==='number' && Number.isFinite(v);
const asNum = v => v===''||v==null? NaN : (typeof v==='number'?v:Number(v.toString().replace(/[,\s]/g,'')));
const ENTITY_ALIAS = { 'è‡ªç„¶äºº':'natural','å€‹äºº':'natural','æ³•äºº':'corp','å…¬å¸':'corp' };
const normalizeEntity = v => (ENTITY_ALIAS[String(v||'').trim()] || String(v||'').toLowerCase());

const ratingToScore = v => {
  if (v==null) return 50; const s=String(v).toUpperCase();
  if (/^(AAA|AA\+?)$/.test(s)) return 95;
  if (/^(AA-|A\+)$/.test(s)) return 85;
  if (/^(A|A-|BBB\+)$/.test(s)) return 75;
  const n=Number(s); if(!isNaN(n)) return clamp(110-n*10,10,95);
  return 60;
};
const tierToScore = v => ({'ä¸€èˆ¬':50,'VIP':75,'VVIP':90,'é«˜è³‡ç”¢':85}[String(v)] ?? 50);
const growth01 = (now, prev, capAbs=0.4)=>{
  const n=asNum(now), p=asNum(prev);
  if(!isNum(n)||!isNum(p)||p<=0) return 0;
  const g=clamp((n-p)/p, -capAbs, capAbs);
  return (g+capAbs)/(2*capAbs);
};
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false; const push=()=>{row.push(field);field=''};
  const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++]; if(q){ if(c==='"'){ if(text[i]==='"'){field+='"';i++;}else q=false; } else field+=c; continue; }
    if(c==='"'){ q=true; continue; } if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; } if(c==='\r'){ continue; } field+=c;
  }
  push(); if(row.length) pushRow(); const hdr=rows.shift(); if(!hdr) return [];
  return rows.filter(r=>r.some(x=>x!=='')).map(r=>Object.fromEntries(hdr.map((h,idx)=>[h.trim(),r[idx]??''])));
}

/* -----------------------------------------------
   3) è¨ˆåˆ†èˆ‡åˆ†é¡ï¼ˆç¶­æŒä½ çš„åŸé‚è¼¯ï¼‰
   ----------------------------------------------- */
function whiteBoostNatural(rec){
  const m=CFG.map; const prod=asNum(rec[m.prodKinds]);
  const depNow=asNum(rec[m.depNow]); const depPrev=asNum(rec[m.depPrev]);
  const g=isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  return (prod<=CFG.weight.natural.white.prodLow && g>0)? CFG.weight.natural.white.boost : 0;
}
function whiteBoostCorp(rec){
  const m=CFG.map; const div=asNum(rec[m.diversity]); let b=0;
  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const fxNow=asNum(rec[m.fxNow]), fxPrev=asNum(rec[m.fxPrev]);
  if(div<=CFG.weight.corp.white.diversityMax){
    const dg=isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
    const fg=isNum(fxNow)&&isNum(fxPrev)&&fxPrev>0? (fxNow-fxPrev)/fxPrev : 0;
    if(dg>0) b+=CFG.weight.corp.white.boostEach;
    if(fg>0) b+=CFG.weight.corp.white.boostEach;
  } return b;
}
function scoreNatural(rec){
  const m=CFG.map, w=CFG.weight.natural;
  const R_depGrowth=growth01(rec[m.depNow], rec[m.depPrev],0.4);
  const R_aum=clamp((asNum(rec[m.aum])||0)/1e8,0,1);
  const R_vip=tierToScore(rec[m.vip])/100;
  const R_degree=clamp((asNum(rec[m.degree])||0)*0.25,0,1);
  const R_salary=clamp((asNum(rec[m.salary])||0)/2e6,0,1);
  const R_prod=clamp((asNum(rec[m.prodKinds])||0)/4,0,1);
  const R_txnAmtGrowth=growth01(rec[m.nat_txn_amt_3m], rec[m.nat_txn_amt_prev3m],0.6);
  const R_txnCntGrowth=growth01(rec[m.nat_txn_cnt_3m], rec[m.nat_txn_cnt_prev3m],0.6);
  const R_loanUtil=clamp((asNum(rec[m.loan_util])||0),0,1);
  let R= w.R.depGrowth*R_depGrowth + w.R.aum*R_aum + w.R.vip*R_vip + w.R.degree*R_degree + w.R.salary*R_salary +
         w.R.prod*R_prod + w.R.txnAmtGrowth*R_txnAmtGrowth + w.R.txnCntGrowth*R_txnCntGrowth + w.R.loanUtil*R_loanUtil;

  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const depG=isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  const A_depDrop=depG<0? Math.min(Math.abs(depG)/0.3,1):0;
  const A_inactive=clamp((asNum(rec[m.lastDays])-90)/180,0,1);
  const A_risk=/^(1|true|Y)$/i.test(String(rec[m.blacklist]||''))?1:0;
  const ebLogin=asNum(rec[m.nat_ebank_login_3m]);
  const A_ebDormant=isNum(ebLogin)?clamp(1-ebLogin/6,0,1):0;
  const cardAct=asNum(rec[m.nat_card_active_3m]);
  const A_cardDormant=isNum(cardAct)?clamp(1-cardAct/3,0,1):0;
  let A= w.A.depDrop*A_depDrop + w.A.inactive*A_inactive + w.A.riskFlag*A_risk + w.A.ebankDormant*A_ebDormant + w.A.cardDormant*A_cardDormant;

  R += whiteBoostNatural(rec);
  const R100=pct(R/(Object.values(w.R).reduce((a,b)=>a+b,0)+w.white.boost||1));
  const A100=pct(A/(Object.values(w.A).reduce((a,b)=>a+b,0)||1));
  return {R:R100,A:A100};
}
function scoreCorp(rec){
  const m=CFG.map, w=CFG.weight.corp;
  const R_depGrowth=growth01(rec[m.depNow], rec[m.depPrev],0.4);
  const R_fxGrowth=growth01(rec[m.fxNow], rec[m.fxPrev],0.6);
  const R_capital=clamp((asNum(rec[m.capital])||0)/5e8,0,1);
  const R_years=clamp((asNum(rec[m.years])||0)/30,0,1);
  const R_rating=ratingToScore(rec[m.rating])/100;
  const R_diversity=clamp((asNum(rec[m.diversity])||0)/6,0,1);
  const R_corpTxnAmtGrowth=growth01(rec[m.corp_txn_amt_3m], rec[m.corp_txn_amt_prev3m],0.6);
  const strat=String(rec[m.corp_strategic]||'').trim();
  const R_strategic=strat==='é«˜'?1: strat==='ä¸­'?0.5: 0;
  const R_netbankUse=clamp((asNum(rec[m.netbank_txn])||0)/20,0,1);
  let R= w.R.depGrowth*R_depGrowth + w.R.fxGrowth*R_fxGrowth + w.R.capital*R_capital + w.R.years*R_years +
         w.R.rating*R_rating + w.R.diversity*R_diversity + w.R.corpTxnAmtGrowth*R_corpTxnAmtGrowth +
         w.R.strategic*R_strategic + w.R.netbankUse*R_netbankUse;

  const depNow=asNum(rec[m.depNow]), depPrev=asNum(rec[m.depPrev]);
  const depG=isNum(depNow)&&isNum(depPrev)&&depPrev>0? (depNow-depPrev)/depPrev : 0;
  const A_depDrop=depG<0? Math.min(Math.abs(depG)/0.3,1):0;
  const A_outflowAbn=/^(1|true|Y)$/i.test(String(rec[m.corp_outflow_abnormal]||''))?1:0;
  let A=(w.A.depDrop||0)*A_depDrop + (w.A.outflowAbnormal||0)*A_outflowAbn;

  R += whiteBoostCorp(rec);
  const R100=pct(R/(Object.values(w.R).reduce((a,b)=>a+b,0)+10||1));
  const A100=pct(A/(Object.values(w.A).reduce((a,b)=>a+b,0)||1));
  return {R:R100, A:A100};
}
const decideCell=(R,A)=> {
  const c=CFG.cut;
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac;
};
function computeRevenue(rec, entity, R, A){
  const cfg=CFG.revenue; if(!cfg?.enable) return null;
  if(entity==='corp'){
    const m=CFG.map, p=cfg.corp;
    const base=(asNum(rec[m.depNow])||0)*p.NIM + (asNum(rec[m.fxNow])||0)*p.FX_SPREAD*4 + (asNum(rec[m.netbank_txn])||0)*p.NETBANK_FEE*4;
    const factor=clamp(1 + p.R_WEIGHT*(R/100) - p.A_WEIGHT*(A/100), p.FACTOR_MIN, p.FACTOR_MAX);
    return base*factor;
  }else{
    const m=CFG.map, p=cfg.nat;
    const base=(asNum(rec[m.depNow])||0)*p.NIM + (asNum(rec[m.aum])||0)*p.FEE_INV + (asNum(rec[m.nat_txn_amt_3m])||0)*p.FEE_TRANS*12 + (asNum(rec[m.loan_util])||0)*(asNum(rec[m.depNow])||0)*p.LOAN_SPREAD;
    const vip=p.vipUplift[String(rec[m.vip])]||1;
    const factor=clamp(1 + p.R_WEIGHT*(R/100) - p.A_WEIGHT*(A/100), p.FACTOR_MIN, p.FACTOR_MAX);
    return base*factor*vip;
  }
}

/* -----------------------------------------------
   4) æ¨æ–·å®¢ç¾¤ / åˆè¦æ’é™¤
   ----------------------------------------------- */
function inferEntity(rec){
  const e=normalizeEntity(rec[CFG.map.entity]);
  if(e==='natural'||e==='corp') return e;
  const corpHints=[CFG.map.capital,CFG.map.diversity,CFG.map.fxNow,CFG.map.fxPrev];
  if(corpHints.some(h=>rec[h]!=null && rec[h]!=='')) return 'corp';
  return 'natural';
}
const isExcluded = rec => /^(1|true|Y)$/i.test(String(rec[CFG.map.blacklist]||''));

/* -----------------------------------------------
   5) ä¸»æµç¨‹ï¼ˆè³‡æ–™ â†’ enriched â†’ Page1 æ¸²æŸ“ï¼‰
   ----------------------------------------------- */
let raw=[], enriched=[], viewFilter='ALL';

function process(){
  const rows = raw;
  enriched = rows.map(rec=>{
    const entity = (el('#selEntity').value==='auto')? inferEntity(rec) : el('#selEntity').value;
    if(isExcluded(rec)) return {...rec, entity, excluded:true};
    const {R,A} = (entity==='corp')? scoreCorp(rec) : scoreNatural(rec);
    const cell = decideCell(R,A);
    let revenue = computeRevenue(rec, entity, R, A);
    if(revenue!=null){ revenue = rescale(enriched, revenue, CFG.revenue.range); }
    return {...rec, entity, R, A, cell, excluded:false, revenue};
  });
  render();
  // è‹¥æ­¤æ™‚åœ¨æ´¾é€é ï¼Œè®“ç•«é¢åŒæ­¥æ›´æ–°
  if(!el('#page2').classList.contains('hidden')) renderDispatch();
}

// ç·šæ€§ç¸®æ”¾ï¼ˆç©©å¥ï¼‰
function rescale(arr, v, [lo,hi]){
  const vals=arr.map(r=>r.revenue).filter(isNum).concat([v]);
  const pLow=quantile(vals,0.02), pHigh=quantile(vals,0.98);
  if(pHigh===pLow) return lo;
  const t=clamp((v-pLow)/(pHigh-pLow),0,1);
  return Math.round(lo+t*(hi-lo));
}
function quantile(a,q){ const b=[...a].sort((x,y)=>x-y); const i=(b.length-1)*q; const l=Math.floor(i), r=Math.ceil(i); if(l===r) return b[l]; return b[l]*(r-i)+b[r]*(i-l); }

<script>
function render(){
  const groups = groupBy(enriched.filter(r=>!r.excluded), r=>r.cell);

  // 3Ã—3 çš„ä¹å®®æ ¼ä»ç”¨é€™ 9 æ ¼ï¼ˆLH ç¾åœ¨æ˜¯ C5ï¼‰
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  const idOf = k => `cell-${k}`;

  for(const key of order){
    const meta=CFG.labels[key];
    const count=(groups[key]||[]).length;
    const box=el('#'+idOf(key)); if(!box) continue;
    box.className=`cell cell-${meta.code}`;
    box.innerHTML=`<h4>${meta.code}ï½œ${meta.title}</h4>
      <div class="row"><span class="pill">ç­†æ•¸</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  }

  // âœ… Z ç¨ç«‹åˆ—ï¼ˆè¨ˆæ•¸ = excludedï¼‰
  const zCount = enriched.filter(r=>r.excluded).length;
  const zbar = el('#zBar');
  if(zbar){
    zbar.innerHTML = `Zï½œ${CFG.labels.Z.title}ã€€â€¢ã€€ç­†æ•¸ <span class="num">${fmt(zCount)}</span>`;
    zbar.onclick = ()=>{ viewFilter='Z'; renderTable(); highlightFilter(); };
    zbar.style.cursor = 'pointer';
  }

  // ç¯©é¸æŒ‰éˆ•
  const f=el('#filters'); f.innerHTML='';
  const all=document.createElement('button'); all.className='btn'; all.textContent='é¡¯ç¤ºå…¨éƒ¨';
  all.onclick=()=>{viewFilter='ALL'; renderTable(); highlightFilter();}; f.appendChild(all);
  for(const key of order){
    const b=document.createElement('button'); b.className='btn'; b.textContent=`${CFG.labels[key].code}`;
    b.onclick=()=>{viewFilter=key; renderTable(); highlightFilter();}; f.appendChild(b);
  }
  // âœ… è¿½åŠ  Z æŒ‰éˆ•
  const bz=document.createElement('button'); bz.className='btn'; bz.textContent='Z';
  bz.onclick=()=>{viewFilter='Z'; renderTable(); highlightFilter();}; f.appendChild(bz);

  highlightFilter();
  renderTable();
  buildFieldGuide();
}

function highlightFilter(){
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH','Z']; // âœ… å¤šäº† Z
  const btns=[...document.querySelectorAll('#filters .btn')];
  btns.forEach(b=>b.style.outline='none');
  const idx=['ALL',...order].indexOf(viewFilter);
  if(idx>=0 && btns[idx]) btns[idx].style.outline='2px solid var(--brand)';
}
<script>
function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['ID','åç¨±','å®¢ç¾¤','R(æ¨è–¦)','A(é—œæ³¨)','çŸ©é™£','æ¨¡æ“¬è²¢ç»'];

  let rows;
  if(viewFilter==='Z'){
    // âœ… é¡¯ç¤ºè¢«åˆè¦æ’é™¤è€…
    rows = enriched.filter(r=>r.excluded);
  }else{
    rows = enriched.filter(r=>!r.excluded && (viewFilter==='ALL'||r.cell===viewFilter));
  }

  const limit=el('#selPage').value==='å…¨éƒ¨'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');

  for(const r of rows.slice(0,limit)){
    const isZ = !!r.excluded;
    const meta = isZ ? CFG.labels.Z : CFG.labels[r.cell];
    const entityTxt = r.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº';

    const vals = [
      r[CFG.map.id],
      r[CFG.map.name],
      entityTxt,
      isZ ? '' : r.R,
      isZ ? '' : r.A,
      `${meta.code}ï½œ${meta.title}`,
      isZ ? '' : (r.revenue? fmt(Math.round(r.revenue)) : '')
    ];

    const tr=document.createElement('tr');
    tr.innerHTML = vals.map((v,i)=>`<td>${(!isZ && (i===3||i===4) && v!=='')? (v+'%') : (v??'')}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);

  // æ›´æ–°ç¸½ç­†æ•¸ï¼ˆä¸å« Zï¼‰
  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded).length);
}
</script>

function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

/* -----------------------------------------------
   6) åŒ¯å…¥ / åŒ¯å‡ºï¼ˆä¿ç•™ï¼‰
   ----------------------------------------------- */
function toCSV(arr){
  if(!arr.length) return '';
  const cols=['id','name','entity','R','A','cell','revenue'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded).map(r=>[
    r[CFG.map.id], r[CFG.map.name], r.entity, r.R, r.A, r.cell, Math.round(r.revenue||0)
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};
el('#csvInput').addEventListener('change', async(e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  const text=await file.text(); raw=csvParse(text); process();
});
el('#btnClear').onclick=()=>{ raw=[]; enriched=[]; render(); el('#csvInput').value=''; };

/* -----------------------------------------------
   7) ç¤ºç¯„è³‡æ–™ï¼ˆä¿ç•™ï¼‰
   ----------------------------------------------- */
function randomPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randomFloat(min,max){ return (Math.random()*(max-min)+min).toFixed(2); }
function genDemoData(n=12){
  const rows=[];
  for(let i=0;i<n;i++){
    if(Math.random()<0.6){
      rows.push({
        id:"N"+String(i+1).padStart(3,'0'), name:"NAT_"+String(i+1).padStart(3,'0'), entity:"natural",
        aum_12m:randomInt(5e6,1.2e8), salary:randomInt(40e4,300e4), degree:randomPick([1,2,3,4]),
        vip_tier:randomPick(["ä¸€èˆ¬","VIP","VVIP","é«˜è³‡ç”¢"]), prod_kinds:randomInt(0,4),
        age:randomInt(25,70), occupation:randomPick(["ä¸Šç­æ—","é†«å¸«","å¾‹å¸«","ä¼æ¥­ä¸»","æ•™å¸«"]),
        crm_segment:randomPick(["é›¶å”®","é«˜è³‡ç”¢","æ•¸ä½å„ªå…ˆ"]),
        avg_dep_3m:randomInt(20e4,500e4), avg_dep_prev3m:randomInt(20e4,500e4), last_txn_days:randomInt(1,400),
        txn_amt_3m:randomInt(10e4,500e4), txn_amt_prev3m:randomInt(10e4,500e4),
        txn_cnt_3m:randomInt(10,200), txn_cnt_prev3m:randomInt(10,200),
        ebank_login_3m:randomInt(0,15), card_active_3m:randomInt(0,10), loan_util:randomFloat(0,1),
        compliance_blacklist:0
      });
    }else{
      rows.push({
        id:"C"+String(i+1).padStart(3,'0'), name:"CORP_"+String(i+1).padStart(3,'0'), entity:"corp",
        capital:randomInt(1e7,5e8), company_age_years:randomInt(1,50),
        credit_rating:randomPick(["AAA","AA","A","BBB",1,2,3,4,5]),
        biz_diversity:randomInt(1,6), industry:randomPick(["ç§‘æŠ€","è£½é€ ","é‡‘è","é›¶å”®"]),
        strategic_level:randomPick(["é«˜","ä¸­","ä½"]),
        fx_3m:randomInt(10e6,200e6), fx_prev3m:randomInt(10e6,200e6),
        corp_txn_amt_3m:randomInt(10e6,100e6), corp_txn_amt_prev3m:randomInt(10e6,100e6),
        netbank_txn:randomInt(0,50), corp_outflow_abnormal:randomPick([0,0,0,1]), compliance_blacklist:0
      });
    }
  }
  return rows;
}
function toCSVfromObjects(arr){
  const hdr=Object.keys(arr[0]); const lines=arr.map(r=>hdr.map(k=>`"${(r[k]??'')}"`).join(',')); return [hdr.join(','),...lines].join('\n');
}
el('#btnDemo').onclick=()=>{ const demo=genDemoData(18); const csv=toCSVfromObjects(demo); raw=csvParse(csv); process(); };

/* -----------------------------------------------
   8) CSV æ¬„ä½èªªæ˜ï¼ˆä¿ç•™ï¼‰
   ----------------------------------------------- */
function buildFieldGuide(){
  const box=el('#fieldGuide'); const pre=el('#csvHeaderSample'); if(!box||!pre) return;
  if(box.dataset.done==='1') return;
  const m=CFG.map; const rows=[];
  rows.push(['å¿…å¡«', m.id, 'å…±é€š', 'å®¢æˆ¶ ID']);
  rows.push(['å¿…å¡«', m.name, 'å…±é€š', 'å®¢æˆ¶åç¨±']);
  rows.push(['å¿…å¡«', m.entity, 'å…±é€š', 'å®¢ç¾¤å‹åˆ¥ï¼ˆnatural / corpï¼›å¯å¡«ã€Œè‡ªç„¶äºº/æ³•äººã€ï¼‰']);
  rows.push(['å…±é€š', m.blacklist, 'å…±é€š', 'åˆè¦é»‘åå–®(1/0 æˆ– true/false)']);
  rows.push(['è‡ªç„¶äºº', m.aum, 'è‡ªç„¶äºº', 'æŠ•è³‡ AUMï¼ˆ12Mï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.salary, 'è‡ªç„¶äºº', 'å¹´è–ª']);
  rows.push(['è‡ªç„¶äºº', m.degree, 'è‡ªç„¶äºº', 'å­¸æ­·(1~4)']);
  rows.push(['è‡ªç„¶äºº', m.vip, 'è‡ªç„¶äºº', 'VIP ç­‰ç´š']);
  rows.push(['è‡ªç„¶äºº', m.prodKinds, 'è‡ªç„¶äºº', 'ç”¢å“å¤§é¡æ•¸(å››ç·šæ»²é€)']);
  rows.push(['è‡ªç„¶äºº', m.depNow, 'è‡ªç„¶äºº', 'è¿‘3æœˆå¹³å‡å­˜æ¬¾']);
  rows.push(['è‡ªç„¶äºº', m.depPrev, 'è‡ªç„¶äºº', 'å‰3æœˆå¹³å‡å­˜æ¬¾']);
  rows.push(['è‡ªç„¶äºº', m.lastDays, 'è‡ªç„¶äºº', 'æœ€è¿‘äº¤æ˜“è·å¤©æ•¸']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_3m, 'è‡ªç„¶äºº', 'äº¤æ˜“é‡‘é¡(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_prev3m, 'è‡ªç„¶äºº', 'äº¤æ˜“é‡‘é¡(å‰3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_3m, 'è‡ªç„¶äºº', 'äº¤æ˜“ç­†æ•¸(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_prev3m, 'è‡ªç„¶äºº', 'äº¤æ˜“ç­†æ•¸(å‰3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_ebank_login_3m, 'è‡ªç„¶äºº', 'ç¶²éŠ€ç™»å…¥(è¿‘3æœˆ)']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_3m, 'è‡ªç„¶äºº', 'è¿‘3æœˆäº¤æ˜“é‡‘é¡ï¼ˆæœˆå‡ï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_amt_prev3m, 'è‡ªç„¶äºº', 'å‰3æœˆäº¤æ˜“é‡‘é¡ï¼ˆæœˆå‡ï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_3m, 'è‡ªç„¶äºº', 'è¿‘3æœˆäº¤æ˜“æ¬¡æ•¸']);
  rows.push(['è‡ªç„¶äºº', m.nat_txn_cnt_prev3m, 'è‡ªç„¶äºº', 'å‰3æœˆäº¤æ˜“æ¬¡æ•¸']);
  rows.push(['è‡ªç„¶äºº', m.nat_ebank_login_3m, 'è‡ªç„¶äºº', 'è¿‘3æœˆç¶²éŠ€ç™»å…¥æ¬¡æ•¸ï¼ˆå°‘â†’å¯èƒ½ä¼‘çœ ï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.nat_card_active_3m, 'è‡ªç„¶äºº', 'è¿‘3æœˆä¿¡ç”¨å¡æœ‰æ•ˆäº¤æ˜“æ•¸ï¼ˆå°‘â†’å¯èƒ½ä¼‘çœ ï¼‰']);
  rows.push(['è‡ªç„¶äºº', m.loan_util, 'è‡ªç„¶äºº', 'æˆä¿¡é¡åº¦ä½¿ç”¨ç‡ï¼ˆ0~1ï¼‰']);
  // è£œå……ï¼ˆå¯é¸ï¼‰
  rows.push(['å¯é¸', m.nat_age, 'è‡ªç„¶äºº', 'å¹´é½¡']);
  rows.push(['å¯é¸', m.nat_job, 'è‡ªç„¶äºº', 'è·æ¥­/è·ç¨±']);
  rows.push(['å¯é¸', m.nat_segment, 'è‡ªç„¶äºº', 'CRM å®¢ç¾¤åˆ†å±¤']);

  // æ³•äºº
  rows.push(['æ³•äºº', m.capital, 'æ³•äºº', 'è³‡æœ¬é¡']);
  rows.push(['æ³•äºº', m.years, 'æ³•äºº', 'æˆç«‹å¹´æ•¸']);
  rows.push(['æ³•äºº', m.rating, 'æ³•äºº', 'ä¼æ¥­è©•ç­‰ï¼ˆAAA/A/æ•¸å€¼ï¼‰']);
  rows.push(['æ³•äºº', m.diversity, 'æ³•äºº', 'å¾€ä¾†æ¥­å‹™å¤šæ¨£æ€§ï¼ˆå¤§é¡æ•¸ï¼‰']);
  rows.push(['æ³•äºº', m.corp_industry, 'æ³•äºº', 'ç”¢æ¥­åˆ¥']);
  rows.push(['æ³•äºº', m.corp_strategic, 'æ³•äºº', 'ç­–ç•¥æ€§ç”¢æ¥­ç­‰ç´šï¼ˆé«˜/ä¸­/ä½ï¼‰']);
  rows.push(['æ³•äºº', m.fxNow, 'æ³•äºº', 'æœ¬æœŸå¤–åŒ¯é¡ï¼ˆ3mï¼‰']);
  rows.push(['æ³•äºº', m.fxPrev, 'æ³•äºº', 'åŸºæº–å¤–åŒ¯é¡ï¼ˆå‰3mï¼‰']);
  rows.push(['æ³•äºº', m.corp_txn_amt_3m, 'æ³•äºº', 'æœ¬æœŸå…¬å¸äº¤æ˜“é‡‘é¡ï¼ˆ3mï¼‰']);
  rows.push(['æ³•äºº', m.corp_txn_amt_prev3m, 'æ³•äºº', 'å‰æœŸå…¬å¸äº¤æ˜“é‡‘é¡ï¼ˆ3mï¼‰']);
  rows.push(['æ³•äºº', m.netbank_txn, 'æ³•äºº', 'ä¼ç¶²éŠ€ç­†æ•¸ï¼ˆ3mï¼‰']);
  rows.push(['æ³•äºº', m.corp_outflow_abnormal, 'æ³•äºº', 'å°å¤–ç•°å¸¸è½‰å‡ºï¼ˆ0/1ï¼‰']);

  // ç”¢å‡ºè¡¨æ ¼
  const th = ['å¿…è¦/å°è±¡','æ¬„ä½åï¼ˆCSV è¡¨é ­ï¼‰','é©ç”¨','èªªæ˜'];
  const thead = `<thead><tr>${th.map(x=>`<th>${x}</th>`).join('')}</tr></thead>`;
  const tbody = rows.map(r=>`<tr>${r.map(x=>`<td>${x}</td>`).join('')}</tr>`).join('');
  box.innerHTML = `<table class="tbl">${thead}<tbody>${tbody}</tbody></table>`;
  box.dataset.done='1';

  // è¡¨é ­ç¯„æœ¬
  const hdr = [
    m.id,m.name,m.entity,m.blacklist,
    m.aum,m.salary,m.degree,m.vip,m.prodKinds,
    m.depNow,m.depPrev,m.lastDays,
    m.nat_txn_amt_3m,m.nat_txn_amt_prev3m,m.nat_txn_cnt_3m,m.nat_txn_cnt_prev3m,
    m.nat_ebank_login_3m,m.nat_card_active_3m,m.loan_util,
    m.capital,m.years,m.rating,m.diversity,m.corp_industry,m.corp_strategic,
    m.fxNow,m.fxPrev,m.corp_txn_amt_3m,m.corp_txn_amt_prev3m,m.netbank_txn,m.corp_outflow_abnormal
  ];
  pre.textContent = hdr.join(',');
}

/* -----------------------------------------------
   9) Page åˆ‡æ›èˆ‡æ§åˆ¶ç¶å®š
   ----------------------------------------------- */
function showPage(id){
  ['page1','page2'].forEach(pid=>{
    const sec = el('#'+pid);
    if(!sec) return;
    if(pid===id) sec.classList.remove('hidden'); else sec.classList.add('hidden');
  });
}
el('#btnGoDispatch').onclick=()=>{ showPage('page2'); renderDispatch(); };
el('#btnTableau').onclick=()=>alert('æ­¤æŒ‰éˆ•åƒ…ç¤ºæ„ï¼šå¯é€£çµè‡³å…§éƒ¨ Tableau å„€è¡¨æ¿ã€‚');

el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();

/* -----------------------------------------------
   10) Page2ï¼šæ´¾é€ï¼ˆA1/A2/B1/B2ï¼‰ with localStorage
   ----------------------------------------------- */
const DISPATCH_KEY='ait3_dispatch_v1';
function loadDispatchState(){
  try{ return JSON.parse(localStorage.getItem(DISPATCH_KEY)||'{}'); }catch(_){ return {}; }
}
function saveDispatchState(state){ localStorage.setItem(DISPATCH_KEY, JSON.stringify(state)); }
function getAssignable(){
  const allow = new Set(['HL','HM','HH','MH']); // A1/A2/B1/B2
  return enriched.filter(r=>!r.excluded && allow.has(r.cell));
}
function renderDispatch(){
  const state = loadDispatchState();
  const q = (el('#dispatchSearch')?.value||'').trim().toLowerCase();
  const rows = getAssignable().filter(r=>{
    if(!q) return true;
    const region = String(r['å€åŸŸåç¨±']||'').toLowerCase();
    const branch = String(r['åˆ†è¡Œåç¨±']||'').toLowerCase();
    const id = String(r[CFG.map.id]||'').toLowerCase();
    const nm = String(r[CFG.map.name]||'').toLowerCase();
    const rm = String(state[id]?.rm||'').toLowerCase();
    return [region,branch,id,nm,rm].some(x=>x.includes(q));
  });

  const tbl = el('#dispatchTbl');
  const head = `
    <thead><tr>
      <th><input type="checkbox" id="chkAll" /></th>
      <th>ID</th><th>åç¨±</th><th>è±¡é™</th>
      <th>å€åŸŸ</th><th>åˆ†è¡Œ</th>
      <th>æ¨è–¦R</th><th>é—œæ³¨A</th><th>æ¨¡æ“¬è²¢ç»</th>
      <th>RM æŒ‡æ´¾</th><th>ç‹€æ…‹</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
    </tr></thead>`;
  const body = document.createElement('tbody');

  for(const r of rows){
    const id = r[CFG.map.id]; const meta = CFG.labels[r.cell];
    const st = state[id]||{};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="${id}"></td>
      <td>${id}</td>
      <td>${r[CFG.map.name]||''}</td>
      <td><span class="tag">${meta.code}</span> <span class="mini muted2">${meta.title}</span></td>
      <td>${r['å€åŸŸåç¨±']||''}</td>
      <td>${r['åˆ†è¡Œåç¨±']||''}</td>
      <td>${r.R}%</td>
      <td>${r.A}%</td>
      <td>${r.revenue?fmt(Math.round(r.revenue)):''}</td>
      <td>
        <input class="rm-input" placeholder="è¼¸å…¥ RM åç¨±" value="${st.rm||''}" data-id="${id}">
      </td>
      <td>
        <select class="btn mini status" data-id="${id}">
          <option value="">æœªè™•ç†</option>
          <option ${st.status==='è¿½è¹¤'?'selected':''}>è¿½è¹¤</option>
          <option ${st.status==='æˆåŠŸ'?'selected':''}>æˆåŠŸ</option>
          <option ${st.status==='å¤±æ•—'?'selected':''}>å¤±æ•—</option>
        </select>
        <div class="mini muted2">${st.when?('æ›´æ–°ï¼š'+new Date(st.when).toLocaleString('zh-TW')):''}</div>
      </td>
      <td>
        <textarea class="noteedit" data-id="${id}" placeholder="è£œå……èªªæ˜â€¦">${st.note||''}</textarea>
      </td>
      <td>
        <button class="btn mini ghost one-assign" data-id="${id}">æŒ‡æ´¾</button>
      </td>`;
    body.appendChild(tr);
  }
  tbl.innerHTML = head;
  tbl.appendChild(body);

  // ç¶å®šäº‹ä»¶
  const chkAll = el('#chkAll');
  if(chkAll) chkAll.onchange = ()=>{ [...tbl.querySelectorAll('.rowchk')].forEach(c=>c.checked=chkAll.checked); };

  // å–®ç­†æŒ‡æ´¾
  tbl.querySelectorAll('.one-assign').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const rowEl = btn.closest('tr');
      const rm = rowEl.querySelector('.rm-input').value.trim();
      const status = rowEl.querySelector('.status').value;
      const note = rowEl.querySelector('.noteedit').value.trim();
      const s = loadDispatchState();
      s[id] = { rm, status, note, when: Date.now() };
      saveDispatchState(s);
      renderDispatch();
    };
  });
  // å³æ™‚ä¿å­˜ï¼ˆè¼¸å…¥æ¡†/é¸å–®ï¼‰
  tbl.querySelectorAll('.rm-input').forEach(inp=>{
    inp.oninput = ()=>{ const s=loadDispatchState(); const id=inp.dataset.id; s[id]={...(s[id]||{}), rm:inp.value, when:Date.now()}; saveDispatchState(s); };
  });
  tbl.querySelectorAll('.status').forEach(sel=>{
    sel.onchange = ()=>{ const s=loadDispatchState(); const id=sel.dataset.id; s[id]={...(s[id]||{}), status:sel.value, when:Date.now()}; saveDispatchState(s); renderDispatch(); };
  });
  tbl.querySelectorAll('.noteedit').forEach(ta=>{
    ta.oninput = ()=>{ const s=loadDispatchState(); const id=ta.dataset.id; s[id]={...(s[id]||{}), note:ta.value, when:Date.now()}; saveDispatchState(s); };
  });
}
function clearRMFilters(){ el('#dispatchSearch').value=''; renderDispatch(); }
function batchAssign(){
  const tbl = el('#dispatchTbl');
  const ids = [...tbl.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.id);
  if(!ids.length){ alert('è«‹å…ˆå‹¾é¸åå–®'); return; }
  const rm = prompt('è¼¸å…¥è¦æŒ‡æ´¾/æ”¹æ´¾çš„ RM åç¨±ï¼š','');
  if(rm==null) return;
  const state = loadDispatchState();
  ids.forEach(id=>{
    const tr = tbl.querySelector(`.rowchk[data-id="${id}"]`)?.closest('tr');
    const note = tr?.querySelector('.noteedit')?.value?.trim()||'';
    const status = tr?.querySelector('.status')?.value||'è¿½è¹¤';
    state[id] = { rm, status, note, when: Date.now() };
  });
  saveDispatchState(state);
  renderDispatch();
}

/* -----------------------------------------------
   11) åˆå§‹åŒ–
   ----------------------------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // å…ˆæŠŠä¹å®®æ ¼ç•«å‡ºï¼ˆå³ä½¿é‚„æ²’è¼‰å…¥è³‡æ–™ï¼‰
  render();

  // è‹¥æƒ³ä¸€é€²é å°±å¸¶ç¤ºç¯„è³‡æ–™ï¼Œå–æ¶ˆä¸‹ä¸€è¡Œè¨»è§£
  // el('#btnDemo').click();
});
</script>

