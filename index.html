<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI 潛力客智選導航｜決策矩陣 (Client-Only)</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;
      --grid-border:#2a355c;--ok:#29cc7a;--warn:#ffb84d;--bad:#ff6b6b;
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);
      color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
    .title{font-weight:700;font-size:20px;letter-spacing:.2px;margin-right:auto}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .btn,.file{background:var(--panel);color:var(--text);border:1px solid #263058;border-radius:10px;
      padding:8px 12px;cursor:pointer}
    .btn:hover{box-shadow:0 0 0 2px #1b2544 inset}
    .text{background:var(--panel);border:1px solid #263058;border-radius:10px;color:var(--text);
      padding:8px 12px;min-width:360px}
    .panel{background:rgba(17,22,42,.7);border:1px solid #233055;border-radius:16px;padding:16px;margin:14px 0}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .cell{border:1px solid var(--grid-border);border-radius:12px;padding:12px;min-height:84px;
      background:rgba(35,48,85,.25)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .ok{background:rgba(41,204,122,.2);border:1px solid var(--ok);color:#c7f7de}
    .warn{background:rgba(255,184,77,.2);border:1px solid var(--warn);color:#ffe3b3}
    .bad{background:rgba(255,107,107,.2);border:1px solid var(--bad);color:#ffd0d0}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px;border-bottom:1px solid #243056;text-align:left}
    th{position:sticky;top:0;background:#0e1428;z-index:1}
    .scroll{max-height:480px;overflow:auto;border:1px solid #233055;border-radius:12px}
    .muted{color:var(--muted)}
    .badge{padding:2px 8px;border:1px solid #39508f;border-radius:999px;background:#1a2341;font-size:12px}
    .note{font-size:12px;color:#a8b4d6;margin-top:4px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
  </style>
  <!-- CSV 解析、Excel 產出 -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">AI 潛力客智選導航｜決策矩陣</div>
    <div class="toolbar">
      <input id="csvFile" type="file" class="file" accept=".csv" />
      <button class="btn" id="btnDemo">載入示範資料</button>
      <button class="btn" id="btnClear">清空</button>
    </div>
  </header>

  <div class="panel">
    <div class="split">
      <div>
        <div class="muted" style="margin-bottom:6px">JSON 規則來源</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="rulesUrl" class="text" placeholder="貼上規則網址（ex: https://raw.githubusercontent.com/.../rules.latest.json）">
          <button class="btn" id="btnLoadRules">讀取規則</button>
          <span id="rulesStatus" class="badge">未載入規則（使用內建門檻）</span>
        </div>
        <div class="note">支援 feature 的 <code>key</code> 與 <code>aliases</code>；若 CSV 暫無對應欄位，會安全地視為 0 或不計。</div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">輸出</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnXLSX">匯出結果 Excel</button>
          <span class="note">匯出包含原始欄位 + <b>R_score, A_score, matrix_key/code/title</b>。</span>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="muted" style="margin-bottom:6px">九宮格門檻（若未載入 JSON，採此預設）</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <span class="badge">R：Hi ≥ <span id="rHi">70</span>；Mid ≥ <span id="rMid">40</span></span>
      <span class="badge">A：Hi ≥ <span id="aHi">70</span>；Mid ≥ <span id="aMid">40</span></span>
    </div>
    <div class="grid" style="margin-top:12px">
      <div class="cell"><span class="pill ok">HH → A1</span><div class="note">高推薦 × 高關注</div></div>
      <div class="cell"><span class="pill warn">HM → A2</span><div class="note">高推薦 × 中關注</div></div>
      <div class="cell"><span class="pill warn">HL → B1</span><div class="note">高推薦 × 低關注</div></div>
      <div class="cell"><span class="pill warn">MH → B2</span><div class="note">中推薦 × 高關注</div></div>
      <div class="cell"><span class="pill">MM → 一般接觸</span></div>
      <div class="cell"><span class="pill">ML → 一般接觸</span></div>
      <div class="cell"><span class="pill">LH → 一般接觸</span></div>
      <div class="cell"><span class="pill">LM → 一般接觸</span></div>
      <div class="cell"><span class="pill">LL → 一般接觸</span></div>
    </div>
  </div>

  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="muted">計算結果（已含 R/A 與矩陣）</div>
      <div class="note" id="countInfo">0 筆</div>
    </div>
    <div class="scroll"><table id="tbl"><thead></thead><tbody></tbody></table></div>
  </div>
</div>

<script>
/* ===============================
   0) 基本設定：標籤與矩陣名稱
   =============================== */
const CFG = {
  labels: {
    "HH":{code:"A1",title:"優先接觸（第1級）"},
    "HM":{code:"A2",title:"優先接觸（第2級）"},
    "HL":{code:"B1",title:"一般接觸（第1級）"},
    "MH":{code:"B2",title:"一般接觸（第1級）"},
    "MM":{code:"C1",title:"一般接觸（第2級）"},
    "ML":{code:"C2",title:"一般接觸（第2級）"},
    "LH":{code:"C3",title:"一般接觸（第2級）"},
    "LM":{code:"C4",title:"一般接觸（第2級）"},
    "LL":{code:"C4",title:"一般接觸（第2級）"},
    "Z" :{code:"Z", title:"排除（不派送）"}
  },
  cut: {R:{hi:70,mid:40}, A:{hi:70,mid:40}}
};

// 全域資料：原始 rows、加工 enriched
let raw = [];           // 由 CSV / Demo 取得
let enriched = [];      // 加工後（含 R/A/matrix）
let RULES = {loaded:false, matrix:null, nat:[], corp:[]}; // JSON 規則

/* ===============================
   1) 小工具
   =============================== */
const $ = sel => document.querySelector(sel);
const byKeys = (obj, order) => {
  const out={}; for(const k of order){ if(k in obj) out[k]=obj[k]; }
  for(const k of Object.keys(obj)){ if(!(k in out)) out[k]=obj[k]; }
  return out;
};
function render(){
  const tbl = $("#tbl"), thead=tbl.tHead||tbl.createTHead(), tbody=tbl.tBodies[0]||tbl.createTBody();
  tbody.innerHTML = ""; thead.innerHTML = "";
  if(!enriched.length){ $("#countInfo").textContent="0 筆"; return; }

  const cols = Object.keys(enriched[0]);
  // 置頂常用欄位
  const headOrder = ['id','name','entity','entity_text','R','A','cell','cell_code','cell_title'];
  const orderedCols = cols.sort((a,b)=> headOrder.indexOf(a)===-1? (headOrder.indexOf(b)===-1?0:1) : -1);

  const tr = thead.insertRow();
  orderedCols.forEach(k=>{ const th=document.createElement('th'); th.textContent=k; tr.appendChild(th); });

  for(const r of enriched){
    const row = tbody.insertRow();
    for(const k of orderedCols){
      const td = row.insertCell();
      td.textContent = (r[k]??"");
    }
  }
  $("#countInfo").textContent = `${enriched.length} 筆`;
}

/* ===============================
   2) CSV 載入（檔案或 Demo）
   =============================== */
$("#csvFile").addEventListener("change", ev=>{
  const f = ev.target.files?.[0]; if(!f) return;
  Papa.parse(f, {
    header:true, skipEmptyLines:true, dynamicTyping:true,
    complete: (res)=>{
      raw = res.data.map(normalizeRow);
      process();
    }
  });
});

$("#btnDemo").onclick = ()=>{
  // 簡易示範 12 筆（自然人 / 法人 各 6），欄位與映射一致
  const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
  const N=6, C=6; const out=[];
  for(let i=0;i<N;i++){
    out.push({
      id:`N${String(i+1).padStart(3,'0')}`, name:`NAT_${String(i+1).padStart(3,'0')}`, entity:"natural",
      avg_dep_3m: Math.floor(Math.random()*12_000_00)/100,  // 月均存款(3m)
      avg_dep_prev3m: Math.floor(Math.random()*12_000_00)/100,
      last_txn_days: Math.floor(Math.random()*180),
      salary: Math.floor(Math.random()*2_000_000)+400_000,
      prod_kinds: Math.floor(Math.random()*6)+1,
      loan_util: Math.floor(Math.random()*100),             // 本期放款動用率(%) 0~100
      _loan_util_prev: Math.floor(Math.random()*100),       // 上期 (示範)
      ebank_login_3m: Math.floor(Math.random()*40),
      compliance_blacklist: 0
    });
  }
  for(let i=0;i<C;i++){
    out.push({
      id:`C${String(i+1).padStart(3,'0')}`, name:`CORP_${String(i+1).padStart(3,'0')}`, entity:"corp",
      company_age_years: Math.floor(Math.random()*30)+1,
      corp_txn_amt_3m: Math.floor(Math.random()*50_000_000),
      biz_diversity: Math.floor(Math.random()*6)+1,
      credit_rating: pick(['A','BBB','BB','B']),
      avg_dep_3m: Math.floor(Math.random()*30_000_00)/100,
      avg_dep_prev3m: Math.floor(Math.random()*30_000_00)/100,
      fx_3m: Math.floor(Math.random()*3_000_000),
      fx_prev3m: Math.floor(Math.random()*3_000_000),
      compliance_blacklist: 0
    });
  }
  raw = out.map(normalizeRow);
  process();
};

$("#btnClear").onclick = ()=>{
  raw=[]; enriched=[]; render();
};

/* ===============================
   3) 規則載入（支援 key 與 aliases）
   =============================== */
async function loadRules(url){
  if(!url){ alert('請先填 JSON 規則網址'); return; }
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    const j = await r.json();
    RULES.matrix = j?.matrix || null;
    RULES.nat    = (j?.natural?.features||[]).map(withAliases);
    RULES.corp   = (j?.corporate?.features||[]).map(withAliases);
    RULES.loaded = true;
    $("#rulesStatus").textContent = '已載入規則（依 JSON 權重計分）';
    // 若 JSON 有 cut，覆蓋 UI 門檻顯示
    const cut = RULES.matrix?.cut;
    if(cut){
      $("#rHi").textContent = cut.R?.hi ?? 70;
      $("#rMid").textContent = cut.R?.mid ?? 40;
      $("#aHi").textContent = cut.A?.hi ?? 70;
      $("#aMid").textContent = cut.A?.mid ?? 40;
    }
    process();
  }catch(e){
    console.error(e);
    alert('讀取規則失敗，維持內建門檻。');
  }
}
$("#btnLoadRules").onclick = ()=> loadRules($("#rulesUrl").value?.trim());

function withAliases(f){
  return {...f, aliases: Array.isArray(f.aliases)? f.aliases.map(x=>String(x).trim()):[]};
}

/* ===============================
   4) 欄位正規化與映射
   - 這層做「EDW/CSV 欄位名 → 統一內部鍵」的對齊
   - 若你 CSV 欄名日後更動，只要改這裡
   =============================== */
function normalizeRow(r){
  // 統一必要欄位（id/name/entity）
  const entity = (String(r.entity||r.ENTITY||r.ENTITY_TYPE||'natural').toLowerCase().includes('corp')) ? 'corp' : 'natural';
  return {
    ...r,
    id: r.id ?? r.CUST_ID ?? r.customer_id ?? '',
    name: r.name ?? r.CUST_NAME ?? r.customer_name ?? '',
    entity
  };
}

// JSON feature.key → CSV 欄位名對應（可依你 EDW 對齊調整）
const NAT_FIELD_MAP = {
  // === 自然人 ===
  "annual_income":"salary",
  "product_diversity_score":"prod_kinds",
  "avg_balance_qoq_change":"avg_dep_3m",     // 會用 (avg_dep_3m - avg_dep_prev3m)
  "days_since_last_txn":"last_txn_days",
  // 你先前改名：放款額度動用率變化 → 個人放款_額度動用變化率
  // 若 JSON 將 key 改成「個人放款_額度動用變化率」，請把該名稱加到 feature.aliases
  "loan_util_change_pp":"_loan_util_pp",
  "credit_util_change_pp":null,              // 自然人已刪除此欄 → 不計
  "ebank_interactions_3m_yoy":null,          // 缺去年同期 → 先 0
  "txn_freq_change":null,                    // 同上
  "edd_uncooperative":null,
  "compliance_exclusion":"compliance_blacklist"
};

const CORP_FIELD_MAP = {
  // === 法人 ===
  "annual_turnover":"corp_txn_amt_3m",
  "company_age":"company_age_years",
  "strategic_industry":null,                 // 若是 Y/N，請在 CSV 提供欄位或在 JSON 換規則型別
  "corp_credit_rating":"credit_rating",
  "product_diversity_score":"biz_diversity",
  "avg_balance_qoq_change":"avg_dep_3m",
  // 你先前改名：放款額度動用率變化/授信額度動用率變化 → 企金放款_額度動用率 / 企金授信_額度動用率（本期）
  // 若 JSON 用新名，請把新名放 aliases；這裡示範以變化率（pp）需要「本期−上期」才算，CSV 如無上期→先 0
  "loan_util_change_pp":null,
  "credit_util_change_pp":null,
  "fx_turnover_change":"_fx_turnover_pct",   // 由 fx_3m / fx_prev3m 推導
  "ebank_interactions_3m_yoy":null,
  "edd_uncooperative":null,
  "compliance_exclusion":"compliance_blacklist"
};

// 給打分階段取值（支援 key 或 aliases）
function valOf(rec, feature, entity){
  const key = resolveKey(feature, entity);
  // 特例處理
  if(key==="avg_balance_qoq_change"){
    const now = +rec['avg_dep_3m']||0, prev = +rec['avg_dep_prev3m']||0;
    return now - prev; // 金額差
  }
  if(key==="loan_util_change_pp"){
    const now = +rec['loan_util']; const prev= +rec['_loan_util_prev']||now;
    if(!(now===now)) return 0;
    return (now - prev); // 已是百分點差（本期% − 上期%）
  }
  if(key==="fx_turnover_change"){
    const now=+rec['fx_3m']||0, prev=+rec['fx_prev3m']||0;
    return prev>0? (now-prev)/prev : 0; // 比例變化
  }
  const map = entity==='corp'? CORP_FIELD_MAP : NAT_FIELD_MAP;
  const col = map[key] ?? null;
  if(!col) return null;
  const v = rec[col];
  if(v===''||v==null) return null;
  // 自動轉數值
  return (+v===+v)? +v : v;
}

function resolveKey(feature, entity){
  // 先嘗試 feature.key，在 FIELD_MAP 是否存在；否則試 aliases
  const base = feature.key;
  const map = entity==='corp'? CORP_FIELD_MAP : NAT_FIELD_MAP;
  if(base in map || base==="avg_balance_qoq_change" || base==="loan_util_change_pp" || base==="fx_turnover_change") return base;
  for(const alias of (feature.aliases||[])){
    if(alias in map) return alias;
    // 允許常見中文別名（去空白）
    const a = String(alias).trim();
    if(a in map) return a;
  }
  // 找不到就回原 key（可能是純邏輯特例）
  return base;
}

/* ===============================
   5) JSON 驅動打分（完整型別）
   =============================== */
const binsAmt=(v,b)=>{ if(v==null||!b?.length) return 0; let x=+v; for(const [th,sc] of [...b].sort((a,b)=>b[0]-a[0])) if(x>=+th) return +sc; return +b[b.length-1][1]; };
const stepGE =(v,s)=>{ if(v==null||!s?.length) return 0; let x=+v; for(const [th,sc] of [...s].sort((a,b)=>b[0]-a[0])) if(x>=+th) return +sc; return 0; };
const amtDiff=(v,up,dn)=> (v>0? [binsAmt(v,up),0] : v<0? [0,binsAmt(Math.abs(v),dn)] : [0,0]);
const binsDays=(v,r)=>{ if(v==null) return 0; let x=+v; for(const [lo,hi,sc] of r||[]) if((lo??-1e99)<=x && x<(hi??1e99)) return +sc; return 0; };
const binsPP  =(v,up,dn,th=0)=>{ if(v==null) return [0,0]; let x=+v; if(Math.abs(x)<+th) return [0,0]; return x>0? [binsAmt(x,up),0] : [0,binsAmt(Math.abs(x),dn)]; };
const binsPct =(v,gr,de,capUp=null,capDn=null)=>{ if(v==null) return [0,0]; let x=+v; if(capUp!=null) x=Math.min(x,+capUp); if(capDn!=null) x=Math.max(x,+capDn); return x>0? [binsAmt(x,gr),0] : x<0? [0,binsAmt(Math.abs(x),de)] : [0,0]; };
const rangesInc=(v,rg)=>{ if(v==null) return 0; let x=+v; for(const [lo,hi,sc] of rg||[]) if(+lo<=x && x<=+hi) return +sc; return 0; };
const catMap  =(v,map,unk=0)=> map?.[String(v).trim()] ?? +unk;

function scoreByJson(rec, entity){
  const feats = (entity==='corp')? RULES.corp : RULES.nat;
  let Rnum=0, Aden=0, Anum=0, Rden=0, Z=false;
  for(const f of feats){
    const sc = f?.score||{}; const w = +f?.weight||0; const tp = String(sc.type||'').toLowerCase();

    // 排除規則（Z）
    if(tp==='binary_exclude' || f.key==='compliance_exclusion'){
      const v = valOf(rec, f, entity);
      const yes = String(v).toUpperCase();
      if(['1','Y','TRUE'].includes(yes)) Z=true;
      continue;
    }

    let r=0,a=0;
    const v = valOf(rec, f, entity);
    if(v==null){ r=0; a=0; }
    else if(tp==='numeric_bins_amt'){
      const tgt=(sc.target||'R').toUpperCase(); const scv=binsAmt(v, sc.bins||[]);
      r = (tgt==='R')? scv:0; a = (tgt==='A')? scv:0;
    }else if(tp==='numeric_step_ge'){
      const tgt=(sc.target||'R').toUpperCase(); const scv=stepGE(v, sc.steps||[]);
      r = (tgt==='R')? scv:0; a = (tgt==='A')? scv:0;
    }else if(tp==='numeric_bins_amt_diff'){
      [r,a] = amtDiff(v, sc.up_bins_twd||[], sc.down_bins_twd||[]);
    }else if(tp==='numeric_bins_days'){
      const tgt=(sc.target||'A').toUpperCase(); const scv=binsDays(v, sc.ranges||[]);
      r = (tgt==='R')? scv:0; a = (tgt==='A')? scv:0;
    }else if(tp==='numeric_bins_pp'){
      [r,a] = binsPP(v, sc.bins_up||[], sc.bins_down||[], sc.no_score_below_pp||0);
    }else if(tp==='numeric_bins_pct'){
      const cap=sc.guards?.cap_pct||{}; [r,a] = binsPct(v, sc.growth_bins||[], sc.decline_bins||[], cap.up, cap.down);
    }else if(tp==='numeric_ranges'){
      const tgt=(sc.target||'R').toUpperCase(); const scv=rangesInc(v, sc.ranges||[]);
      r = (tgt==='R')? scv:0; a = (tgt==='A')? scv:0;
    }else if(tp==='categorical_map'){
      const tgt=(sc.target||'R').toUpperCase(); const scv=catMap(v, sc.mapping||{}, sc.unknown_default||0);
      r = (tgt==='R')? scv:0; a = (tgt==='A')? scv:0;
    }

    if(w>0){
      Rnum += w*r; Rden += (r>0? w:0);
      Anum += w*a; Aden += (a>0? w:0);
    }
  }
  const R = Rden>0? Math.round(Math.min(Math.max((Rnum/Rden)*100,0),100)) : 0;
  const A = Aden>0? Math.round(Math.min(Math.max((Anum/Aden)*100,0),100)) : 0;
  return {R,A,Z};
}

/* ===============================
   6) 主流程：依 JSON（若已載入）計分，否則用內建門檻
   =============================== */
function decideCellByCut(R,A,cut){
  const rc = R>=cut.R.hi? 'H' : R>=cut.R.mid? 'M' : 'L';
  const ac = A>=cut.A.hi? 'H' : A>=cut.A.mid? 'M' : 'L';
  return rc+ac;
}

function process(){
  if(!raw?.length){ enriched=[]; render(); return; }

  const cut = RULES.loaded && RULES.matrix?.cut ? RULES.matrix.cut : CFG.cut;
  const labels = RULES.loaded && RULES.matrix?.labels ? RULES.matrix.labels : CFG.labels;

  enriched = raw.map(rec=>{
    const entity = (rec.entity==='corp')?'corp':'natural';

    // 1) 若有 JSON 規則就用 JSON 計分；否則 fallback：R/A皆0（讓你避免內建等權算法；一切以 JSON 為主）
    let R=0, A=0, Z=false;
    if(RULES.loaded){
      const s = scoreByJson(rec, entity);
      R = s.R; A = s.A; Z = s.Z;
    }else{
      R=0; A=0; Z = !!rec.compliance_blacklist;
    }

    // 2) 矩陣定位
    const key = Z? 'Z' : decideCellByCut(R,A,cut);
    const meta = labels[key] || {code:'MM', title:'一般接觸（第2級）'};

    // 3) 輸出欄位（保留原欄位 + 新欄位）
    const base = {...rec};
    return byKeys({
      ...base,
      entity_text: (entity==='corp'?'法人':'自然人'),
      R, A,
      cell:key, cell_code:meta.code, cell_title:meta.title,
      excluded: !!Z
    }, ['id','name','entity','entity_text','R','A','cell','cell_code','cell_title', ...Object.keys(base)]);
  });

  render();
}

/* ===============================
   7) 匯出 Excel
   =============================== */
function exportXLSX(){
  if(!enriched?.length){ alert('沒有資料可匯出'); return; }
  const rows = enriched.map(r=>{
    const base = {...r};
    delete base.excluded;
    return base;
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  // 欄寬
  ws['!cols'] = Object.keys(rows[0]).map(()=>({wch:14}));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'decision_result');
  XLSX.writeFile(wb, 'decision_matrix_result.xlsx');
}
$("#btnXLSX").onclick = exportXLSX;
</script>
</body>
</html>
