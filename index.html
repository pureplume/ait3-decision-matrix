<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI 潛力客智選導航｜決策矩陣 (Client-Only)</title>
<style>
  :root{ --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;--grid-border:#2a355c;}
  html,body{height:100%;}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .hero{display:flex;gap:20px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
  h1{font-size:28px;margin:4px 0 8px}
  p.muted{color:var(--muted);margin:0}
  .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  input[type=file]{display:none}
  label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
  .kv{display:flex;gap:10px;align-items:center}
  .kv .k{color:#98a8c6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  footer{opacity:.7;margin:24px 0 40px}

  /* ======= 矩陣（左：推薦；上：關注） ======= */
  :root{ --side-w:56px;--head-h:56px;--col-w-L:1fr;--col-w-M:1fr;--col-w-H:1fr;--row-h-H:112px;--row-h-M:112px;--row-h-L:112px;}
  .matrix-wrapper{
    display:grid;
    grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
    grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
    border:1px solid var(--grid-border);border-radius:12px;overflow:hidden;background:#fff;
  }
  .matrix-header,.matrix-side{
    display:flex;align-items:center;justify-content:center;background:#f5f7fa;color:#000;font-weight:700;
    border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);
  }
  .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;background:#fff;}
  .cell h4{margin:0 0 6px;font-size:14px;color:#000}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
  .num{font-size:22px;font-weight:700;color:#000}
  .cell-A1{background:#f57c00;} .cell-A2{background:#fbc02d;} .cell-B1{background:#f57c00;}
  .cell-C1,.cell-C2,.cell-C3,.cell-C4,.cell-C5{background:#fff176;} .cell-B2{background:#fbc02d;}

  /* Z 合規排除列 */
  .zbar{margin-top:8px;background:#f5f7fa;color:#000;border:1px solid var(--grid-border);border-radius:8px;padding:10px;text-align:center;font-weight:700;cursor:pointer;}

  /* 表格 */
  .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left}
  .tbl th{background:#0f1733;color:#a9b9db;position:sticky;top:0}

  /* 派送頁 */
  .dispatch-wrap{max-width:1280px;margin:24px auto;padding:0 16px}
  .dispatch-card{background:#f3f6ff;border:1px solid #b9c6eb;border-radius:10px;padding:10px;margin-bottom:12px;color:#00123a}
  .dispatch-toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .dispatch-toolbar .step{display:flex;align-items:center;gap:8px;background:#e8eeff;border:1px solid #b9c6eb;border-radius:8px;padding:6px 10px}
  .dispatch-search{flex:1;min-width:260px}
  .dispatch-search input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #c7d2f0;background:#fff}
  .dispatch-table{width:100%;border-collapse:collapse;background:#fff;border:2px solid #9fb3e8}
  .dispatch-table th,.dispatch-table td{border:1px solid #9fb3e8;padding:8px 10px;vertical-align:top;color:#00123a;background:#fff}
  .dispatch-table th{background:#e8eeff;font-weight:700;text-align:center}
  .mini{font-size:12px;color:#33405e}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #c7d2f0;background:#eef3ff;font-weight:600}
  .muted2{color:#62739c}
  .btn.ghost{background:#e9eeff;color:#132a7a;border:1px solid #b9c6eb}
  .hidden{display:none!important;}
  .err{background:#2b0f14;border:1px solid #7a2633;color:#ffd8df;padding:10px 12px;border-radius:10px;margin:10px 0}
</style>
</head>
<body>

<section id="page1" style="display:block">
  <div class="wrap">
    <div class="hero">
      <span class="badge"><svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3 7 7 .5-5.5 4.8 1.7 7.2L12 17l-6.2 4.5 1.7-7.2L2 9.5 9 9z"/></svg> AI 潛力客智選導航</span>
      <div>
        <h1>開發潛力名單決策矩陣</h1>
        <p class="muted">瀏覽器端 <b>只讀取你的 JSON 規則</b>（不在前端打分），依 R/A 切點分群並顯示。</p>
      </div>
    </div>

    <div id="errBox"></div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvRaw">📄 匯入 <b>原始資料</b> CSV（UTF-8）</label>
        <input id="csvRaw" type="file" accept=".csv" />
        <label class="file" for="csvScored">📄 匯入 <b>ETL後評分</b> CSV（含 R/A）</label>
        <input id="csvScored" type="file" accept=".csv" />
        <button class="btn" id="btnClear">清空</button>
        <div class="right kv"><span class="k">有效筆數（已分群，不含 Z）：</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice">
          <b>兩種匯入：</b>① 原始（無 R/A）→ 顯示 Z 與「未評分」；② ETL 後評分（含 R/A）→ 依 JSON 的 cut/labels 分群。
        </div>
      </div>
      <details id="guideDetails" style="margin-top:10px">
        <summary class="btn">CSV 欄位說明與範本（點我展開）</summary>
        <div id="fieldGuide" style="margin-top:10px"></div>
      </details>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">九宮格決策摘要</h3><button class="btn right" id="btnDownload">匯出結果 CSV</button></div>

        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header" id="ahL">關注低</div>
          <div class="matrix-header" id="ahM">關注中</div>
          <div class="matrix-header" id="ahH">關注高</div>

          <div class="matrix-side" id="rhH">推薦高</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side" id="rhM">推薦中</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side" id="rhL">推薦低</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>

        <div class="zbar" id="zBar"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">篩選</h3>
        <div class="chips" id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">客群類型：</span>
            <select id="selEntity" class="btn">
              <option value="auto">自動（依 CSV/欄位推斷）</option>
              <option value="natural">自然人</option>
              <option value="corp">法人</option>
            </select>
          </label>
          <label class="kv"><span class="k">顯示筆數：</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>全部</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="row" style="margin:16px 0 0 0">
      <button class="btn" id="btnGoDispatch">📌 潛力名單派送</button>
      <button class="btn ghost" id="btnTableau">📊 Tableau</button>
      <span class="muted2 mini">（僅 A1/A2/B1/B2 派送）</span>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">計算結果</h3>
      <div style="max-height:360px;overflow:auto">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>© 2025 AIT3 Demo • Client-Only • 無資料上傳</footer>
  </div>
</section>

<section id="page2" class="hidden">
  <div class="dispatch-wrap">
    <div class="row" style="margin-bottom:8px">
      <button class="btn" onclick="showPage('page1')">← 返回首頁矩陣</button>
      <div class="right mini muted2">僅顯示 A1 / A2 / B1 / B2；RM 狀態與註記儲存在瀏覽器 <b>localStorage</b></div>
    </div>

    <div class="dispatch-card">
      <div class="dispatch-toolbar">
        <div class="dispatch-search"><input id="dispatchSearch" type="search" placeholder="🔎 搜尋 區域/分行/RM/客戶ID/名稱/代碼..." oninput="renderDispatch()"></div>
        <div class="step"><b>＊批次指派/改派：</b> <span class="mini">① 選取名單 → ② 指派 RM</span></div>
        <button class="btn" onclick="batchAssign()">批次指派/改派</button>
        <button class="btn ghost" onclick="clearRMFilters()">清除篩選</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table class="dispatch-table" id="dispatchTbl"></table>
    </div>
  </div>
</section>

<script>
/* -----------------------------------------------
   0) 只讀單一規則 JSON（不在前端打分）
   ----------------------------------------------- */
const RULES_URL = 'https://raw.githubusercontent.com/pureplume/ait3-rules/refs/heads/main/rules.latest.json';
let RULES = null;        // 成功載入後：{ cut, labels, mapping, edw_order? }
let CURRENT_HEADERS = []; // 目前 CSV 的表頭（用於對齊檢查）

// 骨架代碼（UI 顯示用；不是規則）
const CELL_CODE = {HL:'A1',HM:'A2',HH:'B1',ML:'C1',MM:'C2',MH:'B2',LL:'C3',LM:'C4',LH:'C5'};

function warn(msg){
  document.getElementById('errBox').innerHTML = '<div class="err">⚠️ '+ msg +'</div>';
}
function clearWarn(){ document.getElementById('errBox').innerHTML=''; }

async function loadRules(){
  try{
    const res = await fetch(RULES_URL, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const raw = await res.json();

    // 嘗試在不同層級找需要的鍵
    const pick = (o,p)=>p.split('.').reduce((x,k)=>x&&x[k], o);
    const candidate = [raw, pick(raw,'rules'), pick(raw,'matrix'), pick(raw,'decision'), pick(raw,'config')]
      .find(x=>x && (x.cut || x.labels || x.mapping));

    if(!candidate) throw new Error('未找到 cut/labels/mapping 節點');

    const {cut, labels, mapping} = candidate;
    if(!cut || !labels || !mapping?.core) throw new Error('JSON 缺少必要鍵（cut/labels/mapping.core）');

    RULES = {
      cut, labels, mapping,
      edw_order: candidate.edw_order || {natural:[], corp:[]}
    };
    clearWarn();
  }catch(e){
    // 僅顯示警示；UI 維持可用（骨架模式，前端仍不打分）
    warn('規則載入失敗：' + e.message + '。請確認 URL 與檔案內容。');
    RULES = null;
  }
}

/* -----------------------------------------------
   1) 小工具（含 CSV 解析增強）
   ----------------------------------------------- */
const el = sel => document.querySelector(sel);
const fmt = n => (typeof n==='number'&&Number.isFinite(n))? n.toLocaleString('zh-TW') : (n??'');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const isNum = v => typeof v==='number' && Number.isFinite(v);
const asNum = v => {
  if(v===''||v==null) return NaN;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/[,%\s]/g,'')); // 允許千分位與 %
};
// 去除 BOM 與內嵌換行
const normHeader = h => String(h||'').replace(/^\uFEFF/,'').replace(/\r?\n/g,'').trim();

// 用於模糊比對鍵名（把空白、斜線、括號等拿掉）
function kNorm(s){
  return String(s||'').toLowerCase()
    .replace(/\uFEFF/g,'')
    .replace(/\r?\n/g,'')
    .replace(/[\s_()（）\-]/g,'')
    .replace(/[\/\\]/g,'/')
    .trim();
}

// 解析 CSV（支援帶引號欄名內含換行）
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false;
  const push=()=>{row.push(field);field=''}; const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++];
    if(q){ if(c==='"'){ if(text[i]==='"'){field+='"';i++;} else q=false; }
          else field+=c; continue; }
    if(c==='"'){ q=true; continue; }
    if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; }
    if(c==='\r'){ continue; }
    field+=c;
  }
  push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  const headers = hdr.map(normHeader);
  CURRENT_HEADERS = headers;
  return rows.filter(r=>r.some(x=>x!=='')).
    map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}

/* -----------------------------------------------
   2) 只依 JSON cut 進行「分群」，前端不打分
   ----------------------------------------------- */
function decideCell(R,A){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac;
}

// 動態解析 core 欄位（若 JSON 不在：用常見同義欄位）
function resolveCore(){
  if(RULES?.mapping?.core) return RULES.mapping.core;

  // 針對你提供的 CSV：客戶代號 / 名稱可能沒有，就用 ID 代替
  const hset = new Map(CURRENT_HEADERS.map(h=>[kNorm(h),h]));
  const pick = (...cands)=>{ for(const c of cands){ const k=hset.get(kNorm(c)); if(k) return k; } return cands[0]; };

  return {
    id: pick('客戶代號','客戶ID','id','客編'),
    name: pick('客戶名稱','公司名稱','名稱','name','客戶代號'),
    entity: pick('自然人/非自然人','客群','entity'),
    blacklist: pick('合規黑名單','黑名單','不配合盡職審查','不配合\n盡職審查','blacklist')
  };
}

// 只接受 ETL 已產出的 R/A（欄名可由 JSON mapping.score 覆寫）
// 若 JSON 暫時不可用，會嘗試常見同義詞（不算規則，只是欄名別名）
function pickRA(rec){
  const mapScore = RULES?.mapping?.score || {};
  const keyR = mapScore.R || null;
  const keyA = mapScore.A || null;

  const keys = Object.keys(rec);
  const idx = new Map(keys.map(k=>[kNorm(k),k]));

  const tryFind = (given, fallbacks)=>{
    if(given && (given in rec)) return given;
    if(given && idx.has(kNorm(given))) return idx.get(kNorm(given));
    for(const fb of fallbacks){
      if(fb in rec) return fb;
      const k = idx.get(kNorm(fb)); if(k) return k;
    }
    return null;
  };

  const rKey = tryFind(keyR, ['R','推薦R','推薦','加權推薦分數','R分數','r_score']);
  const aKey = tryFind(keyA, ['A','關注A','關注','加權關注分數','A分數','a_score']);

  if(!rKey || !aKey) return null;
  const R = asNum(rec[rKey]), A = asNum(rec[aKey]);
  if(!isNum(R) || !isNum(A)) return null;
  return {R: clamp(R,0,100), A: clamp(A,0,100)};
}

// 合規排除
function isExcluded(rec){
  const core = resolveCore();
  const v = String(rec[core.blacklist]||'');
  return /^(1|true|y|是)$/i.test(v);
}

// 推斷客群（只影響顯示）
function inferEntity(rec){
  const core = resolveCore();
  const v = (rec[core.entity]??'').toString();
  const alias = {'自然人':'natural','個人':'natural','法人':'corp','公司':'corp'};
  const e = alias[v] || v.toLowerCase();
  if(e==='natural'||e==='corp') return e;
  // 粗略判斷：有法人常見欄位就當 corp
  const hintKeys = ['公司營收','成立年限','策略性產業別(ETL)','客戶等級/授信等級','客戶往來業務類別'];
  return hintKeys.some(k=>k in rec)? 'corp':'natural';
}

/* -----------------------------------------------
   3) 主流程
   ----------------------------------------------- */
let dataRows=[], enriched=[], viewFilter='ALL';

function process(){
  const forced = el('#selEntity').value; // auto/natural/corp
  const core = resolveCore();

  enriched = dataRows.map(rec=>{
    const entity = (forced==='auto')? inferEntity(rec) : forced;
    const excluded = isExcluded(rec);
    const ra = pickRA(rec);
    const R = ra? ra.R : null;
    const A = ra? ra.A : null;
    const cell = (excluded || !ra)? null : decideCell(R, A);
    return { ...rec, entity, excluded, R, A, cell };
  });

  render();
  if(!el('#page2').classList.contains('hidden')) renderDispatch();
}

/* -----------------------------------------------
   4) 首頁渲染 + cut 區間 + Z
   ----------------------------------------------- */
function applyHeadersFromCuts(){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  el('#ahL').textContent = `關注低 (<${c.A.mid})`;
  el('#ahM').textContent = `關注中 (${c.A.mid}–${c.A.hi-1})`;
  el('#ahH').textContent = `關注高 (≥${c.A.hi})`;
  el('#rhH').textContent = `推薦高 (≥${c.R.hi})`;
  el('#rhM').textContent = `推薦中 (${c.R.mid}–${c.R.hi-1})`;
  el('#rhL').textContent = `推薦低 (<${c.R.mid})`;
}

function render(){
  applyHeadersFromCuts();

  const LAB = RULES?.labels;
  const byCell = groupBy(enriched.filter(r=>!r.excluded && r.cell), r=>r.cell);
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];

  for(const key of order){
    const code = LAB ? LAB[key].code : CELL_CODE[key];
    const title = LAB ? LAB[key].title : ''; // 骨架模式不顯示文案
    const count=(byCell[key]||[]).length;
    const box=el('#cell-'+key); if(!box) continue;
    box.className=`cell cell-${code}`;
    box.innerHTML=`<h4>${code}｜${title}</h4>
      <div class="row"><span class="pill">筆數</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  }

  const zCount = enriched.filter(r=>r.excluded).length;
  const zbar = el('#zBar');
  if(zbar){
    const zTitle = (LAB && LAB.Z && LAB.Z.title) || '合規排除';
    zbar.innerHTML = `Z｜${zTitle}　•　筆數 <span class="num">${fmt(zCount)}</span>`;
    zbar.onclick = ()=>{ viewFilter='Z'; renderTable(); highlightFilter(); };
  }

  // 篩選按鈕
  const f=el('#filters'); f.innerHTML='';
  const all=document.createElement('button'); all.className='btn'; all.textContent='顯示全部';
  all.onclick=()=>{viewFilter='ALL'; renderTable(); highlightFilter();}; f.appendChild(all);
  for(const key of order){
    const code = LAB ? LAB[key].code : CELL_CODE[key];
    const b=document.createElement('button'); b.className='btn'; b.textContent=code;
    b.onclick=()=>{viewFilter=key; renderTable(); highlightFilter();}; f.appendChild(b);
  }
  const bz=document.createElement('button'); bz.className='btn'; bz.textContent='Z';
  bz.onclick=()=>{viewFilter='Z'; renderTable(); highlightFilter();}; f.appendChild(bz);

  highlightFilter();
  renderTable();
}

function highlightFilter(){
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH','Z'];
  const btns=[...document.querySelectorAll('#filters .btn')];
  btns.forEach(b=>b.style.outline='none');
  const idx=['ALL',...order].indexOf(viewFilter);
  if(idx>=0 && btns[idx]) btns[idx].style.outline='2px solid var(--brand)';
}

function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['ID','名稱','客群','R(推薦)','A(關注)','矩陣','模擬貢獻'];
  const core = resolveCore();

  let rows;
  if(viewFilter==='Z') rows = enriched.filter(r=>r.excluded);
  else if(viewFilter==='ALL') rows = enriched.filter(r=>!r.excluded);
  else rows = enriched.filter(r=>!r.excluded && r.cell===viewFilter);

  const limit=el('#selPage').value==='全部'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');

  for(const r of rows.slice(0,limit)){
    const LAB = RULES?.labels;
    const code = LAB ? (LAB[r.cell]?.code||'') : (CELL_CODE[r.cell]||'');
    const title = LAB ? (LAB[r.cell]?.title||'') : (r.cell? '' : '未評分');
    const isZ = !!r.excluded;
    const entityTxt = r.entity==='corp'?'法人':'自然人';

    const vals = [
      r[core.id],
      r[core.name],
      entityTxt,
      isNum(r.R)? r.R : '',
      isNum(r.A)? r.A : '',
      isZ ? `Z｜合規排除` : (r.cell? `${code}｜${title||'未評分'}` : '未評分'),
      ''
    ];
    const tr=document.createElement('tr');
    tr.innerHTML = vals.map((v,i)=>`<td>${(i===3||i===4) && v!==''? (v+'%') : (v??'')}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);

  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded && r.cell).length);
}

function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

/* -----------------------------------------------
   5) 匯入 / 匯出（原始、ETL兩種）
   ----------------------------------------------- */
function toCSV(arr){
  if(!arr.length) return '';
  const core = resolveCore();
  const cols=['id','name','entity','R','A','cell'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded && r.cell).map(r=>[
    r[core.id], r[core.name], r.entity, r.R, r.A, r.cell
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};

async function handleCsvInput(file){
  if(!file) return;
  const text=await file.text();
  dataRows=csvParse(text);
  // 檢查表頭對齊
  headerCheck();
  process();
}

// 原始資料（可能無 R/A）
el('#csvRaw').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));
// ETL 後評分（需含 R/A）
el('#csvScored').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));

el('#btnClear').onclick=()=>{ dataRows=[]; enriched=[]; render(); el('#csvRaw').value=''; el('#csvScored').value=''; };

/* -----------------------------------------------
   6) CSV 欄位說明（動態生成；會檢查 EDW 對齊）
   ----------------------------------------------- */
function buildFieldGuide(){
  const box = el('#fieldGuide'); if(!box) return;

  // 讀規則（若尚未成功，顯示骨架）
  if(!RULES){
    const core = resolveCore();
    box.innerHTML = `
      <div class="notice">
        <div><b>規則尚未成功載入</b>（僅顯示最小欄位建議）。</div>
        <ul>
          <li>必填：<code>${core.id}</code>、<code>${core.name}</code></li>
          <li>建議：<code>${core.entity}</code>、<code>${core.blacklist}</code></li>
          <li>ETL 後評分：<code>R</code>、<code>A</code>（或 <code>加權推薦分數</code>、<code>加權關注分數</code>）</li>
        </ul>
      </div>`;
    return;
  }

  const m=RULES.mapping.core;
  const ordNat = RULES.edw_order?.natural || [];
  const ordCorp = RULES.edw_order?.corp || [];

  const mk = (type, name, scope, desc, ok)=>`<tr>
    <td>${type}</td><td>${name}${ok? ' ✅':''}</td><td>${scope}</td><td>${desc||''}</td></tr>`;

  const inCsv = new Set(CURRENT_HEADERS);

  let rows = '';
  rows += mk('必填', m.id, '共通', '客戶 ID', inCsv.has(m.id));
  rows += mk('必填', m.name, '共通', '客戶名稱', inCsv.has(m.name));
  rows += mk('建議', m.entity, '共通', '客群型別（natural / corp）', inCsv.has(m.entity));
  rows += mk('共通', m.blacklist, '共通', '合規黑名單(1/0 或 true/false)', inCsv.has(m.blacklist));

  if(ordNat.length){
    rows += `<tr><td>—</td><td colspan="3"><b>自然人（依 EDW 順序）</b></td></tr>`;
    ordNat.forEach(f=>rows += mk('自然人', f, '自然人', '', inCsv.has(f)));
  }
  if(ordCorp.length){
    rows += `<tr><td>—</td><td colspan="3"><b>法人（依 EDW 順序）</b></td></tr>`;
    ordCorp.forEach(f=>rows += mk('法人', f, '法人', '', inCsv.has(f)));
  }

  const keyR = (RULES?.mapping?.score?.R) || 'R';
  const keyA = (RULES?.mapping?.score?.A) || 'A';
  rows += mk('ETL評分', keyR, '共通', '推薦分數（0-100）', inCsv.has(keyR));
  rows += mk('ETL評分', keyA, '共通', '關注分數（0-100）', inCsv.has(keyA));
  rows += mk('ETL選填', 'cell', '共通', '若未提供則由 R/A 與 cut 決定', inCsv.has('cell'));

  box.innerHTML = `<table class="tbl">
    <thead><tr><th>必要/對象</th><th>欄位名（CSV 表頭）</th><th>適用</th><th>說明</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
}

// 每次載入 CSV 後做一次表頭對齊檢查，若 R/A 找不到會直接提示
function headerCheck(){
  const ra = pickRA(dataRows[0]||{});
  if(!ra){
    warn('目前 CSV 未找到 R/A 欄位（請在 JSON 的 mapping.score 指定，或 CSV 內使用「加權推薦分數 / 加權關注分數」或 R/A 欄名）。');
  }else{
    clearWarn();
  }
  // 動態刷新欄位說明
  buildFieldGuide();
}

/* -----------------------------------------------
   7) Page 切換與派送
   ----------------------------------------------- */
function showPage(id){
  ['page1','page2'].forEach(pid=>{
    const sec = el('#'+pid);
    if(!sec) return;
    if(pid===id) sec.classList.remove('hidden'); else sec.classList.add('hidden');
  });
}
el('#btnGoDispatch').onclick=()=>{ showPage('page2'); renderDispatch(); };
el('#btnTableau').onclick=()=>alert('此按鈕僅示意：可連到內部 Tableau 儀表板。');

el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();

const DISPATCH_KEY='ait3_dispatch_v2';
function loadDispatchState(){ try{ return JSON.parse(localStorage.getItem(DISPATCH_KEY)||'{}'); }catch(_){ return {}; } }
function saveDispatchState(state){ localStorage.setItem(DISPATCH_KEY, JSON.stringify(state)); }
function getAssignable(){
  const allow = new Set(['HL','HM','HH','MH']); // A1/A2/B1/B2
  return enriched.filter(r=>!r.excluded && r.cell && allow.has(r.cell));
}
function renderDispatch(){
  const state = loadDispatchState();
  const q = (el('#dispatchSearch')?.value||'').trim().toLowerCase();
  const core = resolveCore();

  const rows = getAssignable().filter(r=>{
    if(!q) return true;
    const region = String(r['區域']||r['區域名稱']||'').toLowerCase();
    const branch = String(r['歸屬分行']||r['分行名稱']||'').toLowerCase();
    const id = String(r[core.id]||'').toLowerCase();
    const nm = String(r[core.name]||'').toLowerCase();
    const rm = String(state[id]?.rm||'').toLowerCase();
    return [region,branch,id,nm,rm].some(x=>x.includes(q));
  });

  const tbl = el('#dispatchTbl');
  const LAB = RULES?.labels;
  const head = `
    <thead><tr>
      <th><input type="checkbox" id="chkAll" /></th>
      <th>ID</th><th>名稱</th><th>象限</th>
      <th>區域</th><th>分行</th>
      <th>推薦R</th><th>關注A</th><th>模擬貢獻</th>
      <th>RM 指派</th><th>狀態</th><th>備註</th><th>操作</th>
    </tr></thead>`;
  const body = document.createElement('tbody');

  for(const r of rows){
    const id = r[core.id];
    const code = LAB ? (LAB[r.cell]?.code||r.cell) : (CELL_CODE[r.cell]||r.cell);
    const title = LAB ? (LAB[r.cell]?.title||'') : '';
    const st = state[id]||{};
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-id="${id}"></td>
      <td>${id}</td>
      <td>${r[core.name]||''}</td>
      <td><span class="tag">${code}</span> <span class="mini muted2">${title}</span></td>
      <td>${r['區域']||r['區域名稱']||''}</td>
      <td>${r['歸屬分行']||r['分行名稱']||''}</td>
      <td>${isNum(r.R)?(r.R+'%'):''}</td>
      <td>${isNum(r.A)?(r.A+'%'):''}</td>
      <td></td>
      <td><input class="rm-input" placeholder="輸入 RM 名稱" value="${st.rm||''}" data-id="${id}"></td>
      <td>
        <select class="btn mini status" data-id="${id}">
          <option value="">未處理</option>
          <option ${st.status==='追蹤'?'selected':''}>追蹤</option>
          <option ${st.status==='成功'?'selected':''}>成功</option>
          <option ${st.status==='失敗'?'selected':''}>失敗</option>
        </select>
        <div class="mini muted2">${st.when?('更新：'+new Date(st.when).toLocaleString('zh-TW')):''}</div>
      </td>
      <td><textarea class="noteedit" data-id="${id}" placeholder="補充說明…">${st.note||''}</textarea></td>
      <td><button class="btn mini ghost one-assign" data-id="${id}">指派</button></td>`;
    body.appendChild(tr);
  }
  tbl.innerHTML = head;
  tbl.appendChild(body);

  const chkAll = el('#chkAll');
  if(chkAll) chkAll.onchange = ()=>{ [...tbl.querySelectorAll('.rowchk')].forEach(c=>c.checked=chkAll.checked); };

  tbl.querySelectorAll('.one-assign').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.id;
      const rowEl = btn.closest('tr');
      const rm = rowEl.querySelector('.rm-input').value.trim();
      const status = rowEl.querySelector('.status').value;
      const note = rowEl.querySelector('.noteedit').value.trim();
      const s = loadDispatchState();
      s[id] = { rm, status, note, when: Date.now() };
      saveDispatchState(s);
      renderDispatch();
    };
  });
  tbl.querySelectorAll('.rm-input').forEach(inp=>{
    inp.oninput = ()=>{ const s=loadDispatchState(); const id=inp.dataset.id; s[id]={...(s[id]||{}), rm:inp.value, when:Date.now()}; saveDispatchState(s); };
  });
  tbl.querySelectorAll('.status').forEach(sel=>{
    sel.onchange = ()=>{ const s=loadDispatchState(); const id=sel.dataset.id; s[id]={...(s[id]||{}), status:sel.value, when:Date.now()}; saveDispatchState(s); renderDispatch(); };
  });
  tbl.querySelectorAll('.noteedit').forEach(ta=>{
    ta.oninput = ()=>{ const s=loadDispatchState(); const id=ta.dataset.id; s[id]={...(s[id]||{}), note:ta.value, when:Date.now()}; saveDispatchState(s); };
  });
}
function clearRMFilters(){ el('#dispatchSearch').value=''; renderDispatch(); }
function batchAssign(){
  const tbl = el('#dispatchTbl');
  const ids = [...tbl.querySelectorAll('.rowchk:checked')].map(x=>x.dataset.id);
  if(!ids.length){ alert('請先勾選名單'); return; }
  const rm = prompt('輸入要指派/改派的 RM 名稱：','');
  if(rm==null) return;
  const state = loadDispatchState();
  ids.forEach(id=>{
    const tr = tbl.querySelector(`.rowchk[data-id="${id}"]`)?.closest('tr');
    const note = tr?.querySelector('.noteedit')?.value?.trim()||'';
    const status = tr?.querySelector('.status')?.value||'追蹤';
    state[id] = { rm, status, note, when: Date.now() };
  });
  saveDispatchState(state);
  renderDispatch();
}

/* -----------------------------------------------
   8) 初始化 & 事件
   ----------------------------------------------- */
document.getElementById('guideDetails').addEventListener('toggle', e=>{
  if(e.target.open) buildFieldGuide();
});

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadRules();     // 成功→用 JSON；失敗→骨架模式，但一樣可操作
  render();              // 先畫九宮格（即使無資料）
  buildFieldGuide();     // 先畫一次欄位說明（可再展開刷新）
});
</script>
</body>
</html>
