<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI æ½›åŠ›å®¢æ™ºé¸å°èˆªï½œæ±ºç­–çŸ©é™£ (JSON é©…å‹•ç‰ˆ)</title>
<style>
  :root{
    --bg:#0b1020;--panel:#11162a;--muted:#7a89a8;--text:#f2f5ff;--brand:#66e0ff;--chip:#233055;--grid-border:#2a355c;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e 40%,#0b0f1c);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .hero{display:flex;gap:20px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;background:var(--chip);color:#66e0ff;padding:6px 10px;border-radius:999px;border:1px solid #1d2a4d}
  h1{font-size:28px;margin:2px 0 6px}
  p.muted{color:var(--muted);margin:0}
  .panel{background:#11162a;border:1px solid #1b2340;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#1a2347;color:#e9efff;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  input[type=file]{display:none}
  label.file{display:inline-flex;gap:10px;align-items:center;background:#132142;border:1px dashed #2a3b6a;padding:12px 14px;border-radius:12px;cursor:pointer}
  .kv{display:flex;gap:10px;align-items:center}
  .kv .k{color:#98a8c6}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .notice{background:#0f1430;border:1px solid #22306b;padding:10px 12px;border-radius:10px}
  .err{background:#2b0f14;border:1px solid #7a2633;color:#ffd8df;padding:10px 12px;border-radius:10px;margin:10px 0}
  footer{opacity:.7;margin:24px 0 40px}

  /* ======= çŸ©é™£ï¼ˆå·¦ï¼šæ¨è–¦ï¼›ä¸Šï¼šé—œæ³¨ï¼‰ ======= */
  :root{ --side-w:56px;--head-h:56px; --col-w-L:1fr;--col-w-M:1fr;--col-w-H:1fr; --row-h-H:112px;--row-h-M:112px;--row-h-L:112px; }
  .matrix-wrapper{
    display:grid;
    grid-template-columns: var(--side-w) var(--col-w-L) var(--col-w-M) var(--col-w-H);
    grid-template-rows: var(--head-h) var(--row-h-H) var(--row-h-M) var(--row-h-L);
    border:1px solid var(--grid-border);border-radius:12px;overflow:hidden;background:#fff;
  }
  .matrix-header,.matrix-side{
    display:flex;align-items:center;justify-content:center;background:#f5f7fa;color:#000;font-weight:700;
    border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);
  }
  .cell{border-right:1px solid var(--grid-border);border-bottom:1px solid var(--grid-border);padding:10px;background:#fff;}
  .cell h4{margin:0 0 6px;font-size:14px;color:#000}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:2px 8px;font-weight:600;background:#000;color:#fff;border:1px solid #000}
  .num{font-size:22px;font-weight:700;color:#000}
  /* é¡è‰²ï¼ˆå…©ä¸»è‰² + æ·¡åº•ï¼‰ */
  .tone-imm { background:#fbc37a; } /* ç«‹å³æ¥è§¸ï¼ˆç¬¬2/3ç´šï¼‰ */
  .tone-nor { background:#f7a45a; } /* ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰ */
  .tone-warm { background:#fff1c7; } /* å…¶å®ƒæ·¡åº• */

  /* Z åˆè¦æ’é™¤åˆ— */
  .zbar{margin-top:8px;background:#f5f7fa;color:#000;border:1px solid var(--grid-border);border-radius:8px;padding:10px;text-align:center;font-weight:700;cursor:pointer;}

  /* è¡¨æ ¼ï¼ˆsticky è¡¨é ­ï¼‰ */
  .tbl{width:100%;border-collapse:collapse;margin-top:10px;border-radius:12px;overflow:hidden}
  .tbl thead th{
    background:#0f1733;color:#a9b9db;position:sticky;top:0;z-index:3;
    box-shadow:0 2px 0 rgba(0,0,0,.25);
  }
  .tbl th,.tbl td{border-bottom:1px solid #233055;padding:8px 10px;text-align:left;white-space:nowrap}

  /* è¦å‰‡æª¢æ ¸é¢æ¿ */
  #diagBox .kvline{display:flex;gap:10px;flex-wrap:wrap}
  #diagBox code{background:#0b1639;border:1px solid #243469;padding:2px 6px;border-radius:6px}

  /* ç¯©é¸ chips */
  #filters{display:flex;flex-direction:column;gap:8px}
  .chiprow{display:flex;flex-wrap:wrap;gap:8px}
  #filters .chip{background:#12224b;border:1px solid #2a3b6a;color:#e9efff;border-radius:999px;padding:8px 12px;cursor:pointer}
  #filters .chip:hover{filter:brightness(1.08)}
  #filters .chip.active{outline:2px solid var(--brand)}

  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <span class="badge">JSON é©…å‹•</span>
      <div>
        <h1>é–‹ç™¼æ½›åŠ›åå–®æ±ºç­–çŸ©é™£ï¼ˆä»¥ JSON ç‚ºä¸»ï¼‰</h1>
        <p class="muted">å‰ç«¯ä¸è¨ˆåˆ†ï¼Œåªè®€å– <b>CSV çš„ R/A</b> èˆ‡ <b>JSON çš„åˆ‡é»èˆ‡æ¨™ç±¤</b> ä¾†åˆ†ç¾¤ã€‚</p>
      </div>
    </div>

    <div id="errBox"></div>
    <div id="diagBox"></div>

    <div class="panel" id="uploader">
      <div class="row">
        <label class="file" for="csvFile">ğŸ“„ åŒ¯å…¥ CSVï¼ˆUTF-8ï¼‰</label>
        <input id="csvFile" type="file" accept=".csv" />
        <button class="btn" id="btnClear">æ¸…ç©º</button>
        <div class="right kv"><span class="k">æœ‰æ•ˆç­†æ•¸ï¼ˆå·²åˆ†ç¾¤ï¼Œä¸å« Zï¼‰ï¼š</span><b id="statRows">0</b></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="notice"><b>CSV æœ€å°æ¬„ä½ï¼š</b>å®¢æˆ¶ä»£è™Ÿ / è‡ªç„¶äººæˆ–æ³•äºº / åˆè¦é»‘åå–® / R / Aã€‚æ¬„ä½åç¨±å¯ç”¨ JSON çš„ <code>mapping</code> èª¿æ•´ã€‚</div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:16px">
      <div class="panel">
        <div class="row"><h3 style="margin:0">ä¹å®®æ ¼æ±ºç­–æ‘˜è¦</h3><button class="btn right" id="btnDownload">åŒ¯å‡ºçµæœ CSV</button></div>

        <div class="matrix-wrapper">
          <div class="matrix-header"></div>
          <div class="matrix-header" id="ahL">é—œæ³¨ä½</div>
          <div class="matrix-header" id="ahM">é—œæ³¨ä¸­</div>
          <div class="matrix-header" id="ahH">é—œæ³¨é«˜</div>

          <div class="matrix-side" id="rhH">æ¨è–¦é«˜</div>
          <div class="cell" id="cell-HL"></div>
          <div class="cell" id="cell-HM"></div>
          <div class="cell" id="cell-HH"></div>

          <div class="matrix-side" id="rhM">æ¨è–¦ä¸­</div>
          <div class="cell" id="cell-ML"></div>
          <div class="cell" id="cell-MM"></div>
          <div class="cell" id="cell-MH"></div>

          <div class="matrix-side" id="rhL">æ¨è–¦ä½</div>
          <div class="cell" id="cell-LL"></div>
          <div class="cell" id="cell-LM"></div>
          <div class="cell" id="cell-LH"></div>
        </div>

        <div class="zbar" id="zBar"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px">ç¯©é¸</h3>
        <div id="filters"></div>
        <div class="row" style="margin-top:10px">
          <label class="kv"><span class="k">å®¢ç¾¤é¡å‹ï¼š</span>
            <select id="selEntity" class="btn">
              <option value="auto">è‡ªå‹•ï¼ˆä¾æ¬„ä½æ¨æ–·ï¼‰</option>
              <option value="natural">è‡ªç„¶äºº</option>
              <option value="corp">æ³•äºº</option>
            </select>
          </label>
          <label class="kv"><span class="k">é¡¯ç¤ºç­†æ•¸ï¼š</span>
            <select id="selPage" class="btn">
              <option>50</option><option>100</option><option>200</option><option>å…¨éƒ¨</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px">è¨ˆç®—çµæœ</h3>
      <div style="max-height:360px;overflow:auto;position:relative">
        <table class="tbl" id="resultTbl"></table>
      </div>
    </div>

    <footer>Â© 2025 AIT3 Demo â€¢ Client-Only â€¢ è¦å‰‡èˆ‡åˆ‡é» 100% ç”± JSON æ±ºå®š</footer>
  </div>

<script>
/* ========= 1) JSON è¦å‰‡ä¾†æºï¼ˆä¾åºå˜—è©¦ï¼‰ =========
 * ç¬¬ä¸€å€‹æ˜¯åŒå€‰åº«æª”æ¡ˆï¼Œç¬¬äºŒå€‹è«‹æ”¹æˆä½ çš„ rules repo raw URL æˆ– GitHub Pages URL
 * ä¾‹ï¼š'https://raw.githubusercontent.com/<å¸³è™Ÿ>/ait3-rules/main/rules.latest.json'
 */
const RULES_SOURCES = [
  './rules.latest.json', // åŒå€‰åº«å‚™æ´ï¼Œå¯ç•™è‘—
  'https://raw.githubusercontent.com/pureplume/ait3-rules/main/rules.latest.json' // â† ç”¨é€™å€‹
];

/* ========= 2) å…¨åŸŸç‹€æ…‹ ========= */
let RULES = null;               // { cut, labels, mapping, edw_order }
let RULES_URL_INUSE = null;
let CURRENT_HEADERS = [];
let dataRows = [], enriched = [], viewFilter = 'ALL';

/* ========= 3) å°å·¥å…· ========= */
const el = s => document.querySelector(s);
const fmt = n => (typeof n==='number' && Number.isFinite(n))? n.toLocaleString('zh-TW') : (n??'');
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const isNum = v => typeof v==='number' && Number.isFinite(v);
const asNum = v => {
  if(v===''||v==null) return NaN;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/[,\s]/g,''));
};
const normHeader = h => String(h||'').replace(/^\uFEFF/,'').replace(/\r?\n/g,'').trim();
function warn(msg){ el('#errBox').innerHTML = '<div class="err">âš ï¸ '+ msg +'</div>'; }
function clearWarn(){ el('#errBox').innerHTML = ''; }

/* ========= 4) è¼‰å…¥ JSON è¦å‰‡ï¼ˆå¯å®¹å¿è¨»è§£ã€å¯å°‹æ‰¾å…§å±¤ç¯€é»ï¼‰ ========= */
async function loadRules(){
  let lastErr = '';
  for (const url of RULES_SOURCES){
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) { lastErr = `HTTP ${res.status}`; continue; }
      const text = await res.text();
      // ç§»é™¤ JS/JSON è¨»è§£
      const jsonText = text.replace(/\/\*[\s\S]*?\*\//g,'').replace(/(^|\s)\/\/.*$/gm,'');
      const raw = JSON.parse(jsonText);
      // åœ¨æ ¹æˆ–å…§å±¤å°‹æ‰¾ cut/labels/mapping
      function findNode(obj){
        if(!obj || typeof obj!=='object') return null;
        if(obj.cut && obj.labels && obj.mapping) return obj;
        if(obj.matrix && obj.matrix.cut && obj.matrix.labels) {
          // æ”¯æ´èˆŠç‰ˆï¼šmatrix.cut / matrix.labelsï¼›mapping å¯èƒ½åœ¨ edw_common
          const mapping = obj.mapping || obj.edw_common || obj.edw || null;
          return { cut: obj.matrix.cut, labels: obj.matrix.labels, mapping: mapping||{}, edw_order: obj.edw_order||{} };
        }
        for(const k of Object.keys(obj)){
          const v = obj[k];
          if(v && typeof v==='object'){
            const n = findNode(v);
            if(n) return n;
          }
        }
        return null;
      }
      const node = findNode(raw);
      if(!node){ lastErr = 'æœªæ‰¾åˆ° cut/labels/mapping ç¯€é»'; continue; }
      // è¦ç¯„åŒ–
      RULES = {
        cut: node.cut,
        labels: node.labels,
        mapping: node.mapping || {},
        edw_order: node.edw_order || {natural:[], corp:[]}
      };
      RULES_URL_INUSE = url;
      clearWarn();
      return;
    }catch(e){ lastErr = e.message; continue; }
  }
  RULES = null;
  warn('è¦å‰‡è¼‰å…¥å¤±æ•—ï¼š'+ lastErr +'ã€‚ä¾†æºå·²å…¨éƒ¨å˜—è©¦ï¼š\n'+ RULES_SOURCES.join('\n'));
}

/* ========= 5) CSV è§£æ ========= */
function csvParse(text){
  const rows=[]; let i=0,field='',row=[],q=false;
  const push=()=>{row.push(field);field=''}; const pushRow=()=>{rows.push(row);row=[]};
  while(i<text.length){
    const c=text[i++];
    if(q){ if(c=='"'){ if(text[i]=='"'){field+='"';i++;}else q=false; } else field+=c; continue; }
    if(c=='"'){ q=true; continue; }
    if(c===','){ push(); continue; }
    if(c==='\n'){ push(); pushRow(); continue; }
    if(c==='\r'){ continue; }
    field+=c;
  }
  push(); if(row.length) pushRow();
  const hdr=rows.shift(); if(!hdr) return [];
  const headers=hdr.map(normHeader);
  CURRENT_HEADERS = headers;
  return rows.filter(r=>r.some(x=>x!=='')).
         map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??''])));
}

/* ========= 6) æ¬„ä½å°æ‡‰èˆ‡ Z / R / A è®€å– ========= */
function kNorm(s){
  return String(s||'').toLowerCase()
    .replace(/\uFEFF/g,'').replace(/\r?\n/g,'')
    .replace(/[\s_()ï¼ˆï¼‰\-]/g,'').replace(/[\/\\]/g,'/').trim();
}
function resolveCore(){
  if(RULES?.mapping?.core) return RULES.mapping.core;
  const hset = new Map(CURRENT_HEADERS.map(h=>[kNorm(h),h]));
  const pick = (...cands)=>{ for(const c of cands){ const k=hset.get(kNorm(c)); if(k) return k; } return cands[0]; };
  return {
    id: pick('å®¢æˆ¶ä»£è™Ÿ','å®¢æˆ¶id','id','å®¢ç·¨'),
    name: pick('å®¢æˆ¶åç¨±','åç¨±','name'),
    entity: pick('è‡ªç„¶äºº/éè‡ªç„¶äºº','å®¢ç¾¤','entity'),
    blacklist: pick('åˆè¦é»‘åå–®','é»‘åå–®','ä¸é…åˆç›¡è·å¯©æŸ¥','ä¸é…åˆ\nç›¡è·å¯©æŸ¥','blacklist')
  };
}
function isExcluded(rec){
  const core = resolveCore();
  const v = String(rec[core.blacklist]||'').trim();
  return /^(1|true|y|æ˜¯)$/i.test(v);
}
function inferEntity(rec){
  const core = resolveCore();
  const v = (rec[core.entity]??'').toString();
  const alias = {'è‡ªç„¶äºº':'natural','å€‹äºº':'natural','æ³•äºº':'corp','å…¬å¸':'corp'};
  const e = alias[v] || v.toLowerCase();
  if(e==='natural'||e==='corp') return e;
  // ç›²æ¨ï¼ˆè‹¥æ²’æœ‰æ¬„ä½ï¼‰
  const hintKeys = ['å…¬å¸ç‡Ÿæ”¶','æˆç«‹å¹´é™','ç­–ç•¥æ€§ç”¢æ¥­åˆ¥(ETL)','å®¢æˆ¶ç­‰ç´š/æˆä¿¡ç­‰ç´š','å®¢æˆ¶å¾€ä¾†æ¥­å‹™é¡åˆ¥'];
  return hintKeys.some(k=>k in rec)? 'corp':'natural';
}
function pickRA(rec){
  const mapScore = RULES?.mapping?.score || {};
  const keyR = mapScore.R || null;
  const keyA = mapScore.A || null;
  const keys = Object.keys(rec);
  const idx = new Map(keys.map(k=>[kNorm(k),k]));
  const tryFind = (given, fallbacks)=>{
    if(given && (given in rec)) return given;
    if(given && idx.has(kNorm(given))) return idx.get(kNorm(given));
    for(const fb of fallbacks){
      if(fb in rec) return fb;
      const k = idx.get(kNorm(fb));
      if(k) return k;
    }
    return null;
  };
  const rKey = tryFind(keyR, ['R','æ¨è–¦R','åŠ æ¬Šæ¨è–¦åˆ†æ•¸','Råˆ†æ•¸']);
  const aKey = tryFind(keyA, ['A','é—œæ³¨A','åŠ æ¬Šé—œæ³¨åˆ†æ•¸','Aåˆ†æ•¸']);
  if(!rKey || !aKey) return null;
  const R = asNum(rec[rKey]), A = asNum(rec[aKey]);
  if(!isNum(R) || !isNum(A)) return null;
  return {R: clamp(R,0,100), A: clamp(A,0,100)};
}

/* ========= 7) åˆ†ç¾¤ï¼ˆåªç”¨ JSON åˆ‡é»ï¼Œä¸å…§å»ºè¨ˆåˆ†ï¼‰ ========= */
function decideCell(R,A){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  const rc = R>=c.R.hi? 'H' : R>=c.R.mid? 'M' : 'L';
  const ac = A>=c.A.hi? 'H' : A>=c.A.mid? 'M' : 'L';
  return rc+ac;
}
const UI_TITLES = {
  HL:'ç«‹å³æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰', HM:'ç«‹å³æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰', HH:'ç«‹å³æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  ML:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',  MM:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',  MH:'ä¸€èˆ¬æ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  LL:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬3ç´šï¼‰',  LM:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬2ç´šï¼‰',  LH:'å¾ŒçºŒæ¥è§¸ï¼ˆç¬¬1ç´šï¼‰',
  Z :'åˆè¦æ’é™¤'
};
const CELL_TONE = { HL:'tone-imm', HM:'tone-imm', HH:'tone-imm', ML:'tone-warm', MM:'tone-warm', MH:'tone-nor', LL:'tone-warm', LM:'tone-warm', LH:'tone-warm' };
function getTitle(key){ return RULES?.labels?.[key]?.title || UI_TITLES[key] || ''; }

/* ========= 8) ä¸»æµç¨‹ ========= */
function process(){
  const forced = el('#selEntity').value;
  const core = resolveCore();
  enriched = dataRows.map(rec=>{
    const entity = (forced==='auto')? inferEntity(rec) : forced;
    const excluded = isExcluded(rec);
    const ra = pickRA(rec);
    const R = ra? ra.R : null;
    const A = ra? ra.A : null;
    const cell = (excluded || !ra)? null : decideCell(R, A);
    return { ...rec, entity, excluded, R, A, cell };
  });
  render();
}
function groupBy(arr, key){ const m={}; for(const x of arr){ const k=typeof key==='function'? key(x): x[key]; (m[k]||(m[k]=[])).push(x);} return m; }

/* ========= 9) UI æ¸²æŸ“ ========= */
function applyHeadersFromCuts(){
  const c=(RULES&&RULES.cut)||{R:{hi:70,mid:40},A:{hi:70,mid:40}};
  el('#ahL').textContent = `é—œæ³¨ä½ (<${c.A.mid})`;
  el('#ahM').textContent = `é—œæ³¨ä¸­ (${c.A.mid}â€“${c.A.hi-1})`;
  el('#ahH').textContent = `é—œæ³¨é«˜ (â‰¥${c.A.hi})`;
  el('#rhH').textContent = `æ¨è–¦é«˜ (â‰¥${c.R.hi})`;
  el('#rhM').textContent = `æ¨è–¦ä¸­ (${c.R.mid}â€“${c.R.hi-1})`;
  el('#rhL').textContent = `æ¨è–¦ä½ (<${c.R.mid})`;
}
function render(){
  applyHeadersFromCuts();
  const byCell = groupBy(enriched.filter(r=>!r.excluded && r.cell), r=>r.cell);
  const order=['HL','HM','HH','ML','MM','MH','LL','LM','LH'];
  for(const key of order){
    const title = getTitle(key);
    const count=(byCell[key]||[]).length;
    const box=el('#cell-'+key);
    if(!box) continue;
    box.className=`cell ${CELL_TONE[key]||'tone-warm'}`;
    box.innerHTML=`<h4>${title}</h4><div class="row"><span class="pill">ç­†æ•¸</span> <span class="num">${fmt(count)}</span></div>`;
    box.onclick=()=>{ viewFilter=key; renderTable(); highlightFilter(); };
  }
  const zCount = enriched.filter(r=>r.excluded).length;
  const zbar = el('#zBar');
  if(zbar){
    zbar.innerHTML = `Zï½œ${getTitle('Z')}ã€€â€¢ã€€ç­†æ•¸ <span class="num">${fmt(zCount)}</span>`;
    zbar.onclick = ()=>{ viewFilter='Z'; renderTable(); highlightFilter(); };
  }
  renderFilterChips();
  highlightFilter();
  renderTable();
  renderDiagnostics();
}
function renderFilterChips(){
  const cont = el('#filters'); cont.innerHTML = '';
  const mk = (text, val) => { const b=document.createElement('button'); b.className='chip'; b.textContent=text; b.onclick=()=>{viewFilter=val; renderTable(); highlightFilter();}; return b; };
  const rowTop = document.createElement('div'); rowTop.className='chiprow';
  rowTop.appendChild(mk('é¡¯ç¤ºå…¨éƒ¨','ALL'));
  ['HL','HM','HH'].forEach(k=>rowTop.appendChild(mk(getTitle(k),k)));
  const rowMid = document.createElement('div'); rowMid.className='chiprow';
  ['ML','MM','MH'].forEach(k=>rowMid.appendChild(mk(getTitle(k),k)));
  const rowLow = document.createElement('div'); rowLow.className='chiprow';
  ['LL','LM','LH'].forEach(k=>rowLow.appendChild(mk(getTitle(k),k)));
  rowLow.appendChild(mk('åˆè¦æ’é™¤','Z'));
  cont.appendChild(rowTop); cont.appendChild(rowMid); cont.appendChild(rowLow);
}
function highlightFilter(){
  [...document.querySelectorAll('#filters .chip')].forEach(b=>{
    const val = b.textContent==='é¡¯ç¤ºå…¨éƒ¨'?'ALL': (b.textContent==='åˆè¦æ’é™¤'?'Z':null);
    const mapped = val || Object.entries(UI_TITLES).find(([k,v])=>v===b.textContent)?.[0];
    b.classList.toggle('active', mapped===viewFilter);
  });
}
function renderTable(){
  const tbl=el('#resultTbl');
  const headers=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R(æ¨è–¦)','A(é—œæ³¨)','è±¡é™'];
  let rows;
  if(viewFilter==='Z') rows = enriched.filter(r=>r.excluded);
  else if(viewFilter==='ALL') rows = enriched.filter(r=>!r.excluded);
  else rows = enriched.filter(r=>!r.excluded && r.cell===viewFilter);
  const limit=el('#selPage').value==='å…¨éƒ¨'? rows.length : Number(el('#selPage').value);
  tbl.innerHTML='<thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead>';
  const body=document.createElement('tbody');
  const core = resolveCore();
  for(const r of rows.slice(0,limit)){
    const title = r.excluded ? getTitle('Z') : (r.cell? getTitle(r.cell) : 'æœªè©•åˆ†');
    const entityTxt = r.entity==='corp'?'æ³•äºº':'è‡ªç„¶äºº';
    const vals = [
      r[core.id],
      entityTxt,
      isNum(r.R)? r.R+'%' : '',
      isNum(r.A)? r.A+'%' : '',
      r.excluded ? `Zï½œ${getTitle('Z')}` : title
    ];
    const tr=document.createElement('tr');
    tr.innerHTML = vals.map(v=>`<td>${v??''}</td>`).join('');
    body.appendChild(tr);
  }
  tbl.appendChild(body);
  el('#statRows').textContent = fmt(enriched.filter(r=>!r.excluded && r.cell).length);
}

/* ========= 10) è¦å‰‡æª¢æ ¸è³‡è¨Š ========= */
function buildFieldGuide(){
  const box = el('#diagBox'); if(!box) return;
  const core = resolveCore();
  const sample = dataRows[0]||{};
  const find = (want, ...alts)=>{
    const keys = Object.keys(sample);
    const idx = new Map(keys.map(k=>[kNorm(k),k]));
    if(want && (want in sample)) return want;
    if(want && idx.has(kNorm(want))) return idx.get(kNorm(want));
    for(const a of alts){ if(a in sample) return a; const k=idx.get(kNorm(a)); if(k) return k; }
    return 'æœªæ‰¾åˆ°';
  };
  const rKey = find(RULES?.mapping?.score?.R,'R','æ¨è–¦R','åŠ æ¬Šæ¨è–¦åˆ†æ•¸','Råˆ†æ•¸');
  const aKey = find(RULES?.mapping?.score?.A,'A','é—œæ³¨A','åŠ æ¬Šé—œæ³¨åˆ†æ•¸','Aåˆ†æ•¸');
  const total = dataRows.length;
  const z = enriched.filter(x=>x.excluded).length;
  const scored = enriched.filter(x=>x.cell).length;
  const unscored = total - z - scored;
  const hit = name => CURRENT_HEADERS.includes(name) ? 'âœ…' : 'âŒ';
  box.innerHTML = `
    <div class="notice">
      <b>è¦å‰‡æª¢æ ¸</b>
      <div class="kvline">JSON è¦å‰‡ï¼š${RULES?'âœ… å·²è¼‰å…¥':'âŒ å¤±æ•—ï¼ˆä½¿ç”¨éª¨æ¶ï¼‰'}</div>
      <div class="kvline">è¦å‰‡ä¾†æºï¼š<code>${RULES_URL_INUSE || 'ï¼ˆéª¨æ¶æ¨¡å¼ï¼‰'}</code></div>
      <div class="kvline">æ ¸å¿ƒæ¬„ä½ï¼š
        å®¢æˆ¶ä»£è™Ÿ <code>${core.id}</code> ${hit(core.id)} ï¼
        å®¢ç¾¤ <code>${core.entity}</code> ${hit(core.entity)} ï¼
        é»‘åå–® <code>${core.blacklist}</code> ${hit(core.blacklist)}
      </div>
      <div class="kvline">R æ¬„ä½ï¼š<code>${rKey}</code>ï¼›A æ¬„ä½ï¼š<code>${aKey}</code></div>
      <div class="kvline">è¦†è“‹ç‡ï¼šå¯åˆ†ç¾¤ <b>${scored}</b> ï¼ ç¸½ç­†æ•¸ <b>${total}</b>ï¼ˆZ = ${z}ï¼Œæœªè©•åˆ† = ${unscored}ï¼‰</div>
    </div>`;
}

/* ========= 11) åŒ¯å‡º ========= */
function toCSV(arr){
  if(!arr.length) return '';
  const core = resolveCore();
  const cols=['å®¢æˆ¶ä»£è™Ÿ','å®¢ç¾¤','R','A','è±¡é™'];
  const hdr=cols.join(',');
  const lines=arr.filter(r=>!r.excluded && r.cell).map(r=>[
    r[core.id], r.entity, r.R, r.A, getTitle(r.cell)
  ].map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(','));
  return [hdr, ...lines].join('\n');
}
el('#btnDownload').onclick=()=>{
  const csv=toCSV(enriched);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='decision_matrix_result.csv'; a.click();
};

/* ========= 12) äº‹ä»¶ ========= */
async function handleCsvInput(file){
  if(!file) return;
  const text=await file.text();
  dataRows=csvParse(text);
  process();
  buildFieldGuide();
  if(!pickRA(dataRows[0]||{})){ warn('CSV æœªæ‰¾åˆ° R/A æ¬„ä½ï¼ˆè«‹åœ¨ JSON çš„ mapping.score æŒ‡å®šï¼Œæˆ– CSV ä½¿ç”¨ã€ŒR / Aã€æˆ–ã€ŒåŠ æ¬Šæ¨è–¦åˆ†æ•¸ / åŠ æ¬Šé—œæ³¨åˆ†æ•¸ã€æ¬„åï¼‰ã€‚'); }
  else { clearWarn(); }
}
el('#csvFile').addEventListener('change', (e)=>handleCsvInput(e.target.files?.[0]));
el('#btnClear').onclick=()=>{ dataRows=[]; enriched=[]; render(); el('#csvFile').value=''; };
el('#selEntity').onchange=()=>process();
el('#selPage').onchange=()=>renderTable();

/* ========= 13) å•Ÿå‹• ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadRules();
  render();         // æ²’è³‡æ–™æ™‚ä¹Ÿæœƒç•«å‡ºçŸ©é™£èˆ‡æ¨™é¡Œ
  buildFieldGuide();
});
</script>
</body>
</html>
